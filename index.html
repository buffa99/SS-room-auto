<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤éƒ¨å±‹å‰²ã‚¢ãƒ—ãƒª</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel (JSXå¤‰æ›ç”¨) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <style>
    /* ç”»é¢è¡¨ç¤ºç”¨ãƒ»å°åˆ·ç”¨åˆ‡ã‚Šæ›¿ãˆã‚¯ãƒ©ã‚¹ */
    .print-only { display: none; }
    
    @media print {
      .screen-only { display: none !important; }
      .print-only { display: block !important; }
      
      @page {
        size: A3 landscape;
        margin: 10mm;
      }
      body {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        background: white;
        font-size: 10pt !important;
        width: 100% !important;
        min-width: 0 !important;
      }
      
      /* å°åˆ·ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
      .print-page {
        width: 100%;
        page-break-after: auto;
      }
      .page-break-before-always {
        page-break-before: always !important;
        margin-top: 20px;
        display: block !important;
      }
      
      /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãƒªã‚»ãƒƒãƒˆ */
      #root, .min-h-screen, .flex, .flex-col {
        display: block !important;
        height: auto !important;
        overflow: visible !important;
      }

      /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
      table {
        width: 100% !important;
        table-layout: fixed !important;
        border-collapse: collapse !important;
        margin-bottom: 10px !important;
      }
      tr {
        page-break-inside: avoid !important;
      }
      th, td {
        border: 1px solid #444 !important;
        padding: 4px !important;
        font-size: 9pt !important;
        height: 35px !important;
        vertical-align: middle !important;
        word-wrap: break-word;
      }
      th:first-child, td:first-child {
        width: 120px !important;
        font-size: 12pt !important;
        font-weight: bold !important;
        text-align: center;
      }
      th:last-child, td:last-child {
        width: 60px !important;
        text-align: center;
      }
      
      /* ã‚¢ã‚¤ã‚³ãƒ³æ‹¡å¤§ */
      .print-icon {
        font-size: 16pt !important;
        margin-left: 4px;
      }
      
      /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
      .overflow-auto {
        overflow: visible !important;
      }
    }
    
    /* ä»¥ä¸‹ã€æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .dragging {
      opacity: 0.5;
      transform: scale(1.1);
    }
    .drag-over {
      background-color: #fef3c7 !important;
      border: 2px dashed #f59e0b !important;
    }
    /* ç¸¦æ›¸ã */
    .writing-mode-vertical {
      writing-mode: vertical-rl;
      text-orientation: mixed;
    }
    /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å¸¸æ™‚è¡¨ç¤º */
    .scroll-always-visible {
      overflow: scroll !important;
      scrollbar-gutter: stable;
    }
    .scroll-always-visible::-webkit-scrollbar {
      width: 16px !important;
      height: 16px !important;
      display: block !important;
    }
    .scroll-always-visible::-webkit-scrollbar-thumb {
      background: #666 !important;
      border-radius: 8px;
      border: 3px solid #f1f1f1;
      min-height: 40px;
    }
    .scroll-always-visible::-webkit-scrollbar-thumb:hover {
      background: #444 !important;
    }
    .scroll-always-visible::-webkit-scrollbar-track {
      background: #e0e0e0 !important;
    }
    .scroll-always-visible::-webkit-scrollbar-corner {
      background: #e0e0e0 !important;
    }
    /* Firefoxç”¨ */
    @supports (scrollbar-width: auto) {
      .scroll-always-visible {
        scrollbar-width: auto;
        scrollbar-color: #666 #e0e0e0;
      }
    }
    /* åŒæ™‚ç·¨é›†ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .connected-users-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 12px;
      z-index: 9999;
      max-width: 280px;
    }
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }
    .editing-cell {
      outline: 3px solid var(--editor-color, #3b82f6) !important;
      outline-offset: -1px;
    }
    .editor-label {
      position: absolute;
      top: -18px;
      left: 0;
      font-size: 10px;
      padding: 1px 4px;
      border-radius: 3px;
      color: white;
      white-space: nowrap;
      z-index: 100;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ============================================
    // ğŸ“‹ ã‚³ãƒ¼ãƒ‰ç›®æ¬¡
    // ============================================
    // 1. Firebaseè¨­å®šãƒ»ã‚¢ãƒ€ãƒ—ã‚¿ (ç´„196è¡Œç›®ã€œ)
    // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ãƒ»åŸºæœ¬è¨­å®š (ç´„290è¡Œç›®ã€œ)
    // 3. ã‚¢ã‚¤ã‚³ãƒ³ãƒ»UIéƒ¨å“ (ç´„324è¡Œç›®ã€œ)
    // 4. å®šæ•°å®šç¾© (éƒ¨å±‹ãƒ»ç¥æ—¥ãƒ»é£Ÿäº‹ãªã©) (ç´„370è¡Œç›®ã€œ)
    // 5. ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (æ—¥ä»˜ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨ˆç®—) (ç´„496è¡Œç›®ã€œ)
    // 6. ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ (ç´„618è¡Œç›®ã€œ)
    // 7. èªè¨¼ç”»é¢ [LoginScreen] (ç´„639è¡Œç›®ã€œ)
    // 8. ãƒ˜ãƒƒãƒ€ãƒ¼ [Header] (ç´„737è¡Œç›®ã€œ)
    // 9. ã‚µã‚¤ãƒ‰ãƒãƒ¼ [Sidebar] (ç´„895è¡Œç›®ã€œ)
    // 10. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ€ãƒ« [ArchivedUserListModal] (ç´„1089è¡Œç›®ã€œ)
    // 11. ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª [ShortStayAllocator] (ç´„1140è¡Œç›®ã€œ)
    //     - Stateå®šç¾©ãƒ»åˆæœŸåŒ–
    //     - ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ãƒ»èª­ã¿è¾¼ã¿ (ç´„1225è¡Œç›®ã€œ)
    //     - PDFå‡ºåŠ›ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (ç´„1395è¡Œç›®ã€œ)
    //     - ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ©Ÿèƒ½ (ç´„1560è¡Œç›®ã€œ)
    //     - ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç† (ç´„1680è¡Œç›®ã€œ)
    //     - è‡ªå‹•å‰²ã‚ŠæŒ¯ã‚Šãƒ­ã‚¸ãƒƒã‚¯ (ç´„1880è¡Œç›®ã€œ)
    //     - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ç·¨é›† (ç´„2060è¡Œç›®ã€œ)
    //     - å†è¨ˆç®—ãƒ»ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ (ç´„2300è¡Œç›®ã€œ)
    //     - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» (ç´„2540è¡Œç›®ã€œ)
    //     - ç”»é¢ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (ç´„2640è¡Œç›®ã€œ)
    // 12. ãƒ«ãƒ¼ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ [App] (ç´„3615è¡Œç›®ã€œ)
    // ============================================

    // #region 1ï¸âƒ£ Firebaseè¨­å®šãƒ»ã‚¢ãƒ€ãƒ—ã‚¿
    // â‘  ã“ã“ã«ã€Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸ â€œå€¤â€ ã‚’å…¥ã‚Œã‚‹
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyD9wXPT4uQ2SNfVf2lFEjqArBnaEmgslTI",
      authDomain: "ss-room-auto-1f9b3.firebaseapp.com",
      projectId: "ss-room-auto-1f9b3",
      storageBucket: "ss-room-auto-1f9b3.firebasestorage.app",
      messagingSenderId: "264240171286",
      appId: "1:264240171286:web:45c9beba0e241ce064a837"
    };

    // â‘¡ Firestore ã‚’ RTDBã£ã½ãæ‰±ã†ã‚¢ãƒ€ãƒ—ã‚¿ï¼ˆdatabase.ref().set/update/on ã‚’å†ç¾ï¼‰
    function makeFirestoreRtdbAdapter(docRef) {
      const norm = (p) => (p || "").replace(/^\/+|\/+$/g, "");
      const stripDataPrefix = (p) => {
        const s = norm(p);
        if (s === "" || s === "data") return "";
        if (s.startsWith("data/")) return s.slice(5);
        return s; // å¿µã®ãŸã‚
      };
      const toDotPath = (p) => stripDataPrefix(p).split("/").filter(Boolean).join(".");

      // ãƒ‰ãƒƒãƒˆè¨˜æ³•ã§ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å€¤ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
      const getDeepValue = (obj, path) => {
        return path.split('.').reduce((acc, part) => (acc && acc[part] !== undefined) ? acc[part] : undefined, obj);
      };

      class Ref {
        constructor(path) {
          this.path = norm(path);
          this._unsub = null;
        }
        on(event, cb) {
          if (event !== "value") return;
          // ã©ã®ãƒ‘ã‚¹ã§ã‚‚ã€Œå…±æœ‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã€ã‚’ç›£è¦–ï¼ˆã‚ãªãŸã®å®Ÿè£…ã«åˆã†ï¼‰
          this._unsub = docRef.onSnapshot((doc) => {
            const raw = doc.data() || {};
            // åˆæœŸåŒ–ç”¨ã®ã‚´ãƒŸã‚’é¿ã‘ãŸã„å ´åˆ
            const { __init, ...data } = raw;
            cb({ val: () => data });
          });
        }
        off() {
          if (this._unsub) {
            this._unsub();
            this._unsub = null;
          }
        }
        async set(value) {
          const sub = stripDataPrefix(this.path);
          if (!sub) {
            // data å…¨ä½“ã‚’ç½®ãï¼ˆä¸Šæ›¸ãäº‹æ•…ã‚’é¿ã‘ã‚‹ãŸã‚ mergeï¼‰
            return docRef.set(value || {}, { merge: true });
          }
          const dot = toDotPath(this.path);
          // updateã¯docãŒç„¡ã„ã¨è½ã¡ã‚‹ã®ã§ set(merge) ã‚’ä½¿ã†
          return docRef.set({ [dot]: value }, { merge: true });
        }
        async update(updates) {
          // updates: { "data/xxx": value, ... } ã‚’ dot ã«å¤‰æ›ã—ã¦ update
          const out = {};
          for (const [k, v] of Object.entries(updates || {})) {
            const dot = toDotPath(k);
            out[dot] = v;
          }
          return docRef.update(out);
        }
        async remove() {
          const dot = toDotPath(this.path);
          if (!dot) return docRef.delete();
          return docRef.update({ [dot]: firebase.firestore.FieldValue.delete() });
        }
        // æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã® handleRoomDrop ã§ transaction ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ãŸã‚è¿½åŠ 
        transaction(updateFn) {
          const dot = toDotPath(this.path);
          
          // Firestoreã®æ­£è¦ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
          return docRef.firestore.runTransaction(async (t) => {
            const doc = await t.get(docRef);
            const raw = doc.data() || {};
            // ãƒã‚¹ãƒˆã•ã‚ŒãŸå€¤ã‚’å–å¾—ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ null ã¨ã™ã‚‹ â€»RTDBã®æŒ™å‹•ã«åˆã‚ã›ã‚‹ï¼‰
            const current = dot ? (getDeepValue(raw, dot) ?? null) : raw;
            
            const next = updateFn(current);
            
            if (next !== undefined) {
              // dotãŒã‚ã‚‹å ´åˆã¯ updateã€ãƒ«ãƒ¼ãƒˆã®å ´åˆã¯ set(merge)
              t.update(docRef, dot ? { [dot]: next } : next);
            }
            return { committed: true, snapshot: { val: () => next } };
          });
        }
      }

      return {
        ref: (path = "") => new Ref(path),
      };
    }

    // #endregion
    // â‘¢ åˆæœŸåŒ–
    let database = null;
    let isFirebaseEnabled = false;

    // #region 2ï¸âƒ£ ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ãƒ»åŸºæœ¬è¨­å®š
    // ============================================
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ç”¨IDç”Ÿæˆ
    // ============================================
    const generateUserId = () => {
      let userId = localStorage.getItem('shortstay_user_id');
      if (!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('shortstay_user_id', userId);
      }
      return userId;
    };

    const generateUserColor = (userId) => {
      const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];
      let hash = 0;
      for (let i = 0; i < userId.length; i++) {
        hash = userId.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
    };

    const generateUserName = () => {
      const adjectives = ['é’ã„', 'èµ¤ã„', 'ç·‘ã®', 'é»„è‰²ã„', 'ç´«ã®', 'ç™½ã„', 'é»’ã„', 'ã‚ªãƒ¬ãƒ³ã‚¸'];
      const animals = ['ãƒ‘ãƒ³ãƒ€', 'ã‚­ãƒ„ãƒ', 'ã‚¿ãƒŒã‚­', 'ã‚¦ã‚µã‚®', 'ã‚¯ãƒ', 'ãƒã‚³', 'ã‚¤ãƒŒ', 'ãƒˆãƒª'];
      return adjectives[Math.floor(Math.random() * adjectives.length)] + animals[Math.floor(Math.random() * animals.length)];
    };

    const CURRENT_USER_ID = generateUserId();
    const CURRENT_USER_COLOR = generateUserColor(CURRENT_USER_ID);
    const CURRENT_USER_NAME = localStorage.getItem('shortstay_user_name') || generateUserName();
    localStorage.setItem('shortstay_user_name', CURRENT_USER_NAME);

    // ============================================
    // è¨­å®š: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã“ã“ã§å¤‰æ›´å¯èƒ½
    // æœ¬ç•ªç’°å¢ƒã§ã¯Netlify Identityç­‰ã®åˆ©ç”¨ã‚’æ¨å¥¨
    // ============================================
    const APP_CONFIG = {
      // æ–½è¨­å
      facilityName: 'ç‰¹é¤Šã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤',
    };
    // #endregion

    // #region 3ï¸âƒ£ ã‚¢ã‚¤ã‚³ãƒ³ãƒ»UIéƒ¨å“
    // --- ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
    const IconWrapper = ({ children, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
    );
    const User = (props) => <IconWrapper {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></IconWrapper>;
    const Plus = (props) => <IconWrapper {...props}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></IconWrapper>;
    const Trash2 = (props) => <IconWrapper {...props}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></IconWrapper>;
    const Edit = (props) => <IconWrapper {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></IconWrapper>;
    const MapPin = (props) => <IconWrapper {...props}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></IconWrapper>;
    const ChevronLeft = (props) => <IconWrapper {...props}><polyline points="15 18 9 12 15 6" /></IconWrapper>;
    const ChevronRight = (props) => <IconWrapper {...props}><polyline points="9 18 15 12 9 6" /></IconWrapper>;
    const CalendarIcon = (props) => <IconWrapper {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></IconWrapper>;
    const Printer = (props) => <IconWrapper {...props}><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></IconWrapper>;
    const Save = (props) => <IconWrapper {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconWrapper>;
    const LogOut = (props) => <IconWrapper {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></IconWrapper>;
    const Settings = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></IconWrapper>;
    const Download = (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></IconWrapper>;
    const Upload = (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></IconWrapper>;
    const RotateCcw = (props) => <IconWrapper {...props}><polyline points="1 4 1 10 7 10" /><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" /></IconWrapper>;
    const Eye = (props) => <IconWrapper {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" /><circle cx="12" cy="12" r="3" /></IconWrapper>;
    const EyeOff = (props) => <IconWrapper {...props}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" /><line x1="1" y1="1" x2="23" y2="23" /></IconWrapper>;
    const ListIcon = (props) => <IconWrapper {...props}><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></IconWrapper>;

    // ãƒ¡ãƒ¢å…¥åŠ›ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼šonBlurã§ä¿å­˜ï¼‰
    const MemoInput = ({ value, onSave, className, placeholder }) => {
      const [localValue, setLocalValue] = useState(value || '');

      useEffect(() => {
        setLocalValue(value || '');
      }, [value]);

      const handleBlur = () => {
        if (localValue !== (value || '')) {
          onSave(localValue);
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
          e.target.blur();
        }
      };

      return (
        <input
          type="text"
          value={localValue}
          onChange={(e) => setLocalValue(e.target.value)}
          onBlur={handleBlur}
          onKeyDown={handleKeyDown}
          className={className}
          placeholder={placeholder}
        />
      );
    };
    // #endregion

    // #region 4ï¸âƒ£ å®šæ•°å®šç¾©
    // --- è¨­å®šå€¤ ---
    const INITIAL_ROOMS = [
      { id: '201', name: '201', features: ['low_fall_risk'], label: 'è»¢å€’ãƒªã‚¹ã‚¯ä½' },
      { id: '202', name: '202', features: [], label: 'é€šå¸¸' },
      { id: '203', name: '203', features: [], label: 'é€šå¸¸' },
      { id: '204', name: '204', features: ['near_toilet', 'for_high_fall_risk'], label: 'ãƒˆã‚¤ãƒ¬è¿‘ãƒ»è»¢å€’ãƒªã‚¹ã‚¯é«˜' },
      { id: '205', name: '205', features: ['for_oxygen'], label: 'åœ¨å®…é…¸ç´ æ¨å¥¨' },
      { id: '206', name: '206', features: ['low_fall_risk'], label: 'è»¢å€’ãƒªã‚¹ã‚¯ä½' },
      { id: '207', name: '207', features: ['near_toilet'], label: 'ãƒˆã‚¤ãƒ¬è¿‘' },
      { id: '208', name: '208', features: ['near_toilet', 'for_new', 'for_high_fall_risk'], label: 'ãƒˆã‚¤ãƒ¬è¿‘ãƒ»æ–°è¦å‘ãƒ»è»¢å€’ãƒªã‚¹ã‚¯é«˜' },
      { id: '209', name: '209', features: ['for_high_fall_risk'], label: 'è»¢å€’ãƒªã‚¹ã‚¯é«˜' },
      { id: '210', name: '210', features: ['for_oxygen'], label: 'åœ¨å®…é…¸ç´ æ¨å¥¨' },
    ];

    const WEEK_DAYS_JP = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

    // æ—¥æœ¬ã®ç¥æ—¥ï¼ˆ2024-2026å¹´ï¼‰
    const HOLIDAYS_JP = {
      '2024-01-01': 'å…ƒæ—¥', '2024-01-08': 'æˆäººã®æ—¥', '2024-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥', '2024-02-12': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2024-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥', '2024-03-20': 'æ˜¥åˆ†ã®æ—¥', '2024-04-29': 'æ˜­å’Œã®æ—¥', '2024-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
      '2024-05-04': 'ã¿ã©ã‚Šã®æ—¥', '2024-05-05': 'ã“ã©ã‚‚ã®æ—¥', '2024-05-06': 'æŒ¯æ›¿ä¼‘æ—¥', '2024-07-15': 'æµ·ã®æ—¥',
      '2024-08-11': 'å±±ã®æ—¥', '2024-08-12': 'æŒ¯æ›¿ä¼‘æ—¥', '2024-09-16': 'æ•¬è€ã®æ—¥', '2024-09-22': 'ç§‹åˆ†ã®æ—¥',
      '2024-09-23': 'æŒ¯æ›¿ä¼‘æ—¥', '2024-10-14': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥', '2024-11-03': 'æ–‡åŒ–ã®æ—¥', '2024-11-04': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2024-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥', '2025-01-01': 'å…ƒæ—¥', '2025-01-13': 'æˆäººã®æ—¥', '2025-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
      '2025-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥', '2025-02-24': 'æŒ¯æ›¿ä¼‘æ—¥', '2025-03-20': 'æ˜¥åˆ†ã®æ—¥', '2025-04-29': 'æ˜­å’Œã®æ—¥',
      '2025-05-03': 'æ†²æ³•è¨˜å¿µæ—¥', '2025-05-04': 'ã¿ã©ã‚Šã®æ—¥', '2025-05-05': 'ã“ã©ã‚‚ã®æ—¥', '2025-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2025-07-21': 'æµ·ã®æ—¥', '2025-08-11': 'å±±ã®æ—¥', '2025-09-15': 'æ•¬è€ã®æ—¥', '2025-09-23': 'ç§‹åˆ†ã®æ—¥',
      '2025-10-13': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥', '2025-11-03': 'æ–‡åŒ–ã®æ—¥', '2025-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥', '2025-11-24': 'æŒ¯æ›¿ä¼‘æ—¥',
      '2026-01-01': 'å…ƒæ—¥', '2026-01-12': 'æˆäººã®æ—¥', '2026-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥', '2026-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
      '2026-03-20': 'æ˜¥åˆ†ã®æ—¥', '2026-04-29': 'æ˜­å’Œã®æ—¥', '2026-05-03': 'æ†²æ³•è¨˜å¿µæ—¥', '2026-05-04': 'ã¿ã©ã‚Šã®æ—¥',
      '2026-05-05': 'ã“ã©ã‚‚ã®æ—¥', '2026-05-06': 'æŒ¯æ›¿ä¼‘æ—¥', '2026-07-20': 'æµ·ã®æ—¥', '2026-08-11': 'å±±ã®æ—¥',
      '2026-09-21': 'æ•¬è€ã®æ—¥', '2026-09-22': 'å›½æ°‘ã®ä¼‘æ—¥', '2026-09-23': 'ç§‹åˆ†ã®æ—¥', '2026-10-12': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
      '2026-11-03': 'æ–‡åŒ–ã®æ—¥', '2026-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
    };

    // å…¥æµ´æ–¹æ³•
    const BATH_TYPES = [
      { key: 'individual', label: 'å€‹æµ´' },
      { key: 'lift', label: 'ãƒªãƒ•ãƒˆæµ´' },
      { key: 'intermediate', label: 'ä¸­é–“æµ´' },
      { key: 'bed', label: 'è‡¥åºŠæµ´' },
    ];

    // ========== é£Ÿäº‹ä¼ç¥¨é–¢é€£ã®å®šæ•° ==========
    // é£Ÿç¨®
    const MEAL_FOOD_TYPES = [
      { key: 'general_1200', label: 'ä¸€èˆ¬é£Ÿ(1200Kcal)' },
      { key: 'general_1400', label: 'ä¸€èˆ¬é£Ÿ(1400Kcal)' },
      { key: 'general_1600', label: 'ä¸€èˆ¬é£Ÿ(1600Kcal)' },
      { key: 'diabetes', label: 'ç³–å°¿ç—…é£Ÿ' },
      { key: 'anemia', label: 'è²§è¡€é£Ÿ' },
      { key: 'liver', label: 'è‚è‡“é£Ÿ' },
      { key: 'dyslipidemia', label: 'è„‚è³ªç•°å¸¸é£Ÿ' },
      { key: 'kidney', label: 'è…è‡“é£Ÿ' },
      { key: 'cardiac', label: 'å¿ƒè‡“ç—…é£Ÿ(å¡©åˆ†6gæœªæº€)' },
      { key: 'gastrostomy', label: 'èƒƒã‚ã†' },
      { key: 'jelly', label: 'ã‚¼ãƒªãƒ¼é£Ÿ' },
    ];
    // ä¸»é£Ÿ
    const MEAL_MAIN_DISH = [
      { key: 'rice', label: 'ç±³é£¯' },
      { key: 'soft_rice', label: 'è»Ÿé£¯' },
      { key: 'porridge', label: 'å…¨ç²¥' },
      { key: 'mousse_porridge', label: 'ãƒ ãƒ¼ã‚¹ç²¥' },
      { key: 'other', label: 'ãã®ä»–' },
    ];
    // å‰¯é£Ÿ
    const MEAL_SIDE_DISH = [
      { key: 'regular', label: 'å¸¸é£Ÿ' },
      { key: 'bite_size', label: 'ä¸€å£å¤§' },
      { key: 'minced', label: 'åˆ»ã¿' },
      { key: 'mousse', label: 'ãƒ ãƒ¼ã‚¹' },
      { key: 'other', label: 'ãã®ä»–' },
    ];
    // é£²ã¿ç‰©
    const MEAL_DRINK = [
      { key: 'normal', label: 'é€šå¸¸' },
      { key: 'thickened', label: 'ãƒˆãƒ­ãƒŸ' },
    ];
    // é–“é£Ÿ
    const MEAL_SNACK = [
      { key: 'normal', label: 'é€šå¸¸' },
      { key: 'thickened', label: 'ãƒˆãƒ­ãƒŸ' },
    ];
    // é£Ÿäº‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°
    const MEAL_TIMING = [
      { key: 'breakfast', label: 'æœ' },
      { key: 'snack1', label: 'é–“1' },
      { key: 'lunch', label: 'æ˜¼' },
      { key: 'snack2', label: 'é–“2' },
      { key: 'dinner', label: 'å¤•' },
    ];
    // åŒºåˆ†
    const MEAL_CATEGORY = [
      { key: 'start', label: 'é–‹å§‹' },
      { key: 'change', label: 'å¤‰æ›´' },
      { key: 'stop', label: 'ä¸­æ­¢' },
    ];
    // ç†ç”±
    const MEAL_REASON = [
      { key: 'ss_repeater_tree', label: 'SS(ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼ï¼šæ¨¹)' },
      { key: 'ss_repeater_vacancy', label: 'SS(ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼ï¼šç©ºåºŠ)' },
      { key: 'ss_new_tree', label: 'SS(æ–°è¦ï¼šæ¨¹)' },
      { key: 'ss_new_vacancy', label: 'SS(æ–°è¦ï¼šç©ºåºŠ)' },
      { key: 'ss_change', label: 'SSå¤‰æ›´' },
      { key: 'ss_stop', label: 'SSé£Ÿæ­¢ã‚' },
    ];

    // --- å®šæ•° ---
    const TEMP_ROOM_1_ID = 'TEMP1';
    const TEMP_ROOM_2_ID = 'TEMP2';
    const TEMP_ROOM_PREFIX = 'TEMP_ROOM_';
    // #endregion

    // #region 5ï¸âƒ£ ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    // --- æ—¥ä»˜ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
    // æ—¥ä»˜æ–‡å­—åˆ—ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§ãƒ‘ãƒ¼ã‚¹ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã‚’å›é¿ï¼‰
    const parseLocalDate = (dateStr) => {
      const [year, month, day] = dateStr.split('-').map(Number);
      return new Date(year, month - 1, day);
    };

    const getFirstDayOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
    const getDaysInMonth = (d) => new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
    const toDateStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    
    // ã‚«ã‚¿ã‚«ãƒŠã‚’ã²ã‚‰ãŒãªã«å¤‰æ›ï¼ˆã‚½ãƒ¼ãƒˆç”¨ï¼‰
    const katakanaToHiragana = (str) => {
      return str.replace(/[\u30A1-\u30F6]/g, (match) => {
        return String.fromCharCode(match.charCodeAt(0) - 0x60);
      });
    };
    
    // ã²ã‚‰ãŒãªã‚’ã‚«ã‚¿ã‚«ãƒŠã«å¤‰æ›ï¼ˆãƒ•ãƒªã‚¬ãƒŠå…¥åŠ›ç”¨ï¼‰
    const hiraganaToKatakana = (str) => {
      return str.replace(/[\u3041-\u3096]/g, (match) => {
        return String.fromCharCode(match.charCodeAt(0) + 0x60);
      });
    };
    const addMonths = (d, n) => new Date(d.getFullYear(), d.getMonth() + n, 1);
    const getPrevDay = (dateStr) => {
      const d = parseLocalDate(dateStr);
      d.setDate(d.getDate() - 1);
      return toDateStr(d);
    };
    const getNextDay = (dateStr) => {
      const d = parseLocalDate(dateStr);
      d.setDate(d.getDate() + 1);
      return toDateStr(d);
    };

    // ç¯„å›²æ—¥ä»˜å–å¾—ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œç‰ˆï¼‰
    const getDatesInRange = (startStr, endStr) => {
      const dates = [];
      const d1 = parseLocalDate(startStr);
      const d2 = parseLocalDate(endStr);
      
      let current = d1 <= d2 ? new Date(d1) : new Date(d2);
      const end = d1 <= d2 ? new Date(d2) : new Date(d1);

      while (current <= end) {
        dates.push(toDateStr(current));
        current.setDate(current.getDate() + 1);
      }
      return dates;
    };

    // --- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åˆæœŸè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
    // é€£ç¶šã—ãŸåˆ©ç”¨æœŸé–“ã‚’å–å¾—
    const getStayPeriods = (stayDates) => {
      const sortedDates = [...stayDates].sort();
      if (sortedDates.length === 0) return [];

      const periods = [];
      let currentPeriod = [sortedDates[0]];
      
      for (let i = 1; i < sortedDates.length; i++) {
        const prev = parseLocalDate(sortedDates[i-1]);
        const curr = parseLocalDate(sortedDates[i]);
        const diff = (curr - prev) / (1000 * 60 * 60 * 24);
        
        if (diff === 1) {
          currentPeriod.push(sortedDates[i]);
        } else {
          periods.push(currentPeriod);
          currentPeriod = [sortedDates[i]];
        }
      }
      periods.push(currentPeriod);
      return periods;
    };

    const calculateInitialSchedule = (stayDates, bathType = '') => {
      const schedule = {};
      const sortedDates = [...stayDates].sort();
      if (sortedDates.length === 0) return schedule;

      const periods = [];
      let currentPeriod = [sortedDates[0]];
      
      for (let i = 1; i < sortedDates.length; i++) {
        const prev = parseLocalDate(sortedDates[i-1]);
        const curr = parseLocalDate(sortedDates[i]);
        const diff = (curr - prev) / (1000 * 60 * 60 * 24);
        
        if (diff === 1) {
          currentPeriod.push(sortedDates[i]);
        } else {
          periods.push(currentPeriod);
          currentPeriod = [sortedDates[i]];
        }
      }
      periods.push(currentPeriod);

      // å…¥æµ´æ–¹æ³•ã«å¿œã˜ãŸæ›œæ—¥åˆ¤å®šé–¢æ•°
      const getBathDays = (bathType) => {
        switch (bathType) {
          case 'intermediate': // ä¸­é–“æµ´: æ°´æ›œæ—¥(3)ã¨åœŸæ›œæ—¥(6)
            return { primary: [3, 6], secondary: null };
          case 'bed': // è‡¥åºŠæµ´: ç«æ›œæ—¥(2)ã¨é‡‘æ›œæ—¥(5)ã€ãƒ€ãƒ¡ãªã‚‰æ°´æ›œæ—¥(3)ã¨åœŸæ›œæ—¥(6)
            return { primary: [2, 5], secondary: [3, 6] };
          case 'individual': // å€‹æµ´: æ›œæ—¥åˆ¶é™ãªã—
          case 'lift': // ãƒªãƒ•ãƒˆæµ´: æ›œæ—¥åˆ¶é™ãªã—
          default:
            return { primary: null, secondary: null };
        }
      };

      const bathDays = getBathDays(bathType);

      // å¯¾è±¡æ›œæ—¥ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
      const isValidBathDay = (dateStr) => {
        if (bathDays.primary === null) return true; // æ›œæ—¥åˆ¶é™ãªã—
        const dayOfWeek = parseLocalDate(dateStr).getDay();
        if (bathDays.primary.includes(dayOfWeek)) return true;
        if (bathDays.secondary && bathDays.secondary.includes(dayOfWeek)) return true;
        return false;
      };

      // å„ªå…ˆæ›œæ—¥ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
      const isPrimaryBathDay = (dateStr) => {
        if (bathDays.primary === null) return true;
        const dayOfWeek = parseLocalDate(dateStr).getDay();
        return bathDays.primary.includes(dayOfWeek);
      };

      periods.forEach(period => {
        const daysInPeriod = period.length;
        
        // åˆæœŸåŒ–: ã™ã¹ã¦ã®æ—¥ã‚’å…¥æµ´ãªã—ã«
        period.forEach((dateStr) => {
          schedule[dateStr] = { bath: false, mustBath: false, linen: false };
        });

        // æœ€çµ‚æ—¥ï¼ˆå¸°å®…å‰æ—¥ï¼‰ã¯å¿…ãšå…¥æµ´ï¼ˆmustBathï¼‰
        const lastDayIndex = daysInPeriod - 1;
        schedule[period[lastDayIndex]].mustBath = true;
        schedule[period[lastDayIndex]].bath = true;

        // å…¥æµ´ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨ˆç®—
        // ãƒ«ãƒ¼ãƒ«ï¼š
        // - é€±2å›ï¼ˆ3-4æ—¥ã«1å›ï¼‰
        // - å¸°å®…å‰æ—¥ã¯å¿…é ˆ
        // - 2æ³Š3æ—¥(3æ—¥), 3æ³Š4æ—¥(4æ—¥) â†’ 1å›ï¼ˆå¸°å®…å‰æ—¥ã®ã¿ï¼‰
        // - 4æ³Š5æ—¥(5æ—¥)ä»¥ä¸Š â†’ é€±2å›ãƒšãƒ¼ã‚¹

        if (daysInPeriod >= 5) {
          // å¸°å®…å‰æ—¥ã‹ã‚‰é€†ç®—ã—ã¦ã€3-4æ—¥ãŠãã«å…¥æµ´ã‚’è¨­å®š
          // å…¥æµ´é–“éš”ã¯3-4æ—¥ï¼ˆé€±2å›ãƒšãƒ¼ã‚¹ï¼‰
          const BATH_INTERVAL = 4; // 4æ—¥é–“éš”ï¼ˆé€±2å›ç›¸å½“ï¼‰
          
          let lastBathIndex = lastDayIndex; // å¸°å®…å‰æ—¥
          let nextBathTarget = lastBathIndex - BATH_INTERVAL;
          
          while (nextBathTarget >= 0) {
            // nextBathTargetä»˜è¿‘ï¼ˆÂ±1æ—¥ï¼‰ã§æœ€é©ãªå…¥æµ´æ—¥ã‚’æ¢ã™
            let bestIndex = -1;
            const searchStart = Math.max(0, nextBathTarget - 1);
            const searchEnd = Math.min(lastDayIndex - 1, nextBathTarget + 1);
            
            // å„ªå…ˆæ›œæ—¥ã§æ¢ã™
            for (let i = searchStart; i <= searchEnd; i++) {
              if (isPrimaryBathDay(period[i]) && !schedule[period[i]].bath) {
                bestIndex = i;
                break;
              }
            }
            
            // ãªã‘ã‚Œã°å¯¾è±¡æ›œæ—¥ã§æ¢ã™
            if (bestIndex === -1) {
              for (let i = searchStart; i <= searchEnd; i++) {
                if (isValidBathDay(period[i]) && !schedule[period[i]].bath) {
                  bestIndex = i;
                  break;
                }
              }
            }
            
            // ãã‚Œã§ã‚‚ãªã‘ã‚Œã°ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä½ç½®ã«è¨­å®š
            if (bestIndex === -1) {
              bestIndex = Math.max(0, Math.min(nextBathTarget, lastDayIndex - 1));
            }
            
            // å…¥æµ´ã‚’è¨­å®šï¼ˆæ—¢ã«è¨­å®šæ¸ˆã¿ã§ãªã‘ã‚Œã°ï¼‰
            if (bestIndex >= 0 && bestIndex < lastDayIndex && !schedule[period[bestIndex]].bath) {
              schedule[period[bestIndex]].bath = true;
              lastBathIndex = bestIndex;
            }
            
            // æ¬¡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
            nextBathTarget = nextBathTarget - BATH_INTERVAL;
          }
        }

        // ãƒªãƒãƒ³äº¤æ›: 7æ—¥ã”ã¨
        period.forEach((dateStr, index) => {
          if ((index + 1) % 7 === 0 && daysInPeriod >= 7) {
            schedule[dateStr].linen = true;
          }
        });
      });

      return schedule;
    };
    // #endregion

    // #region 6ï¸âƒ£ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    // --- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ ---
    const generateSampleUsers = (baseDate) => {
      const year = baseDate.getFullYear();
      const month = baseDate.getMonth();
      const makeDate = (day) => toDateStr(new Date(year, month, day));
      const daysInMonth = getDaysInMonth(baseDate);
      const allDays = Array.from({ length: daysInMonth }, (_, i) => makeDate(i + 1));
      
      const sampleData = [
        { id: 1, name: 'ï¼¡æ§˜', conditions: ['home_oxygen'], stayDates: allDays },
        { id: 2, name: 'ä½è—¤æ§˜', conditions: ['near_toilet', 'high_fall_risk'], stayDates: allDays.filter((_, i) => i + 1 <= 15) },
        { id: 3, name: 'éˆ´æœ¨æ§˜', conditions: ['low_fall_risk'], stayDates: allDays.filter((_, i) => i + 1 >= 15) },
        { id: 4, name: 'ç”°ä¸­æ§˜(æ–°)', conditions: ['is_new'], stayDates: allDays.slice(0, 8) },
        { id: 5, name: 'é«˜æ©‹æ§˜', conditions: ['high_fall_risk'], stayDates: allDays.slice(10, 20) },
      ];

      return sampleData.map(u => ({
        ...u,
        schedule: calculateInitialSchedule(u.stayDates, u.bathType || ''),
        createdAt: new Date().toISOString(),
        isArchived: false,
        fixedRooms: {},
        bathType: ''
      }));
    };
    // #endregion

    // #region 7ï¸âƒ£ èªè¨¼ç”»é¢ LoginScreen
    // ============================================
    // èªè¨¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    // ============================================
    function LoginScreen({ onLocalMode }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [showPassword, setShowPassword] = useState(false);
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        setError('');

        try {
          await firebase.auth().signInWithEmailAndPassword(email, password);
        } catch (err) {
          console.error("Login error:", err);
          let msg = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
          if (err.code === 'auth/invalid-email') msg = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
          if (err.code === 'auth/user-disabled') msg = 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™';
          if (err.code === 'auth/user-not-found') msg = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
          if (err.code === 'auth/wrong-password') msg = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™';
          if (err.code === 'auth/invalid-credential') msg = 'èªè¨¼æƒ…å ±ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
          setError(msg);
          setIsLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-lg p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <h1 className="text-2xl font-bold text-gray-800">{APP_CONFIG.facilityName}</h1>
              <p className="text-gray-500 mt-2">ãƒ­ã‚°ã‚¤ãƒ³</p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors"
                  placeholder="name@example.com"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                </label>
                <div className="relative">
                  <input
                    type={showPassword ? "text" : "password"}
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors pr-10"
                    placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                    required
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 focus:outline-none"
                  >
                    {showPassword ? (
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                      </svg>
                    ) : (
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                        <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                    )}
                  </button>
                </div>
              </div>

              {error && (
                <div className="text-red-500 text-sm font-bold bg-red-50 p-3 rounded">
                  {error}
                </div>
              )}

              <button
                type="submit"
                disabled={isLoading}
                className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"
              >
                {isLoading ? (
                  'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...'
                ) : (
                  'ãƒ­ã‚°ã‚¤ãƒ³'
                )}
              </button>

              <button
                type="button"
                onClick={onLocalMode}
                className="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 mt-4"
              >
                ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ä½¿ã† (Local Mode)
              </button>
            </form>

            <p className="mt-6 text-center text-xs text-gray-400">
              Â© 2025 ShortStay Room Allocation System
            </p>
          </div>
        </div>
      );
    }
    // #endregion

    // #region 8ï¸âƒ£ ãƒ˜ãƒƒãƒ€ãƒ¼ Header
    // ============================================
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    // ============================================
    const Header = ({
      headerCollapsed, setHeaderCollapsed,
      currentMonth, changeMonth,
      userSearchQuery, setUserSearchQuery,
      displayStartDate, setDisplayStartDate,
      displayEndDate, setDisplayEndDate,
      useCustomRange, setUseCustomRange,
      lastBackup, exportData, importData,
      recalculateAllData, recalculateAllSchedules,
      setShowSettings, setShowLogoutConfirm,
      undo, canUndo,
      fileInputRef,
      onAddSticky // ä»˜ç®‹è¿½åŠ ç”¨
    }) => {
      return (
        <>
          {/* æŠ˜ã‚ŠãŸãŸã¿æ™‚ã®ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ */}
          {headerCollapsed && (
            <div className="mb-2 bg-blue-600 text-white px-4 py-2 rounded shadow-sm flex justify-between items-center print-hidden">
              <div className="flex items-center gap-2">
                <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-blue-500 rounded">
                  <ChevronLeft size={18}/>
                </button>
                <span className="font-bold">{currentMonth.getFullYear()}å¹´{currentMonth.getMonth() + 1}æœˆ</span>
                <button onClick={() => changeMonth(1)} className="p-1 hover:bg-blue-500 rounded">
                  <ChevronRight size={18}/>
                </button>
                <button 
                  onClick={() => setHeaderCollapsed(false)}
                  className="ml-2 bg-white text-blue-600 px-3 py-1 rounded text-sm font-bold hover:bg-blue-50"
                >
                  â–¼ å±•é–‹
                </button>
              </div>
              <span className="text-sm opacity-75">{APP_CONFIG.facilityName}</span>
            </div>
          )}
          
          {/* é€šå¸¸ã®ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          {!headerCollapsed && (
          <header className="mb-4 bg-white p-4 rounded shadow-sm border-l-4 border-blue-600 flex flex-col md:flex-row justify-between items-center gap-4 print-hidden">
            <div>
              <div className="flex items-center gap-2">
                <h1 className="text-xl font-bold text-gray-800">{APP_CONFIG.facilityName} éƒ¨å±‹å‰²è¡¨ï¼ˆæœˆé–“ï¼‰</h1>
                <button 
                  onClick={() => setHeaderCollapsed(true)}
                  className="bg-blue-500 hover:bg-blue-600 text-white text-sm px-3 py-1 rounded border-2 border-blue-600 font-bold shadow-sm"
                  title="ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æŠ˜ã‚ŠãŸãŸã‚€"
                >
                  â–² ç¸®å°
                </button>
              </div>
              <div className="flex items-center gap-4 mt-2">
                <div className="flex items-center gap-4 bg-gray-100 p-2 rounded-lg">
                  <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-gray-200 rounded">
                    <ChevronLeft size={20}/>
                  </button>
                  <span className="font-bold text-gray-700 flex items-center gap-2 text-lg w-40 justify-center">
                    <CalendarIcon size={20}/>
                    {currentMonth.getFullYear()}å¹´ {currentMonth.getMonth() + 1}æœˆ
                  </span>
                  <button onClick={() => changeMonth(1)} className="p-1 hover:bg-gray-200 rounded">
                    <ChevronRight size={20}/>
                  </button>
                </div>
                
                {/* åˆ©ç”¨è€…æ¤œç´¢ */}
                <div className="relative">
                  <input
                    type="text"
                    placeholder="ğŸ” åˆ©ç”¨è€…æ¤œç´¢..."
                    value={userSearchQuery}
                    onChange={(e) => setUserSearchQuery(e.target.value)}
                    className="w-48 p-2 pl-3 pr-8 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-300 bg-white"
                  />
                  {userSearchQuery && (
                    <button
                      onClick={() => setUserSearchQuery('')}
                      className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 text-lg font-bold"
                    >
                      Ã—
                    </button>
                  )}
                </div>

                {/* æœŸé–“é¸æŠ */}
                <div className="flex items-center gap-2 ml-4 bg-white border rounded p-2">
                  <span className="text-xs text-gray-500">ğŸ“…æœŸé–“:</span>
                  <input
                    type="date"
                    value={displayStartDate}
                    onChange={(e) => {
                      setDisplayStartDate(e.target.value);
                      if (e.target.value && displayEndDate) {
                        setUseCustomRange(true);
                      }
                    }}
                    className="text-sm p-1 border rounded w-32"
                  />
                  <span className="text-gray-400">ï½</span>
                  <input
                    type="date"
                    value={displayEndDate}
                    onChange={(e) => {
                      setDisplayEndDate(e.target.value);
                      if (displayStartDate && e.target.value) {
                        setUseCustomRange(true);
                      }
                    }}
                    className="text-sm p-1 border rounded w-32"
                  />
                  {useCustomRange && (
                    <button
                      onClick={() => {
                        setUseCustomRange(false);
                        setDisplayStartDate('');
                        setDisplayEndDate('');
                      }}
                      className="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-600"
                    >
                      æœˆè¡¨ç¤ºã«æˆ»ã™
                    </button>
                  )}
                </div>
              </div>
            </div>
            <div className="flex gap-2 items-center flex-wrap justify-end">
              <button 
                onClick={onAddSticky}
                className="flex items-center gap-1 bg-yellow-400 hover:bg-yellow-500 text-yellow-900 px-3 py-2 rounded font-bold shadow transition-colors text-sm border border-yellow-500"
                title="ç”»é¢ã«ä»˜ç®‹ã‚’è²¼ã‚‹"
              >
                ğŸ“ ä»˜ç®‹
              </button>
              <button 
                onClick={undo}
                disabled={!canUndo}
                className={`flex items-center gap-1 px-3 py-2 rounded font-bold shadow transition-colors text-sm ${
                  canUndo 
                    ? 'bg-gray-700 hover:bg-gray-800 text-white' 
                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                }`}
                title="ç›´å‰ã®æ“ä½œã‚’å…ƒã«æˆ»ã™"
              >
                <RotateCcw size={16} />
                å…ƒã«æˆ»ã™
              </button>
              {/* ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è­¦å‘Š */}
              {(() => {
                const daysSinceBackup = lastBackup 
                  ? Math.floor((new Date() - lastBackup) / (1000 * 60 * 60 * 24))
                  : null;
                const needsBackup = daysSinceBackup === null || daysSinceBackup >= 7;
                
                return (
                  <div className={`text-xs mr-2 flex items-center gap-1 ${needsBackup ? 'text-red-500 font-bold' : 'text-gray-400'}`}>
                    <Save size={14}/>
                    {lastBackup ? (
                      needsBackup ? (
                        <span>âš ï¸ {daysSinceBackup}æ—¥å‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</span>
                      ) : (
                        <span>æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: {daysSinceBackup === 0 ? 'ä»Šæ—¥' : `${daysSinceBackup}æ—¥å‰`}</span>
                      )
                    ) : (
                      <span>âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æœªå®Ÿæ–½</span>
                    )}
                  </div>
                );
              })()}
              <button 
                onClick={exportData}
                className={`flex items-center gap-1 text-white px-3 py-2 rounded font-bold shadow transition-colors text-sm ${
                  (!lastBackup || (new Date() - lastBackup) / (1000 * 60 * 60 * 24) >= 7)
                    ? 'bg-red-500 hover:bg-red-600 animate-pulse'
                    : 'bg-green-600 hover:bg-green-700'
                }`}
                title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"
              >
                <Download size={16} />
                ä¿å­˜
              </button>
              <button 
                onClick={() => fileInputRef.current?.click()}
                className="flex items-center gap-1 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded font-bold shadow transition-colors text-sm"
                title="å¾©å…ƒ"
              >
                <Upload size={16} />
                å¾©å…ƒ
              </button>
              <input
                ref={fileInputRef}
                type="file"
                accept=".json"
                onChange={importData}
                className="hidden"
              />
              <button 
                onClick={recalculateAllData}
                className="flex items-center gap-1 bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded font-bold shadow transition-colors text-sm"
                title="å…¨åˆ©ç”¨è€…ã®éƒ¨å±‹å‰²ã‚Šï¼‹å…¥æµ´ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†è¨ˆç®—"
              >
                ğŸ”„ ã™ã¹ã¦å†è¨ˆç®—
              </button>
              <button 
                onClick={recalculateAllSchedules}
                className="flex items-center gap-1 bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded font-bold shadow transition-colors text-sm"
                title="å…¥æµ´ãƒ»ãƒªãƒãƒ³ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿å†è¨ˆç®—ï¼ˆéƒ¨å±‹å‰²ã‚Šã¯å¤‰æ›´ã—ãªã„ï¼‰"
              >
                ğŸ›ğŸ›ï¸ å…¥æµ´ãƒ»ãƒªãƒãƒ³ã®ã¿å†è¨ˆç®—
              </button>
              <button 
                onClick={() => window.print()}
                className="flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded font-bold shadow transition-colors"
              >
                <Printer size={18} />
                å°åˆ·
              </button>
              <button 
                onClick={() => setShowSettings(true)}
                className="flex items-center gap-1 bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded font-bold shadow transition-colors text-sm"
                title="è¨­å®š"
              >
                <Settings size={16} />
              </button>
              <button 
                onClick={() => setShowLogoutConfirm(true)}
                className="flex items-center gap-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded font-bold shadow transition-colors text-sm"
                title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"
              >
                <LogOut size={16} />
              </button>
            </div>
          </header>
          )}
        </>
      );
    };
    // #endregion

    // #region 9ï¸âƒ£ ã‚µã‚¤ãƒ‰ãƒãƒ¼ Sidebar
    // ============================================
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆåˆ©ç”¨è€…ãƒªã‚¹ãƒˆï¼‰
    // ============================================
    const Sidebar = ({
      sidebarCollapsed, setSidebarCollapsed,
      userSortOrder, setUserSortOrder,
      userSearchQuery, users, currentMonth,
      handleEditUser, deleteUser, archiveUser, setShowArchivedModal,
      newUserOpen, setNewUserOpen,
      setSelectionStart, setEditingUser, setNewUserData,
      setTempFixedPeriod, setTempFixedRoomId, setCalendarMonth,
      mealTickets, setEditingMealTicket, setShowMealTicketModal,
      rooms, setEditingRooms, setShowRoomEditor,
      clearAllData,
      // æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ç”¨
      newUserData, handleSaveUser, clearSelectedDates, renderCalendarGrid,
      tempFixedPeriod, tempFixedRoomId, tempRooms,
      toggleCondition,
      // å®šæ•°
      CONDITIONS, BATH_TYPES, TEMP_ROOM_1_ID, TEMP_ROOM_2_ID
    }) => {
      return (
        <>
          {/* æŠ˜ã‚ŠãŸãŸã¿æ™‚ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼å±•é–‹ãƒœã‚¿ãƒ³ */}
          {sidebarCollapsed && (
            <button
              onClick={() => setSidebarCollapsed(false)}
              className="fixed left-0 top-1/2 transform -translate-y-1/2 bg-blue-600 text-white px-2 py-4 rounded-r-lg shadow-lg hover:bg-blue-700 z-30 print-hidden"
              title="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å±•é–‹"
            >
              <span className="writing-mode-vertical">â–¶ åˆ©ç”¨è€…</span>
            </button>
          )}
          
          {/* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ */}
          {!sidebarCollapsed && (
          <div className="lg:col-span-1 space-y-4 print-hidden relative">
            <div className="bg-white p-4 rounded shadow-sm border border-gray-200 relative">
              <div className="flex justify-between items-center mb-2">
                <h2 className="font-bold text-gray-700 flex items-center gap-2">
                  <User size={18} />
                  åˆ©ç”¨è€…ãƒªã‚¹ãƒˆ
                </h2>
                <div className="flex items-center gap-1">
                  <button
                    onClick={() => setUserSortOrder(prev => prev === 'asc' ? 'desc' : 'asc')}
                    className="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded flex items-center gap-1 font-bold border border-blue-600"
                    title={userSortOrder === 'asc' ? 'é™é †ã«å¤‰æ›´' : 'æ˜‡é †ã«å¤‰æ›´'}
                  >
                    {userSortOrder === 'asc' ? 'â–² ã‚â†’ã‚“' : 'â–¼ ã‚“â†’ã‚'}
                  </button>
                  <button
                    onClick={() => setSidebarCollapsed(true)}
                    className="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded font-bold border border-blue-600"
                    title="ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æŠ˜ã‚ŠãŸãŸã‚€"
                  >
                    â—€ ç¸®å°
                  </button>
                </div>
              </div>
              
              <div className="space-y-2 mb-4 max-h-[400px] overflow-y-auto">
                {(() => {
                  // 6ãƒ¶æœˆå‰ã®æ—¥ä»˜ã‚’è¨ˆç®—
                  const sixMonthsAgo = new Date();
                  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                  const sixMonthsAgoStr = toDateStr(sixMonthsAgo);
                  
                  // è¡¨ç¤ºå¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                  const visibleUsers = users.filter(user => {
                    if (user.isArchived) return false;
                    if (user.stayDates && user.stayDates.length > 0) {
                      const latestStayDate = [...user.stayDates].sort().pop();
                      if (latestStayDate >= sixMonthsAgoStr) return true;
                    }
                    if (user.createdAt) {
                      const createdDate = toDateStr(new Date(user.createdAt));
                      if (createdDate >= sixMonthsAgoStr) return true;
                    }
                    if (!user.createdAt) return true;
                    return false;
                  });
                  
                  const searchedUsers = userSearchQuery
                    ? visibleUsers.filter(user => user.name.toLowerCase().includes(userSearchQuery.toLowerCase()))
                    : visibleUsers;
                  
                  const sortedUsers = [...searchedUsers].sort((a, b) => {
                    const aSort = katakanaToHiragana(a.furigana || a.name);
                    const bSort = katakanaToHiragana(b.furigana || b.name);
                    const comparison = aSort.localeCompare(bSort, 'ja');
                    return userSortOrder === 'asc' ? comparison : -comparison;
                  });
                  
                  if (sortedUsers.length === 0 && userSearchQuery) {
                    return <div className="text-center text-gray-400 py-4 text-sm">ã€Œ{userSearchQuery}ã€ã«ä¸€è‡´ã™ã‚‹åˆ©ç”¨è€…ã¯ã„ã¾ã›ã‚“</div>;
                  }
                  
                  return sortedUsers.map(user => (
                    <div key={user.id} className="p-2 border rounded bg-gray-50 flex justify-between items-start group">
                      <div>
                        <div className="font-bold text-gray-800">
                          {user.name}
                          {users.filter(u => !u.isArchived && u.name === user.name).length > 1 && (
                            <span className="ml-1 text-[10px] bg-red-100 text-red-800 px-1 rounded border border-red-200 font-bold" title="åŒå§“åŒåã®åˆ©ç”¨è€…ãŒå­˜åœ¨ã—ã¾ã™">âš ï¸åŒåã‚ã‚Š</span>
                          )}
                          {user.isLongTerm && <span className="ml-1 text-[10px] bg-indigo-100 text-indigo-800 px-1 rounded border border-indigo-200">ãƒ­ãƒ³ã‚°</span>}
                        </div>
                        <div className="flex flex-wrap gap-1 mt-1">
                          {user.conditions.map(c => {
                            const label = CONDITIONS.find(def => def.key === c)?.label;
                            return label ? <span key={c} className="text-[10px] bg-blue-100 text-blue-800 px-1 rounded">{label}</span> : null;
                          })}
                          {user.medical?.insulin && <span className="text-[10px] bg-red-100 text-red-800 px-1 rounded">ğŸ’‰ï½²ï¾ï½½ï¾˜ï¾</span>}
                          {user.medical?.gastrostomy && <span className="text-[10px] bg-red-100 text-red-800 px-1 rounded">ğŸ”´èƒƒã‚ã†</span>}
                          {user.medical?.oxygenTherapy && <span className="text-[10px] bg-red-100 text-red-800 px-1 rounded">ğŸ«é…¸ç´ </span>}
                          {user.medical?.balloonCatheter && <span className="text-[10px] bg-red-100 text-red-800 px-1 rounded">ğŸˆãƒãƒ«ãƒ³</span>}
                          {user.medical?.stoma && <span className="text-[10px] bg-red-100 text-red-800 px-1 rounded">â­•ã‚¹ãƒˆãƒ</span>}
                        </div>
                        <div className="text-sm text-gray-600 mt-1">
                          åˆ©ç”¨æ—¥æ•°: {user.stayDates.filter(d => d.startsWith(toDateStr(currentMonth).slice(0, 7))).length}æ—¥
                          {user.bathType && <span className="ml-2 text-blue-600 font-bold">ğŸ›{BATH_TYPES.find(b => b.key === user.bathType)?.label}</span>}
                          {user.fixedRooms && Object.keys(user.fixedRooms).length > 0 && (
                            <span className="ml-2 text-yellow-600 font-bold">ğŸ”’{Object.keys(user.fixedRooms).length}æœŸé–“å›ºå®š</span>
                          )}
                        </div>
                        {(user.transport?.pickupMethod || user.transport?.pickupTime || user.transport?.dropoffTime) && (
                          <div className="text-[10px] text-green-700 mt-1">
                            ğŸš—{user.transport.pickupMethod || ''}{user.transport.pickupTime && ` è¿${user.transport.pickupTime}`}{user.transport.dropoffTime && ` é€${user.transport.dropoffTime}`}{user.transport.wheelchairNeeded && ' ğŸ¦½è»Šã„ã™è¦'}
                          </div>
                        )}
                        {user.careManager?.officeName && (
                          <div className="text-[10px] text-purple-700 mt-1">
                            ğŸ“‹{user.careManager.officeName}{user.careManager.staffName && ` (${user.careManager.staffName})`}
                          </div>
                        )}
                      </div>
                      <div className="flex gap-1">
                        <button onClick={() => archiveUser(user.id)} className="text-gray-400 hover:text-gray-600 p-1 opacity-0 group-hover:opacity-100 transition-opacity" title="éè¡¨ç¤ºã«ã™ã‚‹ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰">
                          <EyeOff size={16} />
                        </button>
                        <button onClick={() => handleEditUser(user)} className="text-gray-400 hover:text-blue-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity" title="ç·¨é›†">
                          <Edit size={16} />
                        </button>
                        <button 
                          onClick={() => {
                            const periods = getStayPeriods(user.stayDates);
                            if (periods.length === 0) {
                              alert('åˆ©ç”¨æ—¥ç¨‹ãŒã‚ã‚Šã¾ã›ã‚“');
                              return;
                            }
                            const period = periods[0];
                            const periodStart = period[0];
                            const periodEnd = period[period.length - 1];
                            const ticketKey = `${user.id}_${periodStart}_${periodEnd}`;
                            const existingTicket = mealTickets[ticketKey];
                            
                            if (existingTicket) {
                              setEditingMealTicket(existingTicket);
                            } else {
                              const defaultMealPref = user.mealPref || {};
                              setEditingMealTicket({
                                userId: user.id,
                                startDate: periodStart,
                                endDate: periodEnd,
                                unit: 'æ¨¹',
                                startMeal: '',
                                endMeal: '',
                                category: '',
                                reason: '',
                                foodType: defaultMealPref.foodType || '',
                                diabetesKcal: '',
                                mainDish: defaultMealPref.mainDish || '',
                                mainDishOther: '',
                                sideDish: defaultMealPref.sideDish || '',
                                sideDishOther: '',
                                drink: defaultMealPref.drink || '',
                                snack: defaultMealPref.snack || '',
                                memo: defaultMealPref.allergy ? `ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼: ${defaultMealPref.allergy}` : ''
                              });
                            }
                            setShowMealTicketModal(true);
                          }} 
                          className="text-gray-400 hover:text-green-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity"
                          title="é£Ÿäº‹ä¼ç¥¨"
                        >
                          ğŸ½ï¸
                        </button>
                      </div>
                    </div>
                  ));
                })()}
              </div>

              <div className="flex flex-col gap-2">
                <button 
                  onClick={() => {
                    setNewUserOpen(!newUserOpen);
                    setSelectionStart(null);
                    setEditingUser(null);
                    setNewUserData({ 
                      name: '', furigana: '', gender: '', birthDate: '', birthDateMode: 'wareki', birthEra: '', birthYear: '', birthMonth: '', birthDay: '',
                      conditions: [], stayDates: [], fixedRooms: {}, bathType: '',
                      medical: { insulin: false, gastrostomy: false, oxygenTherapy: false, balloonCatheter: false, stoma: false, note: '' },
                      transport: { pickupTime: '', dropoffTime: '', address: '', pickupMethod: '', wheelchairNeeded: false, note: '' },
                      careManager: { officeName: '', staffName: '', phone: '', fax: '', mobile: '' },
                      mealPref: { foodType: '', mainDish: '', sideDish: '', drink: '', snack: '', allergy: '' },
                      isLongTerm: false, longTermStartDate: '', longTermEndDate: ''
                    });
                    setTempFixedPeriod('');
                    setTempFixedRoomId('');
                    setCalendarMonth(currentMonth);
                  }}
                  className="w-full flex justify-center items-center gap-2 border-2 border-dashed border-gray-300 p-2 rounded text-gray-500 hover:border-blue-400 hover:text-blue-500 transition-colors"
                >
                  <Plus size={16} />
                  {newUserOpen ? 'é–‰ã˜ã‚‹' : 'æ–°è¦è¿½åŠ '}
                </button>
                
                <button
                  onClick={() => setShowArchivedModal(true)}
                  className="w-full flex justify-center items-center gap-2 text-sm font-bold text-red-600 bg-red-50 hover:bg-red-100 border border-red-200 rounded py-2 transition-colors"
                >
                  <ListIcon size={18} />
                  éè¡¨ç¤ºåˆ©ç”¨è€…ãƒªã‚¹ãƒˆ
                </button>
              </div>
            </div>

            <div className="bg-white p-4 rounded shadow-sm border border-gray-200">
              <div className="flex justify-between items-center mb-2">
                <h3 className="font-bold text-sm text-gray-700 flex items-center gap-2"><MapPin size={16}/> éƒ¨å±‹æ¡ä»¶</h3>
                <button
                  onClick={() => {
                    setEditingRooms(JSON.parse(JSON.stringify(rooms)));
                    setShowRoomEditor(true);
                  }}
                  className="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded font-bold"
                >
                  âœï¸ ç·¨é›†
                </button>
              </div>
              <ul className="text-sm text-gray-600 space-y-1">
                {rooms.map(room => (
                  <li key={room.id} className="flex">
                    <span className="font-bold w-12 text-gray-800">{room.name}</span>
                    <span className="text-gray-600">: {room.label || 'é€šå¸¸'}</span>
                  </li>
                ))}
              </ul>
            </div>
            
            <div className="text-right">
              <button onClick={clearAllData} className="text-xs text-gray-400 hover:text-red-500 underline">
                å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆ
              </button>
            </div>
          </div>
          )}
        </>
      );
    };

    // ============================================
    // éè¡¨ç¤ºåˆ©ç”¨è€…ãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
    // #endregion
    // ============================================
    // #region ğŸ”Ÿ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ€ãƒ«
    const ArchivedUserListModal = ({ users, onClose, onUnarchive, onDelete }) => {
      const [searchTerm, setSearchTerm] = useState('');

      // éè¡¨ç¤ºãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿æŠ½å‡ºã—ã€ãƒ•ãƒªã‚¬ãƒŠé †ã§ã‚½ãƒ¼ãƒˆ
      const archivedUsers = users
        .filter(u => u.isArchived)
        .filter(u => u.name.includes(searchTerm) || (u.furigana && u.furigana.includes(searchTerm)))
        .sort((a, b) => {
          const aSort = katakanaToHiragana(a.furigana || a.name);
          const bSort = katakanaToHiragana(b.furigana || b.name);
          return aSort.localeCompare(bSort, 'ja');
        });

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]">
          <div className="bg-white rounded-lg shadow-xl p-6 w-[600px] max-w-[95vw] max-h-[90vh] flex flex-col">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2">
                <EyeOff size={20} />
                éè¡¨ç¤ºï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰åˆ©ç”¨è€…ãƒªã‚¹ãƒˆ
              </h3>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>

            <div className="mb-4">
              <input
                type="text"
                placeholder="åå‰ã§æ¤œç´¢..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full p-2 border rounded text-sm"
              />
            </div>

            <div className="flex-1 overflow-y-auto border rounded bg-gray-50 p-2 space-y-2">
              {archivedUsers.length === 0 ? (
                <p className="text-center text-gray-400 py-8">éè¡¨ç¤ºã®åˆ©ç”¨è€…ã¯ã„ã¾ã›ã‚“</p>
              ) : (
                archivedUsers.map(user => (
                  <div key={user.id} className="bg-white p-3 rounded border shadow-sm flex justify-between items-center">
                    <div>
                      <div className="font-bold text-gray-800">{user.name}</div>
                      <div className="text-xs text-gray-500">{user.furigana}</div>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => onUnarchive(user.id)} className="flex items-center gap-1 bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 text-xs font-bold">
                        <Eye size={14} /> å†è¡¨ç¤º
                      </button>
                      <button onClick={() => onDelete(user.id)} className="flex items-center gap-1 bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 text-xs font-bold">
                        <Trash2 size={14} /> å®Œå…¨å‰Šé™¤
                      </button>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // ä»˜ç®‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    // ============================================
    const StickyNote = ({ sticky, onUpdate, onDelete }) => {
      const [position, setPosition] = useState({ x: sticky.x, y: sticky.y });
      const [size, setSize] = useState({ width: sticky.width || 200, height: sticky.height || 150 });
      const [isDragging, setIsDragging] = useState(false);
      const [isResizing, setIsResizing] = useState(false);
      const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
      const [resizeStart, setResizeStart] = useState({ x: 0, y: 0, w: 0, h: 0 });
      const [text, setText] = useState(sticky.text);
      
      // å¤–éƒ¨ã‹ã‚‰ã®å¤‰æ›´ã‚’åæ˜ 
      useEffect(() => {
        setPosition({ x: sticky.x, y: sticky.y });
      }, [sticky.x, sticky.y]);

      useEffect(() => {
        setSize({ width: sticky.width || 200, height: sticky.height || 150 });
      }, [sticky.width, sticky.height]);

      useEffect(() => {
        setText(sticky.text);
      }, [sticky.text]);

      const handleMouseDown = (e) => {
        if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'BUTTON' || e.target.closest('.resize-handle')) return;
        setIsDragging(true);
        setDragOffset({
          x: e.clientX - position.x,
          y: e.clientY - position.y
        });
        e.stopPropagation();
      };

      const handleResizeMouseDown = (e) => {
        e.stopPropagation();
        setIsResizing(true);
        setResizeStart({
          x: e.clientX,
          y: e.clientY,
          w: size.width,
          h: size.height
        });
      };

      useEffect(() => {
        const handleMouseMove = (e) => {
          if (isDragging) {
            setPosition({
              x: e.clientX - dragOffset.x,
              y: e.clientY - dragOffset.y
            });
          } else if (isResizing) {
            const deltaX = e.clientX - resizeStart.x;
            const deltaY = e.clientY - resizeStart.y;
            setSize({
              width: Math.max(100, resizeStart.w + deltaX),
              height: Math.max(100, resizeStart.h + deltaY)
            });
          }
        };
        
        const handleMouseUp = () => {
          if (isDragging) {
            setIsDragging(false);
            onUpdate(sticky.id, { x: position.x, y: position.y });
          }
          if (isResizing) {
            setIsResizing(false);
            onUpdate(sticky.id, { width: size.width, height: size.height });
          }
        };

        if (isDragging || isResizing) {
          window.addEventListener('mousemove', handleMouseMove);
          window.addEventListener('mouseup', handleMouseUp);
        }
        return () => {
          window.removeEventListener('mousemove', handleMouseMove);
          window.removeEventListener('mouseup', handleMouseUp);
        };
      }, [isDragging, isResizing, dragOffset, resizeStart, onUpdate, sticky.id, position, size]);

      const colors = [
        { bg: 'bg-yellow-100', border: 'border-yellow-300' },
        { bg: 'bg-pink-100', border: 'border-pink-300' },
        { bg: 'bg-blue-100', border: 'border-blue-300' },
        { bg: 'bg-green-100', border: 'border-green-300' },
      ];
      
      const currentColor = colors.find(c => c.bg === sticky.color) || colors[0];

      return (
        <div
          style={{
            position: 'fixed',
            left: position.x,
            top: position.y,
            zIndex: 1000 + (sticky.zIndex || 0),
            width: size.width,
            height: size.height,
          }}
          className={`shadow-xl rounded-lg flex flex-col border-2 ${currentColor.bg} ${currentColor.border} transition-shadow hover:shadow-2xl print-hidden`}
          onMouseDown={handleMouseDown}
        >
          <div className="flex justify-between items-center p-1 border-b border-black/5 cursor-move handle bg-black/5">
            <div className="flex gap-1 px-1">
               {colors.map(c => (
                 <button
                   key={c.bg}
                   className={`w-3 h-3 rounded-full border border-gray-400 ${c.bg} hover:scale-110 transition-transform`}
                   onClick={(e) => { e.stopPropagation(); onUpdate(sticky.id, { color: c.bg }); }}
                   title="è‰²ã‚’å¤‰æ›´"
                 />
               ))}
            </div>
            <button 
              onClick={(e) => { e.stopPropagation(); onDelete(sticky.id); }} 
              className="text-gray-400 hover:text-red-500 font-bold px-2 leading-none"
              title="å‰Šé™¤"
            >Ã—</button>
          </div>
          <textarea
            className={`flex-1 w-full p-2 bg-transparent resize-none outline-none text-sm text-gray-800 placeholder-gray-400`}
            value={text}
            onChange={(e) => setText(e.target.value)}
            onBlur={() => onUpdate(sticky.id, { text })}
            placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."
          />
          {/* ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« */}
          <div
            className="resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-se-resize flex items-end justify-end p-0.5"
            onMouseDown={handleResizeMouseDown}
            title="ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚µã‚¤ã‚ºå¤‰æ›´"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-3 h-3 text-gray-500 opacity-50">
              <path d="M21 15L15 21M21 8L8 21" strokeLinecap="round" strokeLinejoin="round" />
            </svg>
          </div>
        </div>
      );
    };

    // ============================================
    // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    // #endregion
    // ============================================
    // #region 1ï¸âƒ£1ï¸âƒ£ ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª ShortStayAllocator
    function ShortStayAllocator({ onLogout }) {
      const [currentMonth, setCurrentMonth] = useState(getFirstDayOfMonth(new Date()));
      const [rooms, setRooms] = useState(INITIAL_ROOMS);
      const [showRoomEditor, setShowRoomEditor] = useState(false);
      const [editingRooms, setEditingRooms] = useState([]);
      const [tempRooms, setTempRooms] = useState([]); // ç©ºåºŠåˆ©ç”¨éƒ¨å±‹
      const [editingTempRoom, setEditingTempRoom] = useState(null); // ç·¨é›†ä¸­ã®ç©ºåºŠéƒ¨å±‹
      
      const [users, setUsers] = useState([]);
      const [allocations, setAllocations] = useState({}); 
      const [memos, setMemos] = useState({}); 
      const [stickies, setStickies] = useState([]); // ä»˜ç®‹ãƒ‡ãƒ¼ã‚¿
      const [customRows, setCustomRows] = useState([{ id: 'cancel-wait', name: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡' }]); // ã‚«ã‚¹ã‚¿ãƒ è¡Œ
      const [customRowMemos, setCustomRowMemos] = useState({}); // ã‚«ã‚¹ã‚¿ãƒ è¡Œã®ãƒ¡ãƒ¢
      const [isLoaded, setIsLoaded] = useState(false);
      
      const [newUserOpen, setNewUserOpen] = useState(false);
      const [editingUser, setEditingUser] = useState(null); 
      const [newUserData, setNewUserData] = useState({ 
        name: '', 
        furigana: '', 
        gender: '', // æ€§åˆ¥: 'male' or 'female'
        birthDate: '', // ç”Ÿå¹´æœˆæ—¥: 'YYYY-MM-DD'
        birthDateMode: 'wareki', // 'wareki' or 'western'
        birthEra: '', // reiwa, heisei, showa, taisho
        birthYear: '',
        birthMonth: '',
        birthDay: '',
        conditions: [], 
        stayDates: [], 
        fixedRooms: {}, 
        bathType: '',
        // åŒ»ç™‚æƒ…å ±
        medical: { insulin: false, gastrostomy: false, oxygenTherapy: false, balloonCatheter: false, stoma: false, note: '' },
        // é€è¿ãƒ‡ãƒ¼ã‚¿
        transport: { pickupTime: '', dropoffTime: '', address: '', pickupMethod: '', wheelchairNeeded: false, note: '' },
        // å±…å®…ä»‹è­·æ”¯æ´äº‹æ¥­æ‰€
        careManager: { officeName: '', staffName: '', phone: '', fax: '', mobile: '' },
        // é£Ÿäº‹æƒ…å ±ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        mealPref: { foodType: '', mainDish: '', sideDish: '', drink: '', snack: '', allergy: '' },
        // ãƒ­ãƒ³ã‚°åˆ©ç”¨
        isLongTerm: false, longTermStartDate: '', longTermEndDate: ''
      });
      
      // éƒ¨å±‹å›ºå®šç·¨é›†ç”¨ã®ä¸€æ™‚ã‚¹ãƒ†ãƒ¼ãƒˆ
      const [tempFixedPeriod, setTempFixedPeriod] = useState('');
      const [tempFixedRoomId, setTempFixedRoomId] = useState('');

      const [selectionStart, setSelectionStart] = useState(null);
      const [calendarMonth, setCalendarMonth] = useState(currentMonth); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠç”¨ã®æœˆ
      const [userSortOrder, setUserSortOrder] = useState('asc'); // 'asc' = æ˜‡é †(ã‚â†’ã‚“), 'desc' = é™é †(ã‚“â†’ã‚)
      const [userSearchQuery, setUserSearchQuery] = useState(''); // åˆ©ç”¨è€…æ¤œç´¢
      const [displayStartDate, setDisplayStartDate] = useState(''); // è¡¨ç¤ºé–‹å§‹æ—¥
      const [displayEndDate, setDisplayEndDate] = useState(''); // è¡¨ç¤ºçµ‚äº†æ—¥
      const [useCustomRange, setUseCustomRange] = useState(false); // ã‚«ã‚¹ã‚¿ãƒ æœŸé–“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
      const [showSettings, setShowSettings] = useState(false); // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
      const [headerCollapsed, setHeaderCollapsed] = useState(false); // ãƒ˜ãƒƒãƒ€ãƒ¼æŠ˜ã‚ŠãŸãŸã¿
      const [sidebarCollapsed, setSidebarCollapsed] = useState(false); // ã‚µã‚¤ãƒ‰ãƒãƒ¼æŠ˜ã‚ŠãŸãŸã¿
      const [settingsError, setSettingsError] = useState('');
      const [settingsSuccess, setSettingsSuccess] = useState('');
      const [lastBackup, setLastBackup] = useState(null);
      const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
      const [archiveYear, setArchiveYear] = useState('');
      const [showArchiveConfirm, setShowArchiveConfirm] = useState(false);
      const [showArchivedModal, setShowArchivedModal] = useState(false); // éè¡¨ç¤ºãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
      const [archiveStats, setArchiveStats] = useState(null);
      const tableContainerRef = React.useRef(null);
      
      // å±¥æ­´ç®¡ç†ï¼ˆUndoç”¨ï¼‰
      const [history, setHistory] = useState([]);
      
      const saveHistory = () => {
        const snapshot = {
          users: JSON.parse(JSON.stringify(users)),
          allocations: JSON.parse(JSON.stringify(allocations)),
          memos: JSON.parse(JSON.stringify(memos)),
          rooms: JSON.parse(JSON.stringify(rooms)),
          tempRooms: JSON.parse(JSON.stringify(tempRooms)),
          mealTickets: JSON.parse(JSON.stringify(mealTickets)),
          customRows: JSON.parse(JSON.stringify(customRows)),
          customRowMemos: JSON.parse(JSON.stringify(customRowMemos)),
          stickies: JSON.parse(JSON.stringify(stickies))
        };
        setHistory(prev => [...prev.slice(-9), snapshot]); // æœ€å¤§10ä»¶ä¿å­˜
      };

      const undo = () => {
        if (history.length === 0) return;
        if (!window.confirm('ç›´å‰ã®æ“ä½œã‚’å–ã‚Šæ¶ˆã—ã¦å…ƒã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) return;
        
        const prev = history[history.length - 1];
        setHistory(curr => curr.slice(0, -1));
        
        setUsers(prev.users);
        setAllocations(prev.allocations);
        setMemos(prev.memos);
        setRooms(prev.rooms);
        setTempRooms(prev.tempRooms);
        setMealTickets(prev.mealTickets);
        setCustomRows(prev.customRows);
        setCustomRowMemos(prev.customRowMemos);
        setStickies(prev.stickies);
        
        if (isFirebaseEnabled && database) {
          const updates = {};
          updates[`data/${STORAGE_KEY_USERS}`] = prev.users;
          updates[`data/${STORAGE_KEY_ALLOCATIONS}`] = prev.allocations;
          updates[`data/${STORAGE_KEY_MEMOS}`] = prev.memos;
          updates[`data/${STORAGE_KEY_ROOMS}`] = prev.rooms;
          updates[`data/${STORAGE_KEY_TEMP_ROOMS}`] = prev.tempRooms;
          updates[`data/${STORAGE_KEY_MEAL_TICKETS}`] = prev.mealTickets;
          updates[`data/${STORAGE_KEY_CUSTOM_ROWS}`] = prev.customRows;
          updates[`data/${STORAGE_KEY_CUSTOM_ROW_MEMOS}`] = prev.customRowMemos;
          updates[`data/${STORAGE_KEY_STICKIES}`] = prev.stickies;
          database.ref().update(updates);
        }
      };

      // é£Ÿäº‹ä¼ç¥¨é–¢é€£ã®state
      const [mealTickets, setMealTickets] = useState({}); // { "userId_startDate_endDate": {...} }
      const [showMealTicketModal, setShowMealTicketModal] = useState(false);
      const [editingMealTicket, setEditingMealTicket] = useState(null); // ç·¨é›†ä¸­ã®ä¼ç¥¨æƒ…å ±
      
      // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢æ•°
      const scrollTable = (direction) => {
        if (tableContainerRef.current) {
          const scrollAmount = 300;
          tableContainerRef.current.scrollBy({
            left: direction === 'left' ? -scrollAmount : scrollAmount,
            behavior: 'smooth'
          });
        }
      };
      
      const [dragItem, setDragItem] = useState(null);
      const [dragOverTarget, setDragOverTarget] = useState(null);
      
      // åˆ©ç”¨è€…ã®éƒ¨å±‹ç§»å‹•ç”¨ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹
      const [dragUser, setDragUser] = useState(null); // { userId, date, fromRoomId }
      const [dragOverRoom, setDragOverRoom] = useState(null); // "date-roomId"
      
      // å³ã‚¯ãƒªãƒƒã‚¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨
      const [contextMenu, setContextMenu] = useState(null); // { x, y, userId, date, fromRoomId }

      const fileInputRef = useRef(null);

      const STORAGE_KEY_USERS = 'shortstay_users_v1';
      const STORAGE_KEY_ALLOCATIONS = 'shortstay_allocations_v1';
      const STORAGE_KEY_MEMOS = 'shortstay_memos_v1';
      const STORAGE_KEY_LAST_BACKUP = 'shortstay_last_backup';
      const STORAGE_KEY_ROOMS = 'shortstay_rooms_v1';
      const STORAGE_KEY_TEMP_ROOMS = 'shortstay_temp_rooms_v1';
      const STORAGE_KEY_MEAL_TICKETS = 'shortstay_meal_tickets_v1';
      const STORAGE_KEY_CUSTOM_ROWS = 'shortstay_custom_rows_v1';
      const STORAGE_KEY_CUSTOM_ROW_MEMOS = 'shortstay_custom_row_memos_v1';
      const STORAGE_KEY_STICKIES = 'shortstay_stickies_v1';

      // --- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–å±¤ï¼ˆFirebaseå¯¾å¿œç‰ˆï¼‰ ---
      // FirebaseãŒæœ‰åŠ¹ãªã‚‰Firebaseã‚’ä½¿ç”¨ã€ç„¡åŠ¹ãªã‚‰localStorageã‚’ä½¿ç”¨
      const db = {
        load: (key) => {
          try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : null;
          } catch (e) {
            console.error(`Load Error (${key}):`, e);
            return null;
          }
        },
        save: (key, data) => {
          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ä¿å­˜ã®ã¿ã«å½¹å‰²ã‚’å¤‰æ›´
          localStorage.setItem(key, JSON.stringify(data));
        },
        remove: (key) => {
          localStorage.removeItem(key);
          if (isFirebaseEnabled && database) {
            database.ref('data/' + key).remove().catch(e => console.error('Firebase remove error:', e));
          }
        }
      };

      useEffect(() => {
        const savedUsers = db.load(STORAGE_KEY_USERS);
        const savedAllocations = db.load(STORAGE_KEY_ALLOCATIONS);
        const savedMemos = db.load(STORAGE_KEY_MEMOS);

        if (savedUsers) {
          try {
            const migratedUsers = savedUsers.map(u => {
              // å¤ã„ãƒ‡ãƒ¼ã‚¿ã®äº’æ›æ€§å¯¾å¿œ
              const migrated = { ...u };
              if (!migrated.schedule) {
                migrated.schedule = calculateInitialSchedule(migrated.stayDates, migrated.bathType || '');
              }
              if (migrated.isArchived === undefined) {
                migrated.isArchived = false;
              }
              if (!migrated.createdAt) {
                migrated.createdAt = new Date().toISOString();
              }
              // fixedRoom â†’ fixedRooms ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
              if (migrated.fixedRooms === undefined) {
                migrated.fixedRooms = {};
                // å¤ã„fixedRoomãŒã‚ã‚Œã°ã€å…¨æœŸé–“ã«é©ç”¨
                if (migrated.fixedRoom) {
                  const periods = getStayPeriods(migrated.stayDates || []);
                  periods.forEach(period => {
                    const periodKey = `${period[0]}_${period[period.length - 1]}`;
                    migrated.fixedRooms[periodKey] = migrated.fixedRoom;
                  });
                }
                delete migrated.fixedRoom;
              }
              if (migrated.bathType === undefined) {
                migrated.bathType = '';
              }
              if (migrated.furigana === undefined) {
                migrated.furigana = '';
              }
              return migrated;
            });
            setUsers(migratedUsers);
          } catch (e) {
            console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            setUsers(generateSampleUsers(new Date()));
          }
        } else {
          setUsers(generateSampleUsers(new Date()));
        }

        if (savedAllocations) {
          try { setAllocations(savedAllocations); } catch (e) {
            console.error('å‰²ã‚Šå½“ã¦ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
          }
        }
        if (savedMemos) {
          try { setMemos(savedMemos); } catch (e) {
            console.error('ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
          }
        }
        
        // éƒ¨å±‹è¨­å®šã‚’èª­ã¿è¾¼ã¿
        const savedRooms = db.load(STORAGE_KEY_ROOMS);
        if (savedRooms) {
          try { setRooms(savedRooms); } catch (e) {
            console.error('éƒ¨å±‹ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
          }
        }
        
        // ç©ºåºŠåˆ©ç”¨éƒ¨å±‹ã‚’èª­ã¿è¾¼ã¿
        const savedTempRooms = db.load(STORAGE_KEY_TEMP_ROOMS);
        if (savedTempRooms) {
          try { setTempRooms(savedTempRooms); } catch (e) {
            console.error('ç©ºåºŠåˆ©ç”¨éƒ¨å±‹ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
          }
        }
        
        // é£Ÿäº‹ä¼ç¥¨ã‚’èª­ã¿è¾¼ã¿
        const savedMealTickets = db.load(STORAGE_KEY_MEAL_TICKETS);
        if (savedMealTickets) {
          try { setMealTickets(savedMealTickets); } catch (e) {
            console.error('é£Ÿäº‹ä¼ç¥¨ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
          }
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ è¡Œã‚’èª­ã¿è¾¼ã¿
        const savedCustomRows = db.load(STORAGE_KEY_CUSTOM_ROWS);
        if (savedCustomRows) {
          try { setCustomRows(savedCustomRows); } catch (e) {
            console.error('ã‚«ã‚¹ã‚¿ãƒ è¡Œã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
          }
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ è¡Œãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã¿
        const savedCustomRowMemos = db.load(STORAGE_KEY_CUSTOM_ROW_MEMOS);
        if (savedCustomRowMemos) {
          try { setCustomRowMemos(savedCustomRowMemos); } catch (e) {
            console.error('ã‚«ã‚¹ã‚¿ãƒ è¡Œãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
          }
        }

        // ä»˜ç®‹ã‚’èª­ã¿è¾¼ã¿
        const savedStickies = db.load(STORAGE_KEY_STICKIES);
        if (savedStickies) {
          try { setStickies(savedStickies); } catch (e) {
            console.error('ä»˜ç®‹ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
          }
        }
        
        // æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ—¥æ™‚ã‚’èª­ã¿è¾¼ã¿
        const savedLastBackup = localStorage.getItem(STORAGE_KEY_LAST_BACKUP); // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æƒ…å ±ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§OK
        if (savedLastBackup) {
          setLastBackup(new Date(savedLastBackup));
        }
        
        setIsLoaded(true);

        // Firebaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å„ªå…ˆã®ãŸã‚ç„¡åŠ¹åŒ–ï¼‰
        // â€»ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ä½œæ¥­ä¸­ã«ã€ã‚µãƒ¼ãƒãƒ¼å´ã®å¤ã„ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ã®ã‚’é˜²ããŸã‚
        // if (isFirebaseEnabled && database) {
        //   // ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
        //   const dataRef = database.ref('data');
        //   dataRef.on('value', (snap) => {
        //     const data = snap.val();
        //     if (data) {
        //       if (data[STORAGE_KEY_USERS]) setUsers(data[STORAGE_KEY_USERS]);
        //       if (data[STORAGE_KEY_ALLOCATIONS]) setAllocations(data[STORAGE_KEY_ALLOCATIONS]);
        //       if (data[STORAGE_KEY_MEMOS]) setMemos(data[STORAGE_KEY_MEMOS]);
        //       if (data[STORAGE_KEY_ROOMS]) setRooms(data[STORAGE_KEY_ROOMS]);
        //       if (data[STORAGE_KEY_TEMP_ROOMS]) setTempRooms(data[STORAGE_KEY_TEMP_ROOMS]);
        //       if (data[STORAGE_KEY_MEAL_TICKETS]) setMealTickets(data[STORAGE_KEY_MEAL_TICKETS]);
        //       if (data[STORAGE_KEY_CUSTOM_ROWS]) setCustomRows(data[STORAGE_KEY_CUSTOM_ROWS]);
        //       if (data[STORAGE_KEY_CUSTOM_ROW_MEMOS]) setCustomRowMemos(data[STORAGE_KEY_CUSTOM_ROW_MEMOS]);
        //       if (data[STORAGE_KEY_STICKIES]) setStickies(data[STORAGE_KEY_STICKIES]);
        //     }
        //   });

        //   // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        //   return () => {
        //     dataRef.off();
        //   };
        // }
      }, []);

      useEffect(() => {
        if (!isLoaded) return;
        // å¤‰æ›´ã‚’å¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰
        db.save(STORAGE_KEY_USERS, users);
      }, [users, isLoaded]);

      useEffect(() => {
        if (!isLoaded) return;
        // å¤‰æ›´ã‚’å¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰
        db.save(STORAGE_KEY_ALLOCATIONS, allocations);
      }, [allocations, isLoaded]);

      useEffect(() => {
        if (!isLoaded) return;
        // å¤‰æ›´ã‚’å¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰
        db.save(STORAGE_KEY_MEMOS, memos);
      }, [memos, isLoaded]);

      useEffect(() => {
        if (!isLoaded) return;
        // å¤‰æ›´ã‚’å¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰
        db.save(STORAGE_KEY_ROOMS, rooms);
      }, [rooms, isLoaded]);

      useEffect(() => {
        if (!isLoaded) return;
        // å¤‰æ›´ã‚’å¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰
        db.save(STORAGE_KEY_TEMP_ROOMS, tempRooms);
      }, [tempRooms, isLoaded]);

      useEffect(() => {
        if (!isLoaded) return;
        // å¤‰æ›´ã‚’å¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰
        db.save(STORAGE_KEY_MEAL_TICKETS, mealTickets);
      }, [mealTickets, isLoaded]);

      useEffect(() => {
        if (!isLoaded) return;
        // å¤‰æ›´ã‚’å¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰
        db.save(STORAGE_KEY_CUSTOM_ROWS, customRows);
      }, [customRows, isLoaded]);

      useEffect(() => {
        if (!isLoaded) return;
        // å¤‰æ›´ã‚’å¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰
        db.save(STORAGE_KEY_CUSTOM_ROW_MEMOS, customRowMemos);
      }, [customRowMemos, isLoaded]);

      useEffect(() => {
        if (!isLoaded) return;
        // å¤‰æ›´ã‚’å¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰
        db.save(STORAGE_KEY_STICKIES, stickies);
      }, [stickies, isLoaded]);

      // éƒ¨å±‹ã®ç‰¹å¾´ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const ROOM_FEATURES = [
        { key: 'near_toilet', label: 'ãƒˆã‚¤ãƒ¬è¿‘' },
        { key: 'for_high_fall_risk', label: 'è»¢å€’ãƒªã‚¹ã‚¯é«˜å‘ã‘' },
        { key: 'low_fall_risk', label: 'è»¢å€’ãƒªã‚¹ã‚¯ä½å‘ã‘' },
        { key: 'for_oxygen', label: 'åœ¨å®…é…¸ç´ æ¨å¥¨' },
        { key: 'for_new', label: 'æ–°è¦å‘ã‘' },
      ];

      const CONDITIONS = [
        { key: 'is_new', label: 'æ–°è¦åˆ©ç”¨è€…' },
        { key: 'near_toilet', label: 'ãƒˆã‚¤ãƒ¬è¿‘ã' },
        { key: 'high_fall_risk', label: 'è»¢å€’ãƒªã‚¹ã‚¯é«˜' },
        { key: 'low_fall_risk', label: 'è»¢å€’ãƒªã‚¹ã‚¯ä½' },
        { key: 'home_oxygen', label: 'åœ¨å®…é…¸ç´ ' },
      ];

      const daysInMonth = getDaysInMonth(currentMonth);
      const currentMonthDates = Array.from({ length: daysInMonth }, (_, i) => {
        return toDateStr(new Date(currentMonth.getFullYear(), currentMonth.getMonth(), i + 1));
      });

      // è¡¨ç¤ºç”¨ã®æ—¥ä»˜é…åˆ—ï¼ˆã‚«ã‚¹ã‚¿ãƒ æœŸé–“ã¾ãŸã¯monthå…¨ä½“ï¼‰
      const displayDates = React.useMemo(() => {
        if (useCustomRange && displayStartDate && displayEndDate) {
          const dates = [];
          let current = parseLocalDate(displayStartDate);
          const end = parseLocalDate(displayEndDate);
          while (current <= end) {
            dates.push(toDateStr(current));
            current = new Date(current.getFullYear(), current.getMonth(), current.getDate() + 1);
          }
          return dates;
        }
        return currentMonthDates;
      }, [useCustomRange, displayStartDate, displayEndDate, currentMonthDates]);

      // è¡¨ç¤ºæ—¥æ•°ã«å¿œã˜ãŸã‚»ãƒ«å¹…
      const cellWidth = React.useMemo(() => {
        const days = displayDates.length;
        if (days <= 3) return 'min-w-[150px]';
        if (days <= 7) return 'min-w-[100px]';
        if (days <= 14) return 'min-w-[70px]';
        return 'min-w-[48px]';
      }, [displayDates.length]);

      // å½“æœˆã®ç©ºåºŠåˆ©ç”¨éƒ¨å±‹ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const currentMonthTempRooms = React.useMemo(() => {
        const monthStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
        return tempRooms.filter(r => r.month === monthStr);
      }, [tempRooms, currentMonth]);

      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼šéƒ¨å±‹ã”ã¨ã®åˆ©ç”¨è€…ã®è‰²ï¼ˆ0:ãƒ”ãƒ³ã‚¯, 1:ã‚¹ã‚«ã‚¤ãƒ–ãƒ«ãƒ¼ï¼‰ã‚’äº‹å‰ã«ä¸€æ‹¬è¨ˆç®—
      const roomUserColors = React.useMemo(() => {
        const colorMap = {}; // ã‚­ãƒ¼: "roomId-userId", å€¤: colorIndex (0~3)
        if (currentMonthDates.length === 0) return {};

        rooms.forEach(room => {
            // ã“ã®éƒ¨å±‹ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®è‰²ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆæœŸé–“ä¸­ã¯åŒã˜è‰²ã‚’ç¶­æŒã™ã‚‹ãŸã‚ï¼‰
            const userColorCache = new Map(); 
            let lastDayLastColor = -1; // å‰æ—¥ã®æœ€å¾Œã®äººã®è‰²

            currentMonthDates.forEach(dateStr => {
                let cellUserIds = allocations[`${dateStr}-${room.id}`] || [];
                
                // ã€é‡è¦ã€‘æç”»æ™‚ã¨åŒã˜ãƒ«ãƒ¼ãƒ«ã§ã‚½ãƒ¼ãƒˆï¼ˆé€€æ‰€ã™ã‚‹äººãŒå…ˆï¼ä¸Šï¼‰
                // ã“ã‚Œã‚’ã—ãªã„ã¨ã€Œä¸Šã®äººã€ã®è‰²ãŒæ­£ã—ãåˆ¤å®šã§ããªã„
                cellUserIds = [...cellUserIds].sort((a, b) => {
                  const userA = users.find(u => u.id === a);
                  const userB = users.find(u => u.id === b);
                  if (!userA || !userB) return 0;
                  const aIsLeaving = !userA.stayDates.includes(getNextDay(dateStr));
                  const bIsLeaving = !userB.stayDates.includes(getNextDay(dateStr));
                  return (aIsLeaving === bIsLeaving) ? 0 : aIsLeaving ? -1 : 1;
                });

                // ã“ã®æ—¥ã®å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‰²ã‚’æ±ºå®š
                cellUserIds.forEach((userId, index) => {
                    // æ—¢ã«è‰²ãŒæ±ºã¾ã£ã¦ã„ã‚‹å ´åˆï¼ˆé€£æ³Šä¸­ï¼‰ã¯ãã‚Œã‚’ä½¿ã†
                    if (userColorCache.has(userId)) {
                        // ä½•ã‚‚ã—ãªã„
                    } else {
                        // æ–°ã—ãè‰²ã‚’æ±ºã‚ã‚‹ï¼ˆç™»å ´æ—¥ï¼‰
                        const usedColors = new Set();

                        // 1. åŒã˜æ—¥ã®è‡ªåˆ†ã‚ˆã‚Šä¸Šã«ã„ã‚‹å…¨å“¡ã®è‰²ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
                        for (let i = 0; i < index; i++) {
                            const upperUserId = cellUserIds[i];
                            if (userColorCache.has(upperUserId)) {
                                usedColors.add(userColorCache.get(upperUserId));
                            }
                        }

                        // 2. å‰æ—¥ã‹ã‚‰é€£æ³Šã—ã¦ã„ã‚‹äººï¼ˆä»Šæ—¥ã‚‚ã“ã®ã‚»ãƒ«ã«ã„ã‚‹äººï¼‰ã®è‰²ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
                        cellUserIds.forEach(uid => {
                            if (uid !== userId && userColorCache.has(uid)) {
                                usedColors.add(userColorCache.get(uid));
                            }
                        });

                        // 3. å‰æ—¥ã®æœ€å¾Œã®äººã®è‰²ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆç¾çŠ¶ç¶­æŒï¼‰
                        if (lastDayLastColor !== -1) {
                            usedColors.add(lastDayLastColor);
                        }

                        // ç©ºã„ã¦ã„ã‚‹æœ€å°ã®è‰²ç•ªå·(0~3)ã‚’æ¢ã™
                        let newColor = 0;
                        while (usedColors.has(newColor)) {
                            newColor++;
                        }
                        // 4è‰²ã§å¾ªç’°ã•ã›ã‚‹
                        const finalColor = newColor % 4;
                        
                        userColorCache.set(userId, finalColor);
                    }
                });

                // æ¬¡ã®æ—¥ã®ãŸã‚ã«ã€ã“ã®æ—¥ã®æœ€å¾Œã®äººã®è‰²ã‚’è¨˜éŒ²
                if (cellUserIds.length > 0) {
                    const lastUserId = cellUserIds[cellUserIds.length - 1];
                    lastDayLastColor = userColorCache.get(lastUserId);
                } else {
                    lastDayLastColor = -1; // èª°ã‚‚ã„ãªã‘ã‚Œã°ãƒªã‚»ãƒƒãƒˆ
                }
            });

            // çµæœã‚’ãƒãƒƒãƒ—ã«ä¿å­˜
            userColorCache.forEach((color, userId) => {
                colorMap[`${room.id}-${userId}`] = color;
            });
        });

        return colorMap;
      }, [allocations, rooms, currentMonthDates, users]);

      // --- ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ---
      // --- PDFç”Ÿæˆï¼ˆé£Ÿäº‹ä¼ç¥¨ï¼‰ ---
      const generateMealTicketPDF = (ticket) => {
        const user = users.find(u => u.id === ticket.userId);
        if (!user) {
          alert('åˆ©ç”¨è€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          const d = parseLocalDate(dateStr);
          const reiwa = d.getFullYear() - 2018;
          return `ä»¤å’Œ${reiwa}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
        };
        
        // ç”Ÿå¹´æœˆæ—¥ã‹ã‚‰å’Œæš¦ã¨å¹´é½¢ã‚’è¨ˆç®—
        const formatBirthDate = (dateStr) => {
          if (!dateStr) return { warekiStr: '', age: '' };
          const d = parseLocalDate(dateStr);
          const year = d.getFullYear();
          let era = '';
          let eraYear = 0;
          if (year >= 2019) { era = 'ä»¤å’Œ'; eraYear = year - 2018; }
          else if (year >= 1989) { era = 'å¹³æˆ'; eraYear = year - 1988; }
          else if (year >= 1926) { era = 'æ˜­å’Œ'; eraYear = year - 1925; }
          else { era = 'å¤§æ­£'; eraYear = year - 1911; }
          const warekiStr = `${era}${eraYear}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
          
          // å¹´é½¢è¨ˆç®—
          const today = new Date();
          let age = today.getFullYear() - d.getFullYear();
          const m = today.getMonth() - d.getMonth();
          if (m < 0 || (m === 0 && today.getDate() < d.getDate())) age--;
          
          return { warekiStr, age };
        };
        
        const birthInfo = formatBirthDate(user.birthDate);
        const genderMark = user.gender === 'male' ? 'â—‹' : '';
        const genderMarkF = user.gender === 'female' ? 'â—‹' : '';
        
        // ãƒ©ãƒ™ãƒ«å–å¾—é–¢æ•°
        const getLabel = (arr, key) => arr.find(a => a.key === key)?.label || '';
        
        // HTMLã§PDFã‚’ç”Ÿæˆ
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>é£Ÿäº‹æŒ‡ç¤ºç®‹ - ${user.name}</title>
            <style>
              @page { size: A4; margin: 10mm; }
              * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
              body { font-family: "Yu Gothic", "æ¸¸ã‚´ã‚·ãƒƒã‚¯", sans-serif; font-size: 11px; margin: 0; padding: 15px; }
              h1 { text-align: center; font-size: 18px; margin-bottom: 5px; }
              .header-container { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
              .stamp-area { display: flex; gap: 5px; }
              .stamp-box { width: 50px; height: 50px; border: 1px solid #333; text-align: center; font-size: 9px; }
              .stamp-box .label { border-bottom: 1px solid #333; padding: 2px; background: #f0f0f0; }
              .stamp-box .space { height: 35px; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
              th, td { border: 1px solid #333; padding: 6px 8px; text-align: left; height: 24px; }
              th { background-color: #f0f0f0; font-weight: bold; width: 70px; }
              .checkbox { display: inline-block; width: 12px; height: 12px; border: 2px solid #333; margin-right: 3px; vertical-align: middle; position: relative; top: -1px; }
              .checked { background-color: #000 !important; }
              .option-item { display: inline-block; margin-right: 12px; white-space: nowrap; font-size: 10px; line-height: 16px; vertical-align: middle; }
              .memo-cell { height: 72px; vertical-align: top; }
            </style>
          </head>
          <body>
            <div class="header-container">
              <div></div>
              <h1 style="flex-grow: 1;">ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ã€€é£Ÿäº‹æŒ‡ç¤ºç®‹</h1>
              <div class="stamp-area">
                <div class="stamp-box"><div class="label">åŒ»å¸«</div><div class="space"></div></div>
                <div class="stamp-box"><div class="label">æ „é¤Šèª²</div><div class="space"></div></div>
                <div class="stamp-box"><div class="label">è¨˜å…¥è€…</div><div class="space"></div></div>
              </div>
            </div>
            
            <table>
              <tr>
                <th>ãƒ•ãƒªã‚¬ãƒŠ</th>
                <td colspan="5">${user.furigana || ''}</td>
              </tr>
              <tr>
                <th>æ°å</th>
                <td colspan="5" style="font-size: 14px; font-weight: bold;">${user.name}</td>
              </tr>
              <tr>
                <th>æ€§åˆ¥</th>
                <td>${genderMark}ç”·ã€€ãƒ»ã€€${genderMarkF}å¥³</td>
                <th>ç”Ÿå¹´æœˆæ—¥</th>
                <td>${birthInfo.warekiStr}</td>
                <th>å¹´é½¢</th>
                <td>${birthInfo.age}æ­³</td>
              </tr>
              <tr>
                <th>ãƒ¦ãƒ‹ãƒƒãƒˆ</th>
                <td colspan="5">${ticket.unit || ''}</td>
              </tr>
            </table>
            
            <table>
              <tr>
                <th>åŒºåˆ†</th>
                <td colspan="5">
                  <span class="option-item"><span class="checkbox ${ticket.category === 'start' ? 'checked' : ''}"></span>é–‹å§‹</span>
                  <span class="option-item"><span class="checkbox ${ticket.category === 'change' ? 'checked' : ''}"></span>å¤‰æ›´</span>
                  <span class="option-item"><span class="checkbox ${ticket.category === 'stop' ? 'checked' : ''}"></span>ä¸­æ­¢</span>
                </td>
              </tr>
              <tr>
                <th>ç†ç”±</th>
                <td colspan="5">
                  ${MEAL_REASON.map((r, i) => `
                    <span class="option-item"><span class="checkbox ${ticket.reason === r.key ? 'checked' : ''}"></span>${r.label}</span>
                    ${i === 3 ? '<br>' : ''}
                  `).join('')}
                </td>
              </tr>
            </table>
            
            <table>
              <tr>
                <th>é–‹å§‹æ—¥</th>
                <td colspan="5">${formatDate(ticket.startDate)}ã€€${getLabel(MEAL_TIMING, ticket.startMeal)}ã€€ã‹ã‚‰</td>
              </tr>
              <tr>
                <th>çµ‚äº†æ—¥</th>
                <td colspan="5">${formatDate(ticket.endDate)}ã€€${getLabel(MEAL_TIMING, ticket.endMeal)}ã€€ã¾ã§</td>
              </tr>
            </table>
            
            <table>
              <tr>
                <th>é£Ÿç¨®</th>
                <td colspan="5">
                  ${MEAL_FOOD_TYPES.map(f => `
                    <span class="option-item"><span class="checkbox ${ticket.foodType === f.key ? 'checked' : ''}"></span>${f.label}${f.key === 'diabetes' && ticket.foodType === 'diabetes' ? `(${ticket.diabetesKcal || 'ã€€'}kcal)` : ''}</span>
                  `).join('')}
                </td>
              </tr>
              <tr>
                <th>ä¸»é£Ÿ</th>
                <td colspan="5">
                  ${MEAL_MAIN_DISH.map(m => `
                    <span class="option-item"><span class="checkbox ${ticket.mainDish === m.key ? 'checked' : ''}"></span>${m.label}${m.key === 'other' && ticket.mainDish === 'other' ? `(${ticket.mainDishOther || ''})` : ''}</span>
                  `).join('')}
                </td>
              </tr>
              <tr>
                <th>å‰¯é£Ÿ</th>
                <td colspan="5">
                  ${MEAL_SIDE_DISH.map(s => `
                    <span class="option-item"><span class="checkbox ${ticket.sideDish === s.key ? 'checked' : ''}"></span>${s.label}${s.key === 'other' && ticket.sideDish === 'other' ? `(${ticket.sideDishOther || ''})` : ''}</span>
                  `).join('')}
                </td>
              </tr>
              <tr>
                <th>é£²ã¿ç‰©</th>
                <td colspan="5">
                  ${MEAL_DRINK.map(d => `
                    <span class="option-item"><span class="checkbox ${ticket.drink === d.key ? 'checked' : ''}"></span>${d.label}</span>
                  `).join('')}
                </td>
              </tr>
              <tr>
                <th>é–“é£Ÿ</th>
                <td colspan="5">
                  ${MEAL_SNACK.map(s => `
                    <span class="option-item"><span class="checkbox ${ticket.snack === s.key ? 'checked' : ''}"></span>${s.label}</span>
                  `).join('')}
                </td>
              </tr>
              <tr>
                <th>ãƒ¡ãƒ¢</th>
                <td colspan="5" class="memo-cell">${ticket.memo || ''}</td>
              </tr>
            </table>
            
            <scr` + `ipt>
              window.onload = function() {
                window.print();
              }
            </scr` + `ipt>
          </body>
          </html>
        `);
        printWindow.document.close();
      };

      const exportData = () => {
        const data = {
          version: '1.0',
          exportedAt: new Date().toISOString(),
          users,
          allocations,
          memos,
          rooms,
          tempRooms,
          mealTickets,
          stickies
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `shortstay-backup-${toDateStr(new Date())}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ—¥æ™‚ã‚’ä¿å­˜
        const now = new Date();
        localStorage.setItem(STORAGE_KEY_LAST_BACKUP, now.toISOString());
        setLastBackup(now);
      };

      // --- å¹´åº¦åˆ¥ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ©Ÿèƒ½ ---
      const getDataYears = () => {
        const years = new Set();
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ©ç”¨æ—¥ã‹ã‚‰ã‹ã‚‰å¹´ã‚’æŠ½å‡º
        users.forEach(user => {
          user.stayDates.forEach(date => {
            years.add(date.substring(0, 4));
          });
        });
        
        // allocationsã‹ã‚‰å¹´ã‚’æŠ½å‡º
        Object.keys(allocations).forEach(key => {
          const year = key.substring(0, 4);
          if (year.match(/^\d{4}$/)) {
            years.add(year);
          }
        });
        
        // memosã‹ã‚‰å¹´ã‚’æŠ½å‡º
        Object.keys(memos).forEach(key => {
          const year = key.substring(0, 4);
          if (year.match(/^\d{4}$/)) {
            years.add(year);
          }
        });
        
        return Array.from(years).sort();
      };

      const calculateArchiveStats = (year) => {
        // è©²å½“å¹´ã®ãƒ‡ãƒ¼ã‚¿æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        let stayDateCount = 0;
        let allocationCount = 0;
        let memoCount = 0;
        let affectedUsers = new Set();
        
        users.forEach(user => {
          const yearDates = user.stayDates.filter(d => d.startsWith(year));
          if (yearDates.length > 0) {
            stayDateCount += yearDates.length;
            affectedUsers.add(user.id);
          }
        });
        
        Object.keys(allocations).forEach(key => {
          if (key.startsWith(year)) allocationCount++;
        });
        
        Object.keys(memos).forEach(key => {
          if (key.startsWith(year)) memoCount++;
        });
        
        return {
          stayDateCount,
          allocationCount,
          memoCount,
          userCount: affectedUsers.size
        };
      };

      const exportYearData = (year) => {
        // è©²å½“å¹´ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’æŠ½å‡ºã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        const yearUsers = users.map(user => ({
          ...user,
          stayDates: user.stayDates.filter(d => d.startsWith(year)),
          schedule: Object.fromEntries(
            Object.entries(user.schedule || {}).filter(([key]) => key.startsWith(year))
          )
        })).filter(u => u.stayDates.length > 0);

        const yearAllocations = Object.fromEntries(
          Object.entries(allocations).filter(([key]) => key.startsWith(year))
        );

        const yearMemos = Object.fromEntries(
          Object.entries(memos).filter(([key]) => key.startsWith(year))
        );

        const data = {
          version: '1.0',
          archiveYear: year,
          exportedAt: new Date().toISOString(),
          users: yearUsers,
          allocations: yearAllocations,
          memos: yearMemos
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `shortstay-archive-${year}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const deleteYearData = (year) => {
        // è©²å½“å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        setUsers(prevUsers => prevUsers.map(user => ({
          ...user,
          stayDates: user.stayDates.filter(d => !d.startsWith(year)),
          schedule: Object.fromEntries(
            Object.entries(user.schedule || {}).filter(([key]) => !key.startsWith(year))
          )
        })));

        setAllocations(prev => Object.fromEntries(
          Object.entries(prev).filter(([key]) => !key.startsWith(year))
        ));

        setMemos(prev => Object.fromEntries(
          Object.entries(prev).filter(([key]) => !key.startsWith(year))
        ));
      };

      const executeArchive = (year) => {
        // 1. ã¾ãšè©²å½“å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        exportYearData(year);
        
        // 2. ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        deleteYearData(year);
        
        // 3. çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        setArchiveYear('');
        setShowArchiveConfirm(false);
        setArchiveStats(null);
        setSettingsSuccess(`${year}å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸ`);
      };

      // --- ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ---
      const importData = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (data.users && data.allocations) {
              if (window.confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) {
                saveHistory();
                setUsers(data.users);
                setAllocations(data.allocations);
                setMemos(data.memos || {});
                if (data.rooms) setRooms(data.rooms);
                if (data.tempRooms) setTempRooms(data.tempRooms);
                if (data.mealTickets) setMealTickets(data.mealTickets);
                if (data.stickies) setStickies(data.stickies);
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
              }
            } else {
              alert('ç„¡åŠ¹ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
            }
          } catch (err) {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      };

      // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— ãƒãƒ³ãƒ‰ãƒ© ---
      const handleDragStart = (e, userId, date, type) => {
        setDragItem({ userId, date, type });
        e.dataTransfer.effectAllowed = 'move';
        e.target.classList.add('dragging');
      };

      const handleDragEnd = (e) => {
        e.target.classList.remove('dragging');
        setDragItem(null);
        setDragOverTarget(null);
      };

      const handleDragOver = (e, userId, date) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        if (dragItem && dragItem.userId === userId) {
          const target = `${userId}-${date}`;
          if (dragOverTarget !== target) {
            setDragOverTarget(target);
          }
        }
      };

      const handleDragLeave = (e) => {
        setDragOverTarget(null);
      };

      // --- åˆ©ç”¨è€…ã®éƒ¨å±‹ç§»å‹•ç”¨ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ---
      const handleUserDragStart = (e, userId, date, roomId) => {
        e.stopPropagation();
        setDragUser({ userId, date, fromRoomId: roomId });
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', `user-${userId}`);
      };

      const handleUserDragEnd = (e) => {
        setDragUser(null);
        setDragOverRoom(null);
      };

      // å³ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
      const handleContextMenu = (e, userId, date, fromRoomId) => {
        e.preventDefault();
        setContextMenu({ x: e.clientX, y: e.clientY, userId, date, fromRoomId });
      };

      // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const closeContextMenu = () => {
        setContextMenu(null);
      };

      // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰éƒ¨å±‹ã‚’é¸æŠã—ã¦ç§»å‹•
      const handleMoveToRoom = (targetRoomId) => {
        if (!contextMenu) return;
        const { userId, date, fromRoomId } = contextMenu;
        
        if (fromRoomId === targetRoomId) {
          closeContextMenu();
          return;
        }
        
        const user = users.find(u => u.id === userId);
        if (!user) {
          closeContextMenu();
          return;
        }

        const periods = getStayPeriods(user.stayDates);
        const currentPeriod = periods.find(p => p.includes(date));
        if (!currentPeriod) {
          closeContextMenu();
          return;
        }

        const targetDisplayName = targetRoomId === TEMP_ROOM_1_ID ? 'ä¸€æ™‚ä¿ç®¡â‘ ' :
                                  targetRoomId === TEMP_ROOM_2_ID ? 'ä¸€æ™‚ä¿ç®¡â‘¡' :
                                  targetRoomId.startsWith(TEMP_ROOM_PREFIX) ? (tempRooms.find(r => r.id === targetRoomId)?.name || 'ç©ºåºŠ') :
                                  `${targetRoomId}å·å®¤`;
        const moveChoice = window.confirm(
          `${user.name}ã‚’${targetDisplayName}ã«ç§»å‹•ã—ã¾ã™ã€‚\n\n` +
          `ã€OKã€‘ã“ã®åˆ©ç”¨æœŸé–“å…¨ä½“ï¼ˆ${currentPeriod[0]}ã€œ${currentPeriod[currentPeriod.length-1]}ï¼‰ã‚’ç§»å‹•\n` +
          `ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‘${date}ã®ã¿ç§»å‹•`
        );

        const datesToMove = moveChoice ? currentPeriod : [date];
        
        // ä¸€æ™‚ä¿ç®¡ä»¥å¤–ã¸ã®ç§»å‹•ã¯é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if (!targetRoomId.startsWith('TEMP')) { // 'TEMP'ã§å§‹ã¾ã‚‹IDã¯ã™ã¹ã¦ä¸€æ™‚ä¿ç®¡ç³»ã¨ã¿ãªã™
          let hasConflict = false;
          let conflictDates = [];
          
          for (const moveDate of datesToMove) {
            const targetKey = `${moveDate}-${targetRoomId}`;
            const targetOccupants = allocations[targetKey] || [];
            const otherOccupants = targetOccupants.filter(id => id !== userId);
            
            if (otherOccupants.length >= 2) {
              alert(`${moveDate}ã¯${targetDisplayName}ãŒæº€å®¤ã®ãŸã‚ç§»å‹•ã§ãã¾ã›ã‚“`);
              closeContextMenu();
              return;
            }

            if (otherOccupants.length === 1) {
              const existingUserId = otherOccupants[0];
              const existingUser = users.find(u => u.id === existingUserId);
              if (existingUser) {
                const existingIsCheckIn = !existingUser.stayDates.includes(getPrevDay(moveDate));
                const existingIsCheckOut = !existingUser.stayDates.includes(getNextDay(moveDate));
                const movingIsCheckIn = !user.stayDates.includes(getPrevDay(moveDate));
                const movingIsCheckOut = !user.stayDates.includes(getNextDay(moveDate));
                const canShare = (existingIsCheckOut && movingIsCheckIn) || (existingIsCheckIn && movingIsCheckOut);
                if (!canShare) {
                  hasConflict = true;
                  conflictDates.push(`${moveDate}ï¼ˆ${existingUser.name}ã¨é‡è¤‡ï¼‰`);
                }
              }
            }
          }
          
          if (hasConflict) {
            const confirmMove = window.confirm(
              `ä»¥ä¸‹ã®æ—¥ç¨‹ã§ä»–ã®åˆ©ç”¨è€…ã¨é‡è¤‡ã—ã¾ã™ï¼š\n\n${conflictDates.join('\n')}\n\n` +
              `ãã‚Œã§ã‚‚${targetDisplayName}ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ`
            );
            if (!confirmMove) {
              closeContextMenu();
              return;
            }
          }
        }

        saveHistory();

        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°ï¼ˆå³æ™‚åæ˜ ï¼‰
        const newAllocations = { ...allocations };
        datesToMove.forEach(moveDate => {
          const fromKey = `${moveDate}-${fromRoomId}`;
          if (newAllocations[fromKey]) {
            newAllocations[fromKey] = newAllocations[fromKey].filter(id => id !== userId);
            if (newAllocations[fromKey].length === 0) {
              delete newAllocations[fromKey];
            }
          }
          const targetKey = `${moveDate}-${targetRoomId}`;
          const currentTarget = newAllocations[targetKey] || [];
          if (!currentTarget.includes(userId)) {
            newAllocations[targetKey] = [...currentTarget, userId];
          }
        });
        setAllocations(newAllocations);

        if (isFirebaseEnabled && database) {
          // Firebaseãƒ¢ãƒ¼ãƒ‰ï¼šãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®‰å…¨ã«allocationsã‚’æ›´æ–°
          const allocationsRef = database.ref('data/' + STORAGE_KEY_ALLOCATIONS);
          allocationsRef.transaction(currentAllocations => {
            if (!currentAllocations) currentAllocations = {};
            datesToMove.forEach(moveDate => {
              const fromKey = `${moveDate}-${fromRoomId}`;
              if (currentAllocations[fromKey]) {
                currentAllocations[fromKey] = currentAllocations[fromKey].filter(id => id !== userId);
                if (currentAllocations[fromKey].length === 0) {
                  delete currentAllocations[fromKey];
                }
              }
              const targetKey = `${moveDate}-${targetRoomId}`;
              const currentTarget = currentAllocations[targetKey] || [];
              if (!currentTarget.includes(userId)) {
                currentAllocations[targetKey] = [...currentTarget, userId];
              }
            });
            return currentAllocations;
          });
        }
        closeContextMenu();
      };

      const handleRoomDragOver = (e, date, roomId) => {
        e.preventDefault();
        if (dragUser) {
          // åŒã˜æ—¥ä»˜ã¸ã®ãƒ‰ãƒ©ãƒƒã‚°ã®ã¿ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          if (dragUser.date === date) {
            e.dataTransfer.dropEffect = 'move';
            const target = `${date}-${roomId}`;
            if (dragOverRoom !== target) {
              setDragOverRoom(target);
            }
          }
        }
      };

      const handleRoomDragLeave = (e) => {
        setDragOverRoom(null);
      };

      const handleRoomDrop = (e, date, roomId) => {
        e.preventDefault();
        setDragOverRoom(null);
        
        if (!dragUser || dragUser.date !== date) return;
        if (dragUser.fromRoomId === roomId) return;

        const { userId, fromRoomId } = dragUser;
        const user = users.find(u => u.id === userId);
        if (!user) return;

        // ä¸€æ™‚ä¿ç®¡éƒ¨å±‹ã®å ´åˆã¯è¡¨ç¤ºåã‚’å¤‰æ›´
        const roomDisplayName = roomId === TEMP_ROOM_1_ID ? 'ä¸€æ™‚ä¿ç®¡â‘ ' :
                                roomId === TEMP_ROOM_2_ID ? 'ä¸€æ™‚ä¿ç®¡â‘¡' :
                                roomId.startsWith(TEMP_ROOM_PREFIX) ? (tempRooms.find(r => r.id === roomId)?.name || 'ç©ºåºŠ') :
                                `${roomId}å·å®¤`;

        // ç¾åœ¨ã®åˆ©ç”¨æœŸé–“ã‚’ç‰¹å®š
        const periods = getStayPeriods(user.stayDates);
        const currentPeriod = periods.find(p => p.includes(date));
        if (!currentPeriod) return;

        // ç§»å‹•æ–¹æ³•ã‚’é¸æŠ
        const moveChoice = window.confirm(
          `${user.name}ã®å±…å®¤ã‚’${roomDisplayName}ã«å¤‰æ›´ã—ã¾ã™ã€‚\n\n` +
          `ã€OKã€‘ã“ã®åˆ©ç”¨æœŸé–“å…¨ä½“ï¼ˆ${currentPeriod[0]}ã€œ${currentPeriod[currentPeriod.length-1]}ï¼‰ã‚’ç§»å‹•\n` +
          `ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‘${date}ã®ã¿ç§»å‹•`
        );

        const datesToMove = moveChoice ? currentPeriod : [date];

        // ä¸€æ™‚ä¿ç®¡éƒ¨å±‹ã¸ã®ç§»å‹•ã¯åˆ¶é™ãªã—
        if (!roomId.startsWith('TEMP')) { // 'TEMP'ã§å§‹ã¾ã‚‹IDã¯ã™ã¹ã¦ä¸€æ™‚ä¿ç®¡ç³»ã¨ã¿ãªã™
          // ç§»å‹•å…ˆã®éƒ¨å±‹ã®ç©ºãçŠ¶æ³ã‚’ç¢ºèª
          let hasConflict = false;
          let conflictDates = [];
          
          for (const moveDate of datesToMove) {
            const targetKey = `${moveDate}-${roomId}`;
            const targetOccupants = allocations[targetKey] || [];
            
            // è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
            const otherOccupants = targetOccupants.filter(id => id !== userId);
            
            if (otherOccupants.length >= 2) {
              alert(`${moveDate}ã¯${roomDisplayName}ãŒæº€å®¤ï¼ˆ3äººä»¥ä¸Šï¼‰ã®ãŸã‚ç§»å‹•ã§ãã¾ã›ã‚“`);
              setDragUser(null);
              return;
            }

            // 1äººã„ã‚‹å ´åˆã€å…¥é€€æ‰€æ—¥ã®ç›¸æ€§ãƒã‚§ãƒƒã‚¯
            if (otherOccupants.length === 1) {
              const existingUserId = otherOccupants[0];
              const existingUser = users.find(u => u.id === existingUserId);
              if (existingUser) {
                const existingIsCheckIn = !existingUser.stayDates.includes(getPrevDay(moveDate));
                const existingIsCheckOut = !existingUser.stayDates.includes(getNextDay(moveDate));
                const movingIsCheckIn = !user.stayDates.includes(getPrevDay(moveDate));
                const movingIsCheckOut = !user.stayDates.includes(getNextDay(moveDate));
                const canShare = (existingIsCheckOut && movingIsCheckIn) || (existingIsCheckIn && movingIsCheckOut);
                if (!canShare) {
                  hasConflict = true;
                  conflictDates.push(`${moveDate}ï¼ˆ${existingUser.name}ã¨é‡è¤‡ï¼‰`);
                }
              }
            }
          }
          
          // é‡è¤‡ãŒã‚ã‚‹å ´åˆã¯è­¦å‘Šã‚’å‡ºã—ã¦ç¢ºèª
          if (hasConflict) {
            const confirmMove = window.confirm(
              `ä»¥ä¸‹ã®æ—¥ç¨‹ã§ä»–ã®åˆ©ç”¨è€…ã¨é‡è¤‡ã—ã¾ã™ï¼š\n\n${conflictDates.join('\n')}\n\n` +
              `ãã‚Œã§ã‚‚${roomDisplayName}ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆåŒæ—¥IN/OUTã§ã¯ãªã„é‡è¤‡ãŒç™ºç”Ÿã—ã¾ã™ï¼‰`
            );
            if (!confirmMove) {
              setDragUser(null);
              return;
            }
          }
        }

        saveHistory();

        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°ï¼ˆå³æ™‚åæ˜ ï¼‰
        const newAllocations = { ...allocations };
        datesToMove.forEach(moveDate => {
          const fromKey = `${moveDate}-${fromRoomId}`;
          if (newAllocations[fromKey]) {
            newAllocations[fromKey] = newAllocations[fromKey].filter(id => id !== userId);
            if (newAllocations[fromKey].length === 0) {
              delete newAllocations[fromKey];
            }
          }
          const targetKey = `${moveDate}-${roomId}`;
          const currentTarget = newAllocations[targetKey] || [];
          if (!currentTarget.includes(userId)) {
            newAllocations[targetKey] = [...currentTarget, userId];
          }
        });
        setAllocations(newAllocations);

        if (isFirebaseEnabled && database) {
          // Firebaseãƒ¢ãƒ¼ãƒ‰ï¼šãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®‰å…¨ã«allocationsã‚’æ›´æ–°
          const allocationsRef = database.ref('data/' + STORAGE_KEY_ALLOCATIONS);
          allocationsRef.transaction(currentAllocations => {
            if (currentAllocations === null) {
              currentAllocations = {};
            }
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿(currentAllocations)ã«å¯¾ã—ã¦ç§»å‹•å‡¦ç†ã‚’è¡Œã†
            datesToMove.forEach(moveDate => {
              // å…ƒã®éƒ¨å±‹ã‹ã‚‰å‰Šé™¤
              const fromKey = `${moveDate}-${fromRoomId}`;
              if (currentAllocations[fromKey]) {
                currentAllocations[fromKey] = currentAllocations[fromKey].filter(id => id !== userId);
                if (currentAllocations[fromKey].length === 0) {
                  delete currentAllocations[fromKey];
                }
              }
              // æ–°ã—ã„éƒ¨å±‹ã«è¿½åŠ 
              const targetKey = `${moveDate}-${roomId}`;
              const currentTarget = currentAllocations[targetKey] || [];
              if (!currentTarget.includes(userId)) {
                currentAllocations[targetKey] = [...currentTarget, userId];
              }
            });
            return currentAllocations; // æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
          });
        }
        setDragUser(null);
      };

      const handleDrop = (e, targetUserId, targetDate) => {
        e.preventDefault();
        setDragOverTarget(null);
        
        if (!dragItem) return;
        if (dragItem.userId !== targetUserId) return;
        if (dragItem.date === targetDate) return;

        saveHistory();

        const targetUserIndex = users.findIndex(u => u.id === targetUserId);
        if (targetUserIndex === -1) return;
        
        const targetUser = users[targetUserIndex];
        if (!targetUser.stayDates.includes(targetDate)) return;

        const newUsers = [...users];
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¤‡è£½ã—ã¦ç›´æ¥å¤‰æ›´ã‚’é˜²ã
        newUsers[targetUserIndex] = { ...newUsers[targetUserIndex] };
        const user = newUsers[targetUserIndex];
        const newSchedule = { ...user.schedule };
        
        if (newSchedule[dragItem.date]) {
          const sourceDay = { ...newSchedule[dragItem.date] };
          if (dragItem.type === 'bath' || dragItem.type === 'mustBath') {
            sourceDay.bath = false;
            sourceDay.mustBath = false;
          } else if (dragItem.type === 'linen') {
            sourceDay.linen = false;
          }
          newSchedule[dragItem.date] = sourceDay;
        }

        const targetDay = newSchedule[targetDate] ? { ...newSchedule[targetDate] } : { bath: false, mustBath: false, linen: false };
        if (dragItem.type === 'bath') {
          targetDay.bath = true;
        } else if (dragItem.type === 'mustBath') {
          targetDay.bath = true;
          targetDay.mustBath = true;
        } else if (dragItem.type === 'linen') {
          targetDay.linen = true;
        }
        newSchedule[targetDate] = targetDay;

        user.schedule = newSchedule;
        
        setUsers(newUsers); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°

        if (isFirebaseEnabled && database) {
          database.ref('data/' + STORAGE_KEY_USERS).set(newUsers);
        }
        setDragItem(null);
      };

      // --- å˜ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªå‹•å‰²ã‚ŠæŒ¯ã‚Šï¼ˆè¿½åŠ ãƒ»æ›´æ–°æ™‚ç”¨ï¼‰ ---
      const allocateSingleUser = (user, existingAllocations = allocations, allUsers = users) => {
        const newAllocations = { ...existingAllocations };
        
        // ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¢å­˜å‰²ã‚Šå½“ã¦ã‚’å‰Šé™¤
        Object.keys(newAllocations).forEach(key => {
          if (newAllocations[key] && newAllocations[key].includes(user.id)) {
            newAllocations[key] = newAllocations[key].filter(id => id !== user.id);
            if (newAllocations[key].length === 0) {
              delete newAllocations[key];
            }
          }
        });

        // é€£ç¶šã—ãŸåˆ©ç”¨æœŸé–“ã”ã¨ã«éƒ¨å±‹ã‚’å‰²ã‚Šå½“ã¦
        const periods = getStayPeriods(user.stayDates);
        
        periods.forEach(period => {
          const periodKey = `${period[0]}_${period[period.length - 1]}`;
          const fixedRoomForPeriod = user.fixedRooms && user.fixedRooms[periodKey];
          
          // ã“ã®æœŸé–“ãŒéƒ¨å±‹å›ºå®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
          if (fixedRoomForPeriod) {
            period.forEach(dateStr => {
              const key = `${dateStr}-${fixedRoomForPeriod}`;
                const current = newAllocations[key] || [];
                if (!current.includes(user.id)) {
                  newAllocations[key] = [...current, user.id];
                }
            });
            return; // æ¬¡ã®æœŸé–“ã¸
          }
          
          // å›ºå®šã•ã‚Œã¦ã„ãªã„æœŸé–“ã¯è‡ªå‹•å‰²ã‚Šå½“ã¦
          let bestRoom = null;
          let bestScore = -9999;

          rooms.forEach(room => {
            // ã“ã®æœŸé–“å…¨ä½“ã§ä½¿ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
            let canUsePeriod = true;

            for (const dateStr of period) {
              const key = `${dateStr}-${room.id}`;
              const currentOccupants = newAllocations[key] || [];
              
              if (currentOccupants.length >= 2) {
                canUsePeriod = false;
                break;
              }
              
              if (currentOccupants.length === 1) {
                const existingUserId = currentOccupants[0];
                const existingUser = allUsers.find(u => u.id === existingUserId);
                if (existingUser) {
                  const isCheckIn = !user.stayDates.includes(getPrevDay(dateStr));
                  const isCheckOut = !user.stayDates.includes(getNextDay(dateStr));
                  const existingIsCheckIn = !existingUser.stayDates.includes(getPrevDay(dateStr));
                  const existingIsCheckOut = !existingUser.stayDates.includes(getNextDay(dateStr));
                  const canShare = (existingIsCheckOut && isCheckIn) || (existingIsCheckIn && isCheckOut);
                  if (!canShare) {
                    canUsePeriod = false;
                    break;
                  }
                }
              }
            }

            if (!canUsePeriod) return;

            // ã‚¹ã‚³ã‚¢è¨ˆç®—
            let score = 0;
            
            if (user.conditions.includes('home_oxygen')) {
              if (room.features.includes('for_oxygen')) score += 1000; else score -= 500;
            } else {
              if (room.features.includes('for_oxygen')) score -= 20;
            }
            if (user.conditions.includes('high_fall_risk')) {
              if (room.features.includes('for_high_fall_risk')) score += 150;
              if (room.features.includes('near_toilet')) score += 80;
              if (room.features.includes('low_fall_risk')) score -= 50;
            }
            if (user.conditions.includes('is_new')) {
              if (room.features.includes('for_new')) score += 60;
              if (room.features.includes('near_toilet')) score += 30;
            }
            if (user.conditions.includes('near_toilet')) {
              if (room.features.includes('near_toilet')) score += 100; else score -= 50;
            }
            if (user.conditions.includes('low_fall_risk')) {
              if (room.features.includes('low_fall_risk')) score += 80;
            }

            if (score > bestScore) {
              bestScore = score;
              bestRoom = room;
            }
          });

          // æœŸé–“å…¨ä½“ã‚’åŒã˜éƒ¨å±‹ã«å‰²ã‚Šå½“ã¦
          if (bestRoom) {
            period.forEach(dateStr => {
              const key = `${dateStr}-${bestRoom.id}`;
              if (!newAllocations[key]) newAllocations[key] = [];
              newAllocations[key].push(user.id);
            });
          } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é‡è¤‡ã‚’è¨±å®¹ã—ã¦ã€é‡è¤‡ãŒæœ€ã‚‚å°‘ãªã„éƒ¨å±‹ã‚’é¸ã¶
            let fallbackRoom = null;
            let minConflicts = Infinity;
            let fallbackScore = -9999;
            
            rooms.forEach(room => {
              let conflictDays = 0;
              let hasFullDay = false;
              
              for (const dateStr of period) {
                const key = `${dateStr}-${room.id}`;
                const currentOccupants = newAllocations[key] || [];
                
                // 2äººä»¥ä¸Šã„ã‚‹æ—¥ãŒã‚ã‚‹éƒ¨å±‹ã¯é™¤å¤–
                if (currentOccupants.length >= 2) {
                  hasFullDay = true;
                  break;
                }
                
                // 1äººã„ã‚‹å ´åˆã€åŒæ—¥IN/OUTã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
                if (currentOccupants.length === 1) {
                  const existingUserId = currentOccupants[0];
                  const existingUser = allUsers.find(u => u.id === existingUserId);
                  if (existingUser) {
                    const isCheckIn = !user.stayDates.includes(getPrevDay(dateStr));
                    const isCheckOut = !user.stayDates.includes(getNextDay(dateStr));
                    const existingIsCheckIn = !existingUser.stayDates.includes(getPrevDay(dateStr));
                    const existingIsCheckOut = !existingUser.stayDates.includes(getNextDay(dateStr));
                    const canShare = (existingIsCheckOut && isCheckIn) || (existingIsCheckIn && isCheckOut);
                    if (!canShare) {
                      conflictDays++; // åŒæ—¥IN/OUTã§ã¯ãªã„é‡è¤‡
                    }
                  }
                }
              }
              
              if (hasFullDay) return;
              
              // æ¡ä»¶ã‚¹ã‚³ã‚¢è¨ˆç®—
              let score = 0;
              if (user.conditions.includes('home_oxygen')) {
                if (room.features.includes('for_oxygen')) score += 1000; else score -= 500;
              }
              if (user.conditions.includes('high_fall_risk')) {
                if (room.features.includes('for_high_fall_risk')) score += 150;
              }
              if (user.conditions.includes('near_toilet')) {
                if (room.features.includes('near_toilet')) score += 100;
              }
              
              // é‡è¤‡ãŒå°‘ãªã„éƒ¨å±‹ã‚’å„ªå…ˆã€åŒã˜ãªã‚‰æ¡ä»¶ã‚¹ã‚³ã‚¢ã§åˆ¤æ–­
              if (conflictDays < minConflicts || (conflictDays === minConflicts && score > fallbackScore)) {
                minConflicts = conflictDays;
                fallbackScore = score;
                fallbackRoom = room;
              }
            });
            
            if (fallbackRoom) {
              period.forEach(dateStr => {
                const key = `${dateStr}-${fallbackRoom.id}`;
                if (!newAllocations[key]) newAllocations[key] = [];
                newAllocations[key].push(user.id);
              });
            }
          }
        });

        return newAllocations;
      };

      // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ç·¨é›†å‡¦ç† ---
      const handleSaveUser = () => {
        if (!newUserData.name) return;

        // åŒå§“åŒåãƒã‚§ãƒƒã‚¯ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å«ã‚€å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾è±¡ï¼‰
        const duplicateUser = users.find(u => 
          u.name === newUserData.name && 
          (!editingUser || u.id !== editingUser.id)
        );

        if (duplicateUser) {
          if (!window.confirm(`âš ï¸ åŒå§“åŒåã®åˆ©ç”¨è€…ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ï¼\n\nåŒå§“åŒåã®æ–¹ãŒã„ã‚‹å ´åˆã€ç¾å ´ã§ã®å–ã‚Šé•ãˆäº‹æ•…ã«ã¤ãªãŒã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚\nåŒºåˆ¥ã®ãŸã‚ã€åå‰ã«è­˜åˆ¥æƒ…å ±ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚\n\nä¾‹ï¼š${newUserData.name}(å¤§æ­£)ã€${newUserData.name}(å°) ãªã©\n\nã“ã®ã¾ã¾ã®åå‰ã§ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
          }
        }

        saveHistory();

        // ä¿å­˜ç”¨ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ï¼ˆãƒ­ãƒ³ã‚°åˆ©ç”¨ã®å ´åˆã¯æ—¥ä»˜ã‚’è‡ªå‹•ç”Ÿæˆï¼‰
        let dataToSave = { ...newUserData };
        if (dataToSave.isLongTerm && dataToSave.longTermStartDate) {
          const start = dataToSave.longTermStartDate;
          let end = dataToSave.longTermEndDate;
          if (!end) {
            // çµ‚äº†æ—¥æœªå®šã®å ´åˆã¯é–‹å§‹æ—¥ã‹ã‚‰2å¹´å¾Œã‚’è¨­å®š
            const d = parseLocalDate(start);
            d.setFullYear(d.getFullYear() + 2);
            end = toDateStr(d);
          }
          dataToSave.stayDates = getDatesInRange(start, end);
        }

        let savedUser;
        let updatedUsers;
        let newPeriods = []; // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸåˆ©ç”¨æœŸé–“

        if (editingUser) {
          const oldPeriods = getStayPeriods(editingUser.stayDates);
          const currentPeriods = getStayPeriods(dataToSave.stayDates);
          
          // æ–°ã—ã„æœŸé–“ã‚’æ¤œå‡ºï¼ˆæ—¢å­˜ã®ä¼ç¥¨ãŒãªã„æœŸé–“ï¼‰
          currentPeriods.forEach(period => {
            const periodStart = period[0];
            const periodEnd = period[period.length - 1];
            const ticketKey = `${editingUser.id}_${periodStart}_${periodEnd}`;
            const oldPeriodExists = oldPeriods.some(p => p[0] === periodStart && p[p.length-1] === periodEnd);
            if (!mealTickets[ticketKey] && !oldPeriodExists) {
              newPeriods.push({ start: periodStart, end: periodEnd, userId: editingUser.id });
            }
          });
          
          updatedUsers = users.map(u => {
            if (u.id === editingUser.id) {
              const datesChanged = JSON.stringify(u.stayDates.sort()) !== JSON.stringify(dataToSave.stayDates.sort());
              const bathTypeChanged = u.bathType !== dataToSave.bathType;
              const schedule = (datesChanged || bathTypeChanged) ? calculateInitialSchedule(dataToSave.stayDates, dataToSave.bathType) : u.schedule;
              savedUser = { ...dataToSave, id: u.id, schedule };
              return savedUser;
            }
            return u;
          });
        } else {
          savedUser = { 
            ...dataToSave, 
            id: Date.now(),
            schedule: calculateInitialSchedule(dataToSave.stayDates, dataToSave.bathType),
            createdAt: new Date().toISOString(),
            isArchived: false
          };
          updatedUsers = [...users, savedUser];
          
          // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€å…¨æœŸé–“ãŒæ–°è¦
          const periods = getStayPeriods(dataToSave.stayDates);
          newPeriods = periods.map(p => ({ start: p[0], end: p[p.length-1], userId: savedUser.id }));
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°ï¼ˆå³æ™‚åæ˜ ï¼‰
        setUsers(updatedUsers);
        const newAllocations = (savedUser && savedUser.stayDates.length > 0)
            ? allocateSingleUser(savedUser, allocations, updatedUsers)
            : allocations;
        if (savedUser && savedUser.stayDates.length > 0) {
          setAllocations(newAllocations);
        }

        if (isFirebaseEnabled && database) {
          const updates = {};
          updates[`data/${STORAGE_KEY_USERS}`] = updatedUsers;
          updates[`data/${STORAGE_KEY_ALLOCATIONS}`] = newAllocations;

          database.ref().update(updates).catch((error) => {
            console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å‰²ã‚Šå½“ã¦ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ', error);
            // ã“ã“ã§ã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼ˆä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ï¼‰ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™
          });
        }
        
        setNewUserData({ 
          name: '', 
          furigana: '', 
          gender: '',
          birthDate: '',
          birthDateMode: 'wareki',
          birthEra: '',
          birthYear: '',
          birthMonth: '',
          birthDay: '',
          conditions: [], 
          stayDates: [], 
          fixedRooms: {}, 
          bathType: '',
          medical: { insulin: false, gastrostomy: false, oxygenTherapy: false, balloonCatheter: false, stoma: false, note: '' },
          transport: { pickupTime: '', dropoffTime: '', address: '', pickupMethod: '', wheelchairNeeded: false, note: '' },
          careManager: { officeName: '', staffName: '', phone: '', fax: '', mobile: '' }
        });
        setEditingUser(null);
        setNewUserOpen(false);
        setSelectionStart(null);
        setCalendarMonth(currentMonth);
        
        // æ–°ã—ã„åˆ©ç”¨æœŸé–“ãŒã‚ã‚‹å ´åˆã€é£Ÿäº‹ä¼ç¥¨ä½œæˆã‚’ç¢ºèª
        if (newPeriods.length > 0) {
          const defaultMealPref = savedUser.mealPref || {};
          const firstPeriod = newPeriods[0];
          if (window.confirm(`åˆ©ç”¨æœŸé–“ ${firstPeriod.start} ï½ ${firstPeriod.end} ã®é£Ÿäº‹ä¼ç¥¨ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ`)) {
            setEditingMealTicket({
              userId: firstPeriod.userId,
              startDate: firstPeriod.start,
              endDate: firstPeriod.end,
              unit: 'æ¨¹',
              startMeal: '',
              endMeal: '',
              category: '',
              reason: '',
              foodType: defaultMealPref.foodType || '',
              diabetesKcal: '',
              mainDish: defaultMealPref.mainDish || '',
              mainDishOther: '',
              sideDish: defaultMealPref.sideDish || '',
              sideDishOther: '',
              drink: defaultMealPref.drink || '',
              snack: defaultMealPref.snack || '',
              memo: defaultMealPref.allergy ? `ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼: ${defaultMealPref.allergy}` : ''
            });
            setShowMealTicketModal(true);
          }
        }
      };

      const handleEditUser = (user) => {
        setEditingUser(user);
        
        // ç”Ÿå¹´æœˆæ—¥ã‹ã‚‰å’Œæš¦ã‚’è¨ˆç®—
        let birthEra = '', birthYear = '', birthMonth = '', birthDay = '';
        if (user.birthDate) {
          const d = parseLocalDate(user.birthDate);
          const year = d.getFullYear();
          birthMonth = d.getMonth() + 1;
          birthDay = d.getDate();
          if (year >= 2019) { birthEra = 'reiwa'; birthYear = year - 2018; }
          else if (year >= 1989) { birthEra = 'heisei'; birthYear = year - 1988; }
          else if (year >= 1926) { birthEra = 'showa'; birthYear = year - 1925; }
          else { birthEra = 'taisho'; birthYear = year - 1911; }
        }
        
        setNewUserData({
          name: user.name,
          furigana: user.furigana || '',
          gender: user.gender || '',
          birthDate: user.birthDate || '',
          birthDateMode: 'wareki',
          birthEra: birthEra,
          birthYear: birthYear ? String(birthYear) : '',
          birthMonth: birthMonth ? String(birthMonth) : '',
          birthDay: birthDay ? String(birthDay) : '',
          conditions: user.conditions,
          stayDates: user.stayDates,
          fixedRooms: user.fixedRooms || {},
          bathType: user.bathType || '',
          medical: { 
            insulin: false, gastrostomy: false, oxygenTherapy: false, 
            balloonCatheter: false, stoma: false, note: '',
            ...(user.medical || {}) 
          },
          transport: user.transport || { pickupTime: '', dropoffTime: '', address: '', pickupMethod: '', wheelchairNeeded: false, note: '' },
          careManager: user.careManager || { officeName: '', staffName: '', phone: '', fax: '', mobile: '' },
          mealPref: user.mealPref || { foodType: '', mainDish: '', sideDish: '', drink: '', snack: '', allergy: '' },
          isLongTerm: user.isLongTerm || false, longTermStartDate: user.longTermStartDate || '', longTermEndDate: user.longTermEndDate || ''
        });
        // åˆ©ç”¨æ—¥ãŒã‚ã‚‹å ´åˆã€æœ€åˆã®åˆ©ç”¨æœˆã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç§»å‹•
        setTempFixedPeriod('');
        setTempFixedRoomId('');
        if (user.stayDates && user.stayDates.length > 0) {
          const firstDate = [...user.stayDates].sort()[0];
          const firstDateObj = parseLocalDate(firstDate);
          setCalendarMonth(getFirstDayOfMonth(firstDateObj));
        } else {
          setCalendarMonth(currentMonth);
        }
        setNewUserOpen(true);
        setSelectionStart(null);
      };

      const toggleCondition = (key) => {
        setNewUserData(prev => {
          const has = prev.conditions.includes(key);
          return {
            ...prev,
            conditions: has ? prev.conditions.filter(k => k !== key) : [...prev.conditions, key]
          };
        });
      };

      const handleDateClick = (dateStr) => {
        // æ—¢ã«é¸æŠæ¸ˆã¿ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯å‰Šé™¤
        if (newUserData.stayDates.includes(dateStr)) {
          setNewUserData(prev => ({
            ...prev,
            stayDates: prev.stayDates.filter(d => d !== dateStr)
          }));
          setSelectionStart(null); // ç¯„å›²é¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆ
          return;
        }
        
        if (!selectionStart) {
          setSelectionStart(dateStr);
        } else {
          const range = getDatesInRange(selectionStart, dateStr);
          setNewUserData(prev => {
            const uniqueDates = Array.from(new Set([...prev.stayDates, ...range])).sort();
            return { ...prev, stayDates: uniqueDates };
          });
          setSelectionStart(null);
        }
      };

      const clearSelectedDates = () => {
        setNewUserData(prev => ({ ...prev, stayDates: [] }));
        setSelectionStart(null);
      };

      // åˆ©ç”¨è€…ã‚’éè¡¨ç¤ºï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰ã«ã™ã‚‹
      const archiveUser = (id) => {
        const user = users.find(u => u.id === id);
        if (!user) return;

        if (!window.confirm(`ã€Œ${user.name}ã€ã‚’éè¡¨ç¤ºã«ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œãšã€ãƒªã‚¹ãƒˆã‹ã‚‰éš ã‚Œã‚‹ã ã‘ã§ã™ã€‚\nâ€»ã€Œéè¡¨ç¤ºåˆ©ç”¨è€…ãƒªã‚¹ãƒˆã€ã‹ã‚‰ã„ã¤ã§ã‚‚æˆ»ã›ã¾ã™ã€‚`)) {
          return;
        }

        saveHistory();

        const newUsers = users.map(u => 
          u.id === id ? { ...u, isArchived: true } : u
        );

        setUsers(newUsers); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°

        if (isFirebaseEnabled && database) {
          database.ref('data/' + STORAGE_KEY_USERS).set(newUsers);
        }
      };

      // åˆ©ç”¨è€…ã‚’å†è¡¨ç¤ºã™ã‚‹
      const unarchiveUser = (id) => {
        const user = users.find(u => u.id === id);
        if (!user) return;

        if (!window.confirm(`ã€Œ${user.name}ã€ã‚’å†è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ`)) {
          return;
        }

        saveHistory();

        const newUsers = users.map(u => 
          u.id === id ? { ...u, isArchived: false } : u
        );

        setUsers(newUsers); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°

        if (isFirebaseEnabled && database) {
          database.ref('data/' + STORAGE_KEY_USERS).set(newUsers);
        }
        
        alert(`ã€Œ${user.name}ã€ã‚’ãƒªã‚¹ãƒˆã«æˆ»ã—ã¾ã—ãŸ`);
      };

      const deleteUser = (id) => {
        const user = users.find(u => u.id === id);
        if (!user) return;
        
        if(!window.confirm(`ã€Œ${user.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»å‰Šé™¤ã™ã‚‹ã¨ã€ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹éƒ¨å±‹å‰²ã‚Šã‚„é£Ÿäº‹ä¼ç¥¨ã‚‚ã™ã¹ã¦æ¶ˆãˆã¾ã™ã€‚`)) {
          return;
        }

        saveHistory();

        // 1. éƒ¨å±‹å‰²ã‚Šãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        const newAllocations = { ...allocations };
        Object.keys(newAllocations).forEach(key => {
          if (newAllocations[key].includes(id)) {
            newAllocations[key] = newAllocations[key].filter(uid => uid !== id);
            if (newAllocations[key].length === 0) {
              delete newAllocations[key];
            }
          }
        });

        // 2. é£Ÿäº‹ä¼ç¥¨ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        const newMealTickets = { ...mealTickets };
        Object.keys(newMealTickets).forEach(key => {
          if (newMealTickets[key] && newMealTickets[key].userId === id) {
            delete newMealTickets[key];
          }
        });

        // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
        const newUsers = users.filter(u => u.id !== id);

        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
        setUsers(newUsers);
        setAllocations(newAllocations);
        setMealTickets(newMealTickets);

        // 4. ä¿å­˜
        if (isFirebaseEnabled && database) {
          const updates = {};
          updates[`data/${STORAGE_KEY_USERS}`] = newUsers;
          updates[`data/${STORAGE_KEY_ALLOCATIONS}`] = newAllocations;
          updates[`data/${STORAGE_KEY_MEAL_TICKETS}`] = newMealTickets;
          database.ref().update(updates);
        }
      };

      // å…¨åˆ©ç”¨è€…ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†è¨ˆç®—
      const recalculateAllSchedules = () => {
        if(!window.confirm('å…¨åˆ©ç”¨è€…ã®å…¥æµ´ãƒ»ãƒªãƒãƒ³ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ‰‹å‹•ã§å¤‰æ›´ã—ãŸå…¥æµ´äºˆå®šã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼‰')) {
          return;
        }
        
        saveHistory();

        const updatedUsers = users.map(user => ({
          ...user,
          schedule: calculateInitialSchedule(user.stayDates, user.bathType || '')
        }));
        
        setUsers(updatedUsers); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°

        if (isFirebaseEnabled && database) {
          database.ref('data/' + STORAGE_KEY_USERS).set(updatedUsers);
        }
        alert('å…¨åˆ©ç”¨è€…ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†è¨ˆç®—ã—ã¾ã—ãŸï¼');
      };

      // å…¨ãƒ‡ãƒ¼ã‚¿å†è¨ˆç®—ï¼ˆéƒ¨å±‹å‰²ã‚Šï¼‹å…¥æµ´ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
      const recalculateAllData = () => {
        if(!window.confirm('å…¨åˆ©ç”¨è€…ã®éƒ¨å±‹å‰²ã‚Šã¨å…¥æµ´ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»æ‰‹å‹•ã§å¤‰æ›´ã—ãŸéƒ¨å±‹å‰²ã‚Šã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™\nãƒ»æ‰‹å‹•ã§å¤‰æ›´ã—ãŸå…¥æµ´äºˆå®šã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™')) {
          return;
        }
        
        saveHistory();

        // 1. å…¥æµ´ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†è¨ˆç®—
        const updatedUsers = users.map(user => ({
          ...user,
          schedule: calculateInitialSchedule(user.stayDates, user.bathType || '')
        }));
        
        // 2. éƒ¨å±‹å‰²ã‚Šã‚’å…¨ã¦å†è¨ˆç®—
        // å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆï¼ˆéƒ¨å±‹å›ºå®š â†’ åˆ©ç”¨æ—¥æ•°é•·ã„é † â†’ æ¡ä»¶å„ªå…ˆåº¦ï¼‰
        const sortedUsers = [...updatedUsers].filter(u => !u.isArchived && u.stayDates.length > 0).sort((a, b) => {
          // éƒ¨å±‹å›ºå®šã¯æœ€å„ªå…ˆï¼ˆfixedRoomsã«ç™»éŒ²ãŒã‚ã‚‹å ´åˆï¼‰
          const aHasFixed = a.fixedRooms && Object.keys(a.fixedRooms).length > 0;
          const bHasFixed = b.fixedRooms && Object.keys(b.fixedRooms).length > 0;
          if (aHasFixed && !bHasFixed) return -1;
          if (!aHasFixed && bHasFixed) return 1;
          
          // åˆ©ç”¨æ—¥æ•°ãŒé•·ã„é †
          const daysA = a.stayDates.length;
          const daysB = b.stayDates.length;
          if (daysB !== daysA) return daysB - daysA;
          
          // åŒã˜æ—¥æ•°ãªã‚‰æ¡ä»¶å„ªå…ˆåº¦
          const getPriority = (user) => {
            if (user.conditions.includes('home_oxygen')) return 100;
            if (user.conditions.includes('high_fall_risk')) return 80;
            if (user.conditions.includes('is_new')) return 60;
            if (user.conditions.includes('near_toilet')) return 50;
            if (user.conditions.includes('low_fall_risk')) return 40;
            return 0;
          };
          return getPriority(b) - getPriority(a);
        });

        const newAllocations = {};

        sortedUsers.forEach(user => {
          const periods = getStayPeriods(user.stayDates);
          
          periods.forEach(period => {
            const periodKey = `${period[0]}_${period[period.length - 1]}`;
            const fixedRoomForPeriod = user.fixedRooms && user.fixedRooms[periodKey];
            
            // ã“ã®æœŸé–“ãŒéƒ¨å±‹å›ºå®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
            if (fixedRoomForPeriod) {
              period.forEach(dateStr => {
                const key = `${dateStr}-${fixedRoomForPeriod}`;
                if (!newAllocations[key]) newAllocations[key] = [];
                newAllocations[key].push(user.id);
              });
              return; // æ¬¡ã®æœŸé–“ã¸
            }
            
            // å›ºå®šã•ã‚Œã¦ã„ãªã„æœŸé–“ã¯è‡ªå‹•å‰²ã‚Šå½“ã¦
            let bestRoom = null;
            let bestScore = -9999;

            rooms.forEach(room => {
              let canUsePeriod = true;

              for (const dateStr of period) {
                const key = `${dateStr}-${room.id}`;
                const currentOccupants = newAllocations[key] || [];
                
                if (currentOccupants.length >= 2) {
                  canUsePeriod = false;
                  break;
                }
                
                if (currentOccupants.length === 1) {
                  const existingUserId = currentOccupants[0];
                  const existingUser = updatedUsers.find(u => u.id === existingUserId);
                  if (existingUser) {
                    const isCheckIn = !user.stayDates.includes(getPrevDay(dateStr));
                    const isCheckOut = !user.stayDates.includes(getNextDay(dateStr));
                    const existingIsCheckIn = !existingUser.stayDates.includes(getPrevDay(dateStr));
                    const existingIsCheckOut = !existingUser.stayDates.includes(getNextDay(dateStr));
                    const canShare = (existingIsCheckOut && isCheckIn) || (existingIsCheckIn && isCheckOut);
                    if (!canShare) {
                      canUsePeriod = false;
                      break;
                    }
                  }
                }
              }

              if (!canUsePeriod) return;

              let score = 0;
              
              if (user.conditions.includes('home_oxygen')) {
                if (room.features.includes('for_oxygen')) score += 1000; else score -= 500;
              } else {
                if (room.features.includes('for_oxygen')) score -= 20;
              }
              if (user.conditions.includes('high_fall_risk')) {
                if (room.features.includes('for_high_fall_risk')) score += 150;
                if (room.features.includes('near_toilet')) score += 80;
                if (room.features.includes('low_fall_risk')) score -= 50;
              }
              if (user.conditions.includes('is_new')) {
                if (room.features.includes('for_new')) score += 60;
                if (room.features.includes('near_toilet')) score += 30;
              }
              if (user.conditions.includes('near_toilet')) {
                if (room.features.includes('near_toilet')) score += 100; else score -= 50;
              }
              if (user.conditions.includes('low_fall_risk')) {
                if (room.features.includes('low_fall_risk')) score += 80;
              }

              if (score > bestScore) {
                bestScore = score;
                bestRoom = room;
              }
            });

            if (bestRoom) {
              period.forEach(dateStr => {
                const key = `${dateStr}-${bestRoom.id}`;
                newAllocations[key] = [...(newAllocations[key] || []), user.id];
              });
            } else {
              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é‡è¤‡ã‚’è¨±å®¹ã—ã¦ã€é‡è¤‡ãŒæœ€ã‚‚å°‘ãªã„éƒ¨å±‹ã‚’é¸ã¶
              let fallbackRoom = null;
              let minConflicts = Infinity;
              let fallbackScore = -9999;
              
              rooms.forEach(room => {
                let conflictDays = 0;
                let hasFullDay = false;
                
                for (const dateStr of period) {
                  const key = `${dateStr}-${room.id}`;
                  const currentOccupants = newAllocations[key] || [];
                  
                  if (currentOccupants.length >= 2) {
                    hasFullDay = true;
                    break;
                  }
                  
                  if (currentOccupants.length === 1) {
                    const existingUserId = currentOccupants[0];
                    const existingUser = updatedUsers.find(u => u.id === existingUserId);
                    if (existingUser) {
                      const isCheckIn = !user.stayDates.includes(getPrevDay(dateStr));
                      const isCheckOut = !user.stayDates.includes(getNextDay(dateStr));
                      const existingIsCheckIn = !existingUser.stayDates.includes(getPrevDay(dateStr));
                      const existingIsCheckOut = !existingUser.stayDates.includes(getNextDay(dateStr));
                      const canShare = (existingIsCheckOut && isCheckIn) || (existingIsCheckIn && isCheckOut);
                      if (!canShare) {
                        conflictDays++;
                      }
                    }
                  }
                }
                
                if (hasFullDay) return;
                
                let score = 0;
                if (user.conditions.includes('home_oxygen')) {
                  if (room.features.includes('for_oxygen')) score += 1000; else score -= 500;
                }
                if (user.conditions.includes('high_fall_risk')) {
                  if (room.features.includes('for_high_fall_risk')) score += 150;
                }
                if (user.conditions.includes('near_toilet')) {
                  if (room.features.includes('near_toilet')) score += 100;
                }
                
                if (conflictDays < minConflicts || (conflictDays === minConflicts && score > fallbackScore)) {
                  minConflicts = conflictDays;
                  fallbackScore = score;
                  fallbackRoom = room;
                }
              });
              
              if (fallbackRoom) {
                period.forEach(dateStr => {
                  const key = `${dateStr}-${fallbackRoom.id}`;
                  newAllocations[key] = [...(newAllocations[key] || []), user.id];
                });
              }
            }
          });
        });

        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
        setUsers(updatedUsers);
        setAllocations(newAllocations);

        if (isFirebaseEnabled && database) {
          const updates = {};
          updates[`data/${STORAGE_KEY_USERS}`] = updatedUsers;
          updates[`data/${STORAGE_KEY_ALLOCATIONS}`] = newAllocations;
          database.ref().update(updates).catch(e => {
            console.error('å…¨ãƒ‡ãƒ¼ã‚¿å†è¨ˆç®—ã®æ›´æ–°ã«å¤±æ•—', e);
          });
        }
        alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å†è¨ˆç®—ã—ã¾ã—ãŸï¼\nï¼ˆéƒ¨å±‹å‰²ã‚Šï¼‹å…¥æµ´ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰');
      };

      const handleMemoChange = (dateStr, roomId, value) => {
        const key = `${dateStr}-${roomId}`;
        saveHistory();
        setMemos(prev => ({ ...prev, [key]: value })); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°

        if (isFirebaseEnabled && database) {
          // FirebaseãŒæœ‰åŠ¹ãªå ´åˆã¯ã€ç‰¹å®šã®ãƒ¡ãƒ¢ã ã‘ã‚’æ›´æ–°ã™ã‚‹
          database.ref(`data/${STORAGE_KEY_MEMOS}/${key}`).set(value);
        }
      };

      const clearAllData = () => {
        if(window.confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
          saveHistory();
          db.remove(STORAGE_KEY_USERS);
          db.remove(STORAGE_KEY_ALLOCATIONS); // ãƒ­ãƒ¼ã‚«ãƒ«ã¯ã‚¯ãƒªã‚¢
          db.remove(STORAGE_KEY_MEMOS); // ãƒ­ãƒ¼ã‚«ãƒ«ã¯ã‚¯ãƒªã‚¢
          db.remove(STORAGE_KEY_STICKIES);
          if (isFirebaseEnabled && database) {
            // Firebaseä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢
            database.ref('data').set({
              [STORAGE_KEY_USERS]: generateSampleUsers(currentMonth),
              [STORAGE_KEY_ALLOCATIONS]: {},
              [STORAGE_KEY_MEMOS]: {},
              [STORAGE_KEY_STICKIES]: [],
            });
          }
          // stateã‚’åˆæœŸåŒ–ï¼ˆã“ã‚Œã¯Firebaseã®onSnapshotã§ã‚‚æ›´æ–°ã•ã‚Œã‚‹ï¼‰
          setUsers(generateSampleUsers(currentMonth)); setAllocations({}); setMemos({});
        }
      };

      const changeMonth = (direction) => {
        setCurrentMonth(prev => addMonths(prev, direction));
        setUseCustomRange(false); // æœˆã‚’å¤‰æ›´ã—ãŸã‚‰ã‚«ã‚¹ã‚¿ãƒ æœŸé–“ã‚’ãƒªã‚»ãƒƒãƒˆ
      };

      const renderCalendarGrid = () => {
        const year = calendarMonth.getFullYear();
        const month = calendarMonth.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const blanks = Array(firstDay).fill(null);
        const calendarDaysInMonth = getDaysInMonth(calendarMonth);
        const calendarDates = Array.from({ length: calendarDaysInMonth }, (_, i) => {
          return toDateStr(new Date(year, month, i + 1));
        });
        
        return (
          <div>
            {/* æœˆç§»å‹•ãƒœã‚¿ãƒ³ */}
            <div className="flex items-center justify-between mb-2">
              <button
                onClick={(e) => {
                  e.preventDefault();
                  setCalendarMonth(addMonths(calendarMonth, -1));
                }}
                className="p-1 hover:bg-gray-200 rounded text-gray-600"
              >
                <ChevronLeft size={16} />
              </button>
              <span className="text-sm font-bold text-gray-700">
                {calendarMonth.getFullYear()}å¹´ {calendarMonth.getMonth() + 1}æœˆ
              </span>
              <button
                onClick={(e) => {
                  e.preventDefault();
                  setCalendarMonth(addMonths(calendarMonth, 1));
                }}
                className="p-1 hover:bg-gray-200 rounded text-gray-600"
              >
                <ChevronRight size={16} />
              </button>
            </div>
            
            <div className="grid grid-cols-7 gap-1 text-center">
              {['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].map(d => (
                <div key={d} className={`text-xs font-bold p-1 ${d==='æ—¥'?'text-red-500':d==='åœŸ'?'text-blue-500':'text-gray-600'}`}>{d}</div>
              ))}
              {blanks.map((_, i) => <div key={`blank-${i}`} className="p-1"></div>)}
              {calendarDates.map(dateStr => {
                const dateObj = parseLocalDate(dateStr);
                const isSelected = newUserData.stayDates.includes(dateStr);
                const isStart = selectionStart === dateStr;
                const dayOfWeek = dateObj.getDay();
                const isSun = dayOfWeek === 0;
                const isSat = dayOfWeek === 6;
                return (
                  <button
                    key={dateStr}
                    type="button"
                    onClick={() => handleDateClick(dateStr)}
                    className={`
                      p-2 text-xs rounded border transition-colors relative
                      ${isSelected 
                        ? 'bg-blue-600 text-white border-blue-700 hover:bg-red-500 hover:border-red-600' 
                        : 'bg-white hover:bg-gray-100 border-gray-200'}
                      ${!isSelected && isSun ? 'text-red-500' : ''}
                      ${!isSelected && isSat ? 'text-blue-500' : ''}
                      ${isStart ? 'ring-2 ring-yellow-400 z-10' : ''}
                    `}
                    title={isSelected ? 'ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤' : ''}
                  >
                    {dateObj.getDate()}
                    {isStart && <span className="absolute -top-1 -right-1 flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span></span>}
                  </button>
                );
              })}
            </div>
          </div>
        );
      };

      // --- è¿½åŠ æ©Ÿèƒ½: ç©ºåºŠãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡æ“ä½œ ---
      const handleRenameTempRoom = (id, currentName) => {
        const newName = window.prompt('ç©ºåºŠåã‚’å¤‰æ›´:', currentName);
        if (newName && newName !== currentName) {
          saveHistory();
          const newTempRooms = tempRooms.map(r => r.id === id ? { ...r, name: newName } : r);
          setTempRooms(newTempRooms); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°

          if (isFirebaseEnabled && database) {
            database.ref('data/' + STORAGE_KEY_TEMP_ROOMS).set(newTempRooms);
          }
        }
      };

      const handleAddTempRoom = () => {
        saveHistory();
        const monthStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
        const newId = `TEMP_ROOM_${Date.now()}`;
        // ç¾åœ¨ã®æœˆã®ç©ºåºŠæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ç•ªå·ã‚’æŒ¯ã‚‹
        const currentCount = tempRooms.filter(r => r.month === monthStr).length;
        const newName = `ç©ºåºŠ${currentCount + 1}`;
        
        const newRoom = {
          id: newId,
          name: newName,
          month: monthStr
        };
        
        const newTempRooms = [...tempRooms, newRoom];
        setTempRooms(newTempRooms); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
        
        if (isFirebaseEnabled && database) {
          database.ref('data/' + STORAGE_KEY_TEMP_ROOMS).set(newTempRooms);
        }
      };

      const handleAddCustomRow = () => {
        saveHistory();
        const newId = `custom_${Date.now()}`;
        const newRows = [...customRows, { id: newId, name: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡' }];
        setCustomRows(newRows); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°

        if (isFirebaseEnabled && database) {
          database.ref('data/' + STORAGE_KEY_CUSTOM_ROWS).set(newRows);
        }
      };

      const handleDeleteCustomRow = (id) => {
        if (customRows.length <= 1) return;
        if (!window.confirm('ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»å…¥åŠ›ã•ã‚ŒãŸãƒ¡ãƒ¢ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;
        
        saveHistory();
        const newRows = customRows.filter(r => r.id !== id);
        
        // ãƒ¡ãƒ¢ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        const newMemos = { ...customRowMemos };
        Object.keys(newMemos).forEach(key => {
          if (key.includes(`-${id}-`)) {
            delete newMemos[key];
          }
        });

        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
        setCustomRows(newRows);
        setCustomRowMemos(newMemos);

        if (isFirebaseEnabled && database) {
          const updates = {};
          updates[`data/${STORAGE_KEY_CUSTOM_ROWS}`] = newRows;
          updates[`data/${STORAGE_KEY_CUSTOM_ROW_MEMOS}`] = newMemos;
          database.ref().update(updates);
        }
      };

      // --- ä»˜ç®‹æ©Ÿèƒ½ ---
      const handleAddSticky = () => {
        saveHistory();
        // ç”»é¢ä¸­å¤®ã«é…ç½®ï¼ˆå°‘ã—ãšã‚‰ã™ï¼‰
        const initialX = (window.innerWidth / 2) - 100;
        const initialY = (window.innerHeight / 2) - 75;
        const offset = (stickies.length % 5) * 20;

        const newSticky = {
          id: `sticky_${Date.now()}`,
          text: '',
          x: initialX + offset,
          y: initialY + offset,
          width: 200,
          height: 150,
          color: 'bg-yellow-100',
          zIndex: stickies.length + 1
        };
        const newStickies = [...stickies, newSticky];
        setStickies(newStickies);
        
        if (isFirebaseEnabled && database) {
          database.ref('data/' + STORAGE_KEY_STICKIES).set(newStickies);
        }
      };

      const handleUpdateSticky = (id, updates) => {
        // å±¥æ­´ä¿å­˜ã¯é »ç¹ãªæ›´æ–°ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ä¸­ãªã©ï¼‰ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã“ã“ã§ã¯è¡Œã‚ãªã„ã‹ã€
        // StickyNoteå´ã§åˆ¶å¾¡ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯æ›´æ–°ã‚’å—ã‘å–ã‚‹ã ã‘ã«ã™ã‚‹
        const newStickies = stickies.map(s => s.id === id ? { ...s, ...updates } : s);
        setStickies(newStickies);
        
        if (isFirebaseEnabled && database) {
          database.ref('data/' + STORAGE_KEY_STICKIES).set(newStickies);
        }
      };

      const handleDeleteSticky = (id) => {
        saveHistory();
        const newStickies = stickies.filter(s => s.id !== id);
        setStickies(newStickies);
        if (isFirebaseEnabled && database) {
          database.ref('data/' + STORAGE_KEY_STICKIES).set(newStickies);
        }
      };

      if (!isLoaded) {
        return <div className="min-h-screen flex items-center justify-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>;
      }

      return (
        <>
        {/* --- A. ç”»é¢è¡¨ç¤ºç”¨ï¼ˆæ—¢å­˜ã®UIã‚’ãã®ã¾ã¾ãƒ©ãƒƒãƒ—ï¼‰ --- */}
        <div className="screen-only">
        <div className="min-h-screen bg-gray-50 p-4 text-sm md:text-base font-sans print-p-0 print-bg-white">
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */}
          <Header 
            headerCollapsed={headerCollapsed}
            setHeaderCollapsed={setHeaderCollapsed}
            currentMonth={currentMonth}
            changeMonth={changeMonth}
            userSearchQuery={userSearchQuery}
            setUserSearchQuery={setUserSearchQuery}
            displayStartDate={displayStartDate}
            setDisplayStartDate={setDisplayStartDate}
            displayEndDate={displayEndDate}
            setDisplayEndDate={setDisplayEndDate}
            useCustomRange={useCustomRange}
            setUseCustomRange={setUseCustomRange}
            lastBackup={lastBackup}
            exportData={exportData}
            importData={importData}
            recalculateAllData={recalculateAllData}
            recalculateAllSchedules={recalculateAllSchedules}
            setShowSettings={setShowSettings}
            setShowLogoutConfirm={setShowLogoutConfirm}
            undo={undo}
            canUndo={history.length > 0}
            fileInputRef={fileInputRef}
            onAddSticky={handleAddSticky}
          />

          {/* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {showLogoutConfirm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg shadow-xl p-6 w-96 max-w-[90vw]">
                <h3 className="font-bold text-gray-800 mb-3 text-lg">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</h3>
                
                {(() => {
                  const daysSinceBackup = lastBackup 
                    ? Math.floor((new Date() - lastBackup) / (1000 * 60 * 60 * 24))
                    : null;
                  const needsBackup = daysSinceBackup === null || daysSinceBackup >= 7;
                  
                  return needsBackup ? (
                    <div className="mb-4">
                      <div className="bg-red-50 border border-red-200 rounded p-3 mb-3">
                        <p className="text-red-600 font-bold text-sm">
                          âš ï¸ {lastBackup ? `${daysSinceBackup}æ—¥é–“ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã›ã‚“` : 'ã¾ã ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã›ã‚“'}
                        </p>
                        <p className="text-red-500 text-xs mt-1">
                          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãŠã™ã™ã‚ã—ã¾ã™
                        </p>
                      </div>
                      <button
                        onClick={() => {
                          exportData();
                        }}
                        className="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded font-bold mb-2 flex items-center justify-center gap-2"
                      >
                        <Download size={16} />
                        ä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                      </button>
                    </div>
                  ) : (
                    <p className="text-gray-600 mb-4 text-sm">
                      ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ<br/>
                      <span className="text-green-600">âœ“ æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: {daysSinceBackup === 0 ? 'ä»Šæ—¥' : `${daysSinceBackup}æ—¥å‰`}</span>
                    </p>
                  );
                })()}
                
                <div className="flex gap-2">
                  <button
                    onClick={() => setShowLogoutConfirm(false)}
                    className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded font-bold"
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                  <button
                    onClick={() => {
                      setShowLogoutConfirm(false);
                      onLogout();
                    }}
                    className="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded font-bold"
                  >
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {showSettings && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg shadow-xl p-6 w-[450px] max-w-[90vw] max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <Settings size={20} />
                    è¨­å®š
                  </h2>
                  <button 
                    onClick={() => {
                      setShowSettings(false);
                      setSettingsError('');
                      setSettingsSuccess('');
                      setArchiveYear('');
                      setArchiveStats(null);
                    }}
                    className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
                  >&times;</button>
                </div>

                {/* ãƒ‡ãƒ¼ã‚¿æ•´ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                <div className="pt-2">
                  <h3 className="font-bold text-gray-700 mb-3">ğŸ“¦ ãƒ‡ãƒ¼ã‚¿æ•´ç†ï¼ˆå¹´åˆ¥ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰</h3>
                  <p className="text-xs text-gray-500 mb-3">
                    å¤ã„å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ã€ã‚¢ãƒ—ãƒªã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚<br/>
                    å‰Šé™¤å¾Œã‚‚JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’Excelç­‰ã§é–‹ã‘ã°ç¢ºèªã§ãã¾ã™ã€‚
                  </p>
                  
                  {getDataYears().length > 0 ? (
                    <div className="space-y-3">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã™ã‚‹å¹´ã‚’é¸æŠ</label>
                        <select
                          value={archiveYear}
                          onChange={(e) => {
                            setArchiveYear(e.target.value);
                            if (e.target.value) {
                              setArchiveStats(calculateArchiveStats(e.target.value));
                            } else {
                              setArchiveStats(null);
                            }
                          }}
                          className="w-full p-2 border rounded text-sm"
                        >
                          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                          {getDataYears().map(year => (
                            <option key={year} value={year}>{year}å¹´</option>
                          ))}
                        </select>
                      </div>
                      
                      {archiveStats && (
                        <div className="bg-gray-50 p-3 rounded text-sm">
                          <p className="font-bold text-gray-700 mb-2">ğŸ“Š {archiveYear}å¹´ã®ãƒ‡ãƒ¼ã‚¿:</p>
                          <ul className="text-gray-600 space-y-1">
                            <li>ãƒ»åˆ©ç”¨æ—¥æ•°: {archiveStats.stayDateCount}ä»¶</li>
                            <li>ãƒ»éƒ¨å±‹å‰²ã‚Š: {archiveStats.allocationCount}ä»¶</li>
                            <li>ãƒ»ãƒ¡ãƒ¢: {archiveStats.memoCount}ä»¶</li>
                          </ul>
                        </div>
                      )}
                      
                      <div className="flex gap-2">
                        <button
                          onClick={() => archiveYear && exportYearData(archiveYear)}
                          disabled={!archiveYear}
                          className="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white py-2 rounded font-bold text-sm"
                        >
                          ğŸ“¥ {archiveYear || '?'}å¹´ã‚’ä¿å­˜ã®ã¿
                        </button>
                        <button
                          onClick={() => archiveYear && setShowArchiveConfirm(true)}
                          disabled={!archiveYear}
                          className="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-gray-300 text-white py-2 rounded font-bold text-sm"
                        >
                          ğŸ—‘ï¸ ä¿å­˜ã—ã¦å‰Šé™¤
                        </button>
                      </div>
                    </div>
                  ) : (
                    <p className="text-gray-400 text-sm">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {showArchiveConfirm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]">
              <div className="bg-white rounded-lg shadow-xl p-6 w-96 max-w-[90vw]">
                <h3 className="font-bold text-red-600 mb-3 text-lg">âš ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã®ç¢ºèª</h3>
                <div className="bg-red-50 border border-red-200 rounded p-3 mb-4">
                  <p className="text-red-700 text-sm font-bold mb-2">
                    {archiveYear}å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™
                  </p>
                  <p className="text-red-600 text-xs">
                    ãƒ»ã¾ãšJSONãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™<br/>
                    ãƒ»ãã®å¾Œã€ã‚¢ãƒ—ãƒªã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™<br/>
                    ãƒ»å‰Šé™¤å¾Œã¯å¾©å…ƒãƒœã‚¿ãƒ³ã§JSONã‚’èª­ã¿è¾¼ã‚ã°æˆ»ã›ã¾ã™
                  </p>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => setShowArchiveConfirm(false)}
                    className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded font-bold"
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                  <button
                    onClick={() => executeArchive(archiveYear)}
                    className="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded font-bold"
                  >
                    å‰Šé™¤ã™ã‚‹
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* éƒ¨å±‹æ¡ä»¶ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {showRoomEditor && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg shadow-xl p-6 w-[500px] max-w-[95vw] max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="font-bold text-gray-800 text-lg">ğŸ  éƒ¨å±‹æ¡ä»¶ã®ç·¨é›†</h3>
                  <button 
                    onClick={() => setShowRoomEditor(false)} 
                    className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
                  >&times;</button>
                </div>
                
                <div className="space-y-3">
                  {editingRooms.map((room, index) => (
                    <div key={room.id} className="p-3 bg-gray-50 rounded border border-gray-200">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="font-bold text-gray-700 text-lg">{room.name}å·å®¤</span>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {ROOM_FEATURES.map(feature => (
                          <label key={feature.key} className="flex items-center gap-1 cursor-pointer bg-white px-2 py-1 rounded border hover:bg-blue-50">
                            <input 
                              type="checkbox" 
                              checked={room.features.includes(feature.key)}
                              onChange={(e) => {
                                const newRooms = [...editingRooms];
                                // éƒ¨å±‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¤‡è£½ã—ã¦ç›´æ¥å¤‰æ›´ã‚’é˜²ã
                                newRooms[index] = { ...newRooms[index] };
                                if (e.target.checked) {
                                  newRooms[index].features = [...room.features, feature.key];
                                } else {
                                  newRooms[index].features = room.features.filter(f => f !== feature.key);
                                }
                                // ãƒ©ãƒ™ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆ
                                const labels = newRooms[index].features.map(f => 
                                  ROOM_FEATURES.find(rf => rf.key === f)?.label || f
                                );
                                newRooms[index].label = labels.length > 0 ? labels.join('ãƒ»') : 'é€šå¸¸';
                                setEditingRooms(newRooms);
                              }}
                              className="rounded text-blue-600"
                            />
                            <span className="text-xs text-gray-700">{feature.label}</span>
                          </label>
                        ))}
                      </div>
                      <div className="mt-2 text-xs text-gray-500">
                        ç¾åœ¨ã®è¨­å®š: <span className="font-bold text-gray-700">{room.label || 'é€šå¸¸'}</span>
                      </div>
                      
                      {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®šï¼ˆå…¥é™¢ãƒ»é€€å»ï¼‰ */}
                      <div className="mt-2 pt-2 border-t border-gray-200">
                        <span className="text-xs font-bold text-gray-600 mr-2">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>
                        <div className="flex gap-3 inline-flex">
                          <label className="flex items-center gap-1 cursor-pointer">
                            <input 
                              type="radio" 
                              name={`status-${room.id}`}
                              checked={!room.status || room.status === 'normal'}
                              onChange={() => {
                                const newRooms = [...editingRooms];
                                newRooms[index] = { ...newRooms[index], status: 'normal' };
                                setEditingRooms(newRooms);
                              }}
                              className="text-blue-600"
                            />
                            <span className="text-xs">é€šå¸¸</span>
                          </label>
                          <label className="flex items-center gap-1 cursor-pointer">
                            <input 
                              type="radio" 
                              name={`status-${room.id}`}
                              checked={room.status === 'hospitalized'}
                              onChange={() => {
                                const newRooms = [...editingRooms];
                                newRooms[index] = { ...newRooms[index], status: 'hospitalized' };
                                setEditingRooms(newRooms);
                              }}
                              className="text-yellow-600"
                            />
                            <span className="text-xs bg-yellow-100 px-1 rounded border border-yellow-200">å…¥é™¢</span>
                          </label>
                          <label className="flex items-center gap-1 cursor-pointer">
                            <input 
                              type="radio" 
                              name={`status-${room.id}`}
                              checked={room.status === 'moved_out'}
                              onChange={() => {
                                const newRooms = [...editingRooms];
                                newRooms[index] = { ...newRooms[index], status: 'moved_out' };
                                setEditingRooms(newRooms);
                              }}
                              className="text-red-600"
                            />
                            <span className="text-xs bg-red-100 px-1 rounded border border-red-200">é€€å»</span>
                          </label>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
                
                <div className="flex gap-2 mt-4">
                  <button
                    onClick={() => setShowRoomEditor(false)}
                    className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded font-bold"
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                  <button
                    onClick={() => {
                      if (isFirebaseEnabled && database) {
                        saveHistory();
                        setRooms(editingRooms); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
                        database.ref('data/' + STORAGE_KEY_ROOMS).set(editingRooms);
                      } else {
                        setRooms(editingRooms);
                      }
                      setShowRoomEditor(false);
                    }}
                    className="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded font-bold"
                  >
                    ä¿å­˜
                  </button>
                </div>
                
                <div className="mt-4 text-center">
                  <button
                    onClick={() => {
                      if (window.confirm('éƒ¨å±‹æ¡ä»¶ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                        saveHistory();
                        setEditingRooms(JSON.parse(JSON.stringify(INITIAL_ROOMS)));
                      }
                    }}
                    className="text-xs text-gray-400 hover:text-red-500 underline"
                  >
                    åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* é£Ÿäº‹ä¼ç¥¨ãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {showMealTicketModal && editingMealTicket && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg shadow-xl p-6 w-[700px] max-w-[95vw] max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="font-bold text-gray-800 text-lg">ğŸ½ï¸ é£Ÿäº‹æŒ‡ç¤ºç®‹</h3>
                  <button 
                    onClick={() => {
                      setShowMealTicketModal(false);
                      setEditingMealTicket(null);
                    }} 
                    className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
                  >&times;</button>
                </div>
                
                {/* å‰å›ã®ä¼ç¥¨ã‚’è¤‡å†™ãƒœã‚¿ãƒ³ & å‰Šé™¤ãƒœã‚¿ãƒ³ */}
                <div className="mb-4 flex justify-between items-center">
                  <button
                    onClick={() => {
                      // åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éå»ã®ä¼ç¥¨ã‚’æ¢ã™ï¼ˆç¾åœ¨ã®ä¼ç¥¨ã¯é™¤ãï¼‰
                      const currentKey = `${editingMealTicket.userId}_${editingMealTicket.startDate}_${editingMealTicket.endDate}`;
                      const userTickets = Object.entries(mealTickets)
                        .filter(([key, ticket]) => 
                          ticket.userId === editingMealTicket.userId && key !== currentKey
                        )
                        .map(([key, ticket]) => ({ key, ticket, startDate: ticket.startDate }))
                        .sort((a, b) => b.startDate.localeCompare(a.startDate)); // æ–°ã—ã„é †
                      
                      if (userTickets.length === 0) {
                        alert('ã“ã®åˆ©ç”¨è€…ã®éå»ã®ä¼ç¥¨ãŒã‚ã‚Šã¾ã›ã‚“');
                        return;
                      }
                      
                      const lastTicket = userTickets[0].ticket;
                      setEditingMealTicket({
                        ...editingMealTicket,
                        // æ—¥ä»˜ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯ç¾åœ¨ã®ã¾ã¾
                        unit: lastTicket.unit || 'æ¨¹',
                        startMeal: lastTicket.startMeal || '',
                        endMeal: lastTicket.endMeal || '',
                        category: lastTicket.category || '',
                        reason: lastTicket.reason || '',
                        foodType: lastTicket.foodType || '',
                        diabetesKcal: lastTicket.diabetesKcal || '',
                        mainDish: lastTicket.mainDish || '',
                        mainDishOther: lastTicket.mainDishOther || '',
                        sideDish: lastTicket.sideDish || '',
                        sideDishOther: lastTicket.sideDishOther || '',
                        drink: lastTicket.drink || '',
                        snack: lastTicket.snack || '',
                        memo: lastTicket.memo || ''
                      });
                      alert(`${lastTicket.startDate}ã€œã®ä¼ç¥¨å†…å®¹ã‚’è¤‡å†™ã—ã¾ã—ãŸ`);
                    }}
                    className="w-1/2 bg-orange-500 hover:bg-orange-600 text-white py-2 rounded-lg font-bold shadow-md flex items-center justify-center gap-2"
                  >
                    ğŸ“‹ å‰å›ã®ä¼ç¥¨ã‚’è¤‡å†™
                  </button>
                  
                  {/* å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆä¿å­˜æ¸ˆã¿ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ */}
                  {(() => {
                    const ticketKey = `${editingMealTicket.userId}_${editingMealTicket.startDate}_${editingMealTicket.endDate}`;
                    const exists = mealTickets[ticketKey];
                    if (!exists) return null;
                    return (
                      <button
                        onClick={async () => {
                          if (window.confirm(`ã“ã®ä¼ç¥¨ï¼ˆ${editingMealTicket.startDate}ã€œ${editingMealTicket.endDate}ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                            saveHistory();
                            const ticketKey = `${editingMealTicket.userId}_${editingMealTicket.startDate}_${editingMealTicket.endDate}`;
                            
                            // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
                            setMealTickets(prev => {
                              const newTickets = { ...prev };
                              delete newTickets[ticketKey];
                              return newTickets;
                            });

                            if (isFirebaseEnabled && database) {
                              const updates = {};
                              updates[`data/${STORAGE_KEY_MEAL_TICKETS}/${ticketKey}`] = null;
                              await database.ref().update(updates);
                            }
                            setShowMealTicketModal(false);
                            setEditingMealTicket(null);
                            alert('ä¼ç¥¨ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                          }
                        }}
                        className="w-1/4 bg-red-100 hover:bg-red-200 text-red-600 py-2 rounded font-bold border border-red-300 text-sm"
                      >
                        ğŸ—‘ï¸ å‰Šé™¤
                      </button>
                    );
                  })()}
                </div>
                
                {/* åˆ©ç”¨æœŸé–“é¸æŠ */}
                <div className="bg-blue-50 p-3 rounded border border-blue-200 mb-4">
                  <label className="text-sm font-bold text-blue-700 block mb-2">ğŸ“… åˆ©ç”¨æœŸé–“ã‚’é¸æŠ</label>
                  <select
                    value={`${editingMealTicket.startDate}_${editingMealTicket.endDate}`}
                    onChange={(e) => {
                      const [start, end] = e.target.value.split('_');
                      const ticketKey = `${editingMealTicket.userId}_${start}_${end}`;
                      const existingTicket = mealTickets[ticketKey];
                      if (existingTicket) {
                        setEditingMealTicket(existingTicket);
                      } else {
                        const user = users.find(u => u.id === editingMealTicket.userId);
                        const defaultMealPref = user?.mealPref || {};
                        setEditingMealTicket({
                          ...editingMealTicket,
                          startDate: start,
                          endDate: end,
                          unit: 'æ¨¹',
                          startMeal: '',
                          endMeal: '',
                          category: '',
                          reason: '',
                          foodType: defaultMealPref.foodType || '',
                          diabetesKcal: '',
                          mainDish: defaultMealPref.mainDish || '',
                          mainDishOther: '',
                          sideDish: defaultMealPref.sideDish || '',
                          sideDishOther: '',
                          drink: defaultMealPref.drink || '',
                          snack: defaultMealPref.snack || '',
                          memo: defaultMealPref.allergy ? `ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼: ${defaultMealPref.allergy}` : ''
                        });
                      }
                    }}
                    className="w-full p-2 border rounded text-sm bg-white"
                  >
                    {(() => {
                      const user = users.find(u => u.id === editingMealTicket.userId);
                      if (!user || !user.stayDates || user.stayDates.length === 0) return null;
                      
                      // å½“æœˆã®åˆ©ç”¨æœŸé–“ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                      const monthStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
                      const periods = getStayPeriods(user.stayDates);
                      const currentMonthPeriods = periods.filter(period => {
                        const periodStart = period[0];
                        return periodStart.startsWith(monthStr);
                      });
                      
                      if (currentMonthPeriods.length === 0) {
                        // å½“æœˆã«æœŸé–“ãŒãªã„å ´åˆã¯å…¨æœŸé–“ã‚’è¡¨ç¤º
                        return periods.map((period, index) => {
                          const start = period[0];
                          const end = period[period.length - 1];
                          const ticketKey = `${user.id}_${start}_${end}`;
                          const hasTicket = mealTickets[ticketKey];
                          return (
                            <option key={index} value={`${start}_${end}`}>
                              {start} ï½ {end} {hasTicket ? 'âœ“ä½œæˆæ¸ˆã¿' : 'ï¼ˆæœªä½œæˆï¼‰'}
                            </option>
                          );
                        });
                      }
                      
                      return currentMonthPeriods.map((period, index) => {
                        const start = period[0];
                        const end = period[period.length - 1];
                        const ticketKey = `${user.id}_${start}_${end}`;
                        const hasTicket = mealTickets[ticketKey];
                        return (
                          <option key={index} value={`${start}_${end}`}>
                            {start} ï½ {end} {hasTicket ? 'âœ“ä½œæˆæ¸ˆã¿' : 'ï¼ˆæœªä½œæˆï¼‰'}
                          </option>
                        );
                      });
                    })()}
                  </select>
                  <p className="text-xs text-blue-600 mt-1">
                    â€» {currentMonth.getFullYear()}å¹´{currentMonth.getMonth() + 1}æœˆã®åˆ©ç”¨æœŸé–“ã‚’è¡¨ç¤ºä¸­
                  </p>
                </div>
                
                {/* åŸºæœ¬æƒ…å ±ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ */}
                <div className="bg-gray-50 p-3 rounded border mb-4">
                  <div className="grid grid-cols-2 gap-2 text-sm">
                    <div><span className="text-gray-500">åˆ©ç”¨è€…:</span> <span className="font-bold">{users.find(u => u.id === editingMealTicket.userId)?.name}</span></div>
                    <div><span className="text-gray-500">ãƒ•ãƒªã‚¬ãƒŠ:</span> <span className="font-bold">{users.find(u => u.id === editingMealTicket.userId)?.furigana}</span></div>
                    <div><span className="text-gray-500">é–‹å§‹æ—¥:</span> <span className="font-bold">{editingMealTicket.startDate}</span></div>
                    <div><span className="text-gray-500">çµ‚äº†æ—¥:</span> <span className="font-bold">{editingMealTicket.endDate}</span></div>
                  </div>
                </div>

                {/* ãƒ¦ãƒ‹ãƒƒãƒˆå…¥åŠ› */}
                <div className="mb-4">
                  <label className="text-sm font-bold text-gray-600 block mb-1">ãƒ¦ãƒ‹ãƒƒãƒˆ</label>
                  <input
                    type="text"
                    placeholder="ä¾‹: 1F-A"
                    value={editingMealTicket.unit || ''}
                    onChange={(e) => setEditingMealTicket({...editingMealTicket, unit: e.target.value})}
                    className="w-full p-2 border rounded text-sm"
                  />
                </div>

                {/* é–‹å§‹ãƒ»çµ‚äº†ã®é£Ÿäº‹ */}
                <div className="grid grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="text-sm font-bold text-gray-600 block mb-1">é–‹å§‹æ—¥ ä»¤å’Œ {editingMealTicket.startDate ? (() => {
                      const d = parseLocalDate(editingMealTicket.startDate);
                      return `${d.getFullYear() - 2018}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
                    })() : ''}</label>
                    <select
                      value={editingMealTicket.startMeal || ''}
                      onChange={(e) => setEditingMealTicket({...editingMealTicket, startMeal: e.target.value})}
                      className="w-full p-2 border rounded text-sm"
                    >
                      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                      {MEAL_TIMING.map(t => (
                        <option key={t.key} value={t.key}>{t.label}</option>
                      ))}
                    </select>
                    <span className="text-xs text-gray-500">ã‹ã‚‰</span>
                  </div>
                  <div>
                    <label className="text-sm font-bold text-gray-600 block mb-1">çµ‚äº†æ—¥ ä»¤å’Œ {editingMealTicket.endDate ? (() => {
                      const d = parseLocalDate(editingMealTicket.endDate);
                      return `${d.getFullYear() - 2018}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
                    })() : ''}</label>
                    <select
                      value={editingMealTicket.endMeal || ''}
                      onChange={(e) => setEditingMealTicket({...editingMealTicket, endMeal: e.target.value})}
                      className="w-full p-2 border rounded text-sm"
                    >
                      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                      {MEAL_TIMING.map(t => (
                        <option key={t.key} value={t.key}>{t.label}</option>
                      ))}
                    </select>
                    <span className="text-xs text-gray-500">ã¾ã§</span>
                  </div>
                </div>

                {/* åŒºåˆ†ãƒ»ç†ç”± */}
                <div className="grid grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="text-sm font-bold text-gray-600 block mb-1">åŒºåˆ†</label>
                    <select
                      value={editingMealTicket.category || ''}
                      onChange={(e) => setEditingMealTicket({...editingMealTicket, category: e.target.value})}
                      className="w-full p-2 border rounded text-sm"
                    >
                      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                      {MEAL_CATEGORY.map(c => (
                        <option key={c.key} value={c.key}>{c.label}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="text-sm font-bold text-gray-600 block mb-1">ç†ç”±</label>
                    <select
                      value={editingMealTicket.reason || ''}
                      onChange={(e) => setEditingMealTicket({...editingMealTicket, reason: e.target.value})}
                      className="w-full p-2 border rounded text-sm"
                    >
                      <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                      {MEAL_REASON.map(r => (
                        <option key={r.key} value={r.key}>{r.label}</option>
                      ))}
                    </select>
                  </div>
                </div>

                {/* é£Ÿç¨® */}
                <div className="mb-4">
                  <label className="text-sm font-bold text-gray-600 block mb-1">é£Ÿç¨®</label>
                  <div className="flex flex-wrap gap-2">
                    {MEAL_FOOD_TYPES.map(f => (
                      <label key={f.key} className={`flex items-center gap-1 cursor-pointer px-2 py-1 rounded border text-xs
                        ${editingMealTicket.foodType === f.key ? 'bg-blue-100 border-blue-400' : 'bg-white hover:bg-gray-50'}`}>
                        <input 
                          type="radio" 
                          name="foodType"
                          checked={editingMealTicket.foodType === f.key}
                          onChange={() => setEditingMealTicket({...editingMealTicket, foodType: f.key})}
                          className="hidden"
                        />
                        <span>{f.label}</span>
                      </label>
                    ))}
                  </div>
                  {editingMealTicket.foodType === 'diabetes' && (
                    <div className="mt-2">
                      <input
                        type="text"
                        placeholder="kcalå…¥åŠ›"
                        value={editingMealTicket.diabetesKcal || ''}
                        onChange={(e) => setEditingMealTicket({...editingMealTicket, diabetesKcal: e.target.value})}
                        className="p-1 border rounded text-sm w-24"
                      />
                      <span className="text-xs text-gray-500 ml-1">kcal</span>
                    </div>
                  )}
                </div>

                {/* ä¸»é£Ÿ */}
                <div className="mb-4">
                  <label className="text-sm font-bold text-gray-600 block mb-1">ä¸»é£Ÿ</label>
                  <div className="flex flex-wrap gap-2">
                    {MEAL_MAIN_DISH.map(m => (
                      <label key={m.key} className={`flex items-center gap-1 cursor-pointer px-2 py-1 rounded border text-xs
                        ${editingMealTicket.mainDish === m.key ? 'bg-blue-100 border-blue-400' : 'bg-white hover:bg-gray-50'}`}>
                        <input 
                          type="radio" 
                          name="mainDish"
                          checked={editingMealTicket.mainDish === m.key}
                          onChange={() => setEditingMealTicket({...editingMealTicket, mainDish: m.key})}
                          className="hidden"
                        />
                        <span>{m.label}</span>
                      </label>
                    ))}
                  </div>
                  {editingMealTicket.mainDish === 'other' && (
                    <input
                      type="text"
                      placeholder="ãã®ä»–ã®ä¸»é£Ÿ"
                      value={editingMealTicket.mainDishOther || ''}
                      onChange={(e) => setEditingMealTicket({...editingMealTicket, mainDishOther: e.target.value})}
                      className="mt-2 p-1 border rounded text-sm w-full"
                    />
                  )}
                </div>

                {/* å‰¯é£Ÿ */}
                <div className="mb-4">
                  <label className="text-sm font-bold text-gray-600 block mb-1">å‰¯é£Ÿ</label>
                  <div className="flex flex-wrap gap-2">
                    {MEAL_SIDE_DISH.map(s => (
                      <label key={s.key} className={`flex items-center gap-1 cursor-pointer px-2 py-1 rounded border text-xs
                        ${editingMealTicket.sideDish === s.key ? 'bg-blue-100 border-blue-400' : 'bg-white hover:bg-gray-50'}`}>
                        <input 
                          type="radio" 
                          name="sideDish"
                          checked={editingMealTicket.sideDish === s.key}
                          onChange={() => setEditingMealTicket({...editingMealTicket, sideDish: s.key})}
                          className="hidden"
                        />
                        <span>{s.label}</span>
                      </label>
                    ))}
                  </div>
                  {editingMealTicket.sideDish === 'other' && (
                    <input
                      type="text"
                      placeholder="ãã®ä»–ã®å‰¯é£Ÿ"
                      value={editingMealTicket.sideDishOther || ''}
                      onChange={(e) => setEditingMealTicket({...editingMealTicket, sideDishOther: e.target.value})}
                      className="mt-2 p-1 border rounded text-sm w-full"
                    />
                  )}
                </div>

                {/* é£²ã¿ç‰©ãƒ»é–“é£Ÿ */}
                <div className="grid grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="text-sm font-bold text-gray-600 block mb-1">é£²ã¿ç‰©</label>
                    <div className="flex gap-2">
                      {MEAL_DRINK.map(d => (
                        <label key={d.key} className={`flex items-center gap-1 cursor-pointer px-3 py-1 rounded border text-sm
                          ${editingMealTicket.drink === d.key ? 'bg-blue-100 border-blue-400' : 'bg-white hover:bg-gray-50'}`}>
                          <input 
                            type="radio" 
                            name="drink"
                            checked={editingMealTicket.drink === d.key}
                            onChange={() => setEditingMealTicket({...editingMealTicket, drink: d.key})}
                            className="hidden"
                          />
                          <span>{d.label}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                  <div>
                    <label className="text-sm font-bold text-gray-600 block mb-1">é–“é£Ÿ</label>
                    <div className="flex gap-2">
                      {MEAL_SNACK.map(s => (
                        <label key={s.key} className={`flex items-center gap-1 cursor-pointer px-3 py-1 rounded border text-sm
                          ${editingMealTicket.snack === s.key ? 'bg-blue-100 border-blue-400' : 'bg-white hover:bg-gray-50'}`}>
                          <input 
                            type="radio" 
                            name="snack"
                            checked={editingMealTicket.snack === s.key}
                            onChange={() => setEditingMealTicket({...editingMealTicket, snack: s.key})}
                            className="hidden"
                          />
                          <span>{s.label}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                </div>

                {/* ãƒ¡ãƒ¢ */}
                <div className="mb-4">
                  <label className="text-sm font-bold text-gray-600 block mb-1">ãƒ¡ãƒ¢</label>
                  <textarea
                    value={editingMealTicket.memo || ''}
                    onChange={(e) => setEditingMealTicket({...editingMealTicket, memo: e.target.value})}
                    className="w-full p-2 border rounded text-sm"
                    rows={2}
                    placeholder="å‚™è€ƒãŒã‚ã‚Œã°å…¥åŠ›"
                  />
                </div>

                {/* ãƒœã‚¿ãƒ³ */}
                <div className="flex gap-2">
                  <button
                    onClick={() => {
                      setShowMealTicketModal(false);
                      setEditingMealTicket(null);
                    }}
                    className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded font-bold"
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                  <button
                    onClick={async () => {
                      try {
                        saveHistory();
                        // ä¿å­˜
                        const ticketKey = `${editingMealTicket.userId}_${editingMealTicket.startDate}_${editingMealTicket.endDate}`;
                        
                        // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
                        setMealTickets(prev => ({
                          ...prev,
                          [ticketKey]: editingMealTicket
                        }));

                        if (isFirebaseEnabled && database) {
                          const updates = {};
                          updates[`data/${STORAGE_KEY_MEAL_TICKETS}/${ticketKey}`] = editingMealTicket;
                          await database.ref().update(updates);
                        }
                        alert('ä¿å­˜ã—ã¾ã—ãŸã€‚ç¶šã‘ã¦ç·¨é›†ã‚„PDFå‡ºåŠ›ãŒã§ãã¾ã™ã€‚');
                      } catch (e) {
                        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
                      }
                    }}
                    className="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded font-bold"
                  >
                    ä¿å­˜
                  </button>
                  <button
                    onClick={() => {
                      // PDFå‡ºåŠ›
                      const ticketKey = `${editingMealTicket.userId}_${editingMealTicket.startDate}_${editingMealTicket.endDate}`;
                      saveHistory();
                      // å…ˆã«ä¿å­˜
                      setMealTickets(prev => ({
                        ...prev,
                        [ticketKey]: editingMealTicket
                      }));
                      // PDFç”Ÿæˆ
                      generateMealTicketPDF(editingMealTicket);
                    }}
                    className="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded font-bold"
                  >
                    ğŸ“„ PDFå‡ºåŠ›
                  </button>
                </div>
              </div>
            </div>
          )}

          <div className={`grid grid-cols-1 ${sidebarCollapsed ? '' : 'lg:grid-cols-5'} gap-6 print-block`}>
            {/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */}
            <Sidebar
              sidebarCollapsed={sidebarCollapsed}
              setSidebarCollapsed={setSidebarCollapsed}
              userSortOrder={userSortOrder}
              setUserSortOrder={setUserSortOrder}
              userSearchQuery={userSearchQuery}
              users={users}
              currentMonth={currentMonth}
              handleEditUser={handleEditUser}
              deleteUser={deleteUser}
              archiveUser={archiveUser}
              setShowArchivedModal={setShowArchivedModal}
              newUserOpen={newUserOpen}
              setNewUserOpen={setNewUserOpen}
              setSelectionStart={setSelectionStart}
              setEditingUser={setEditingUser}
              setNewUserData={setNewUserData}
              setTempFixedPeriod={setTempFixedPeriod}
              setTempFixedRoomId={setTempFixedRoomId}
              setCalendarMonth={setCalendarMonth}
              mealTickets={mealTickets}
              setEditingMealTicket={setEditingMealTicket}
              setShowMealTicketModal={setShowMealTicketModal}
              rooms={rooms}
              setEditingRooms={setEditingRooms}
              setShowRoomEditor={setShowRoomEditor}
              clearAllData={clearAllData}
              newUserData={newUserData}
              handleSaveUser={handleSaveUser}
              clearSelectedDates={clearSelectedDates}
              renderCalendarGrid={renderCalendarGrid}
              tempFixedPeriod={tempFixedPeriod}
              tempFixedRoomId={tempFixedRoomId}
              tempRooms={tempRooms}
              toggleCondition={toggleCondition}
              CONDITIONS={CONDITIONS}
              BATH_TYPES={BATH_TYPES}
              TEMP_ROOM_1_ID={TEMP_ROOM_1_ID}
              TEMP_ROOM_2_ID={TEMP_ROOM_2_ID}
            />
            
            {/* éè¡¨ç¤ºåˆ©ç”¨è€…ãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« */}
            {showArchivedModal && (
              <ArchivedUserListModal
                users={users}
                onClose={() => setShowArchivedModal(false)}
                onUnarchive={unarchiveUser}
                onDelete={deleteUser}
              />
            )}

                {newUserOpen && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl p-5 w-[400px] max-w-[90vw] max-h-[85vh] overflow-y-auto">
                    <div className="flex justify-between items-center mb-3">
                      <h3 className="font-bold text-gray-700 text-lg">{editingUser ? 'åˆ©ç”¨è€…æƒ…å ±ã®ç·¨é›†' : 'æ–°è¦ç™»éŒ²'}</h3>
                      <button onClick={() => {
                        setNewUserOpen(false);
                        setEditingUser(null);
                        setNewUserData({ 
                          name: '', 
                          furigana: '', 
                          gender: '',
                          birthDate: '',
                          birthDateMode: 'wareki',
                          birthEra: '',
                          birthYear: '',
                          birthMonth: '',
                          birthDay: '',
                          conditions: [], 
                          stayDates: [], 
                          fixedRooms: {}, 
                          bathType: '',
                          medical: { insulin: false, gastrostomy: false, oxygenTherapy: false, balloonCatheter: false, stoma: false, note: '' },
                          transport: { pickupTime: '', dropoffTime: '', address: '', pickupMethod: '', wheelchairNeeded: false, note: '' },
                          careManager: { officeName: '', staffName: '', phone: '', fax: '', mobile: '' },
                          mealPref: { foodType: '', mainDish: '', sideDish: '', drink: '', snack: '', allergy: '' },
                          isLongTerm: false, longTermStartDate: '', longTermEndDate: ''
                        });
                        setTempFixedPeriod('');
                        setTempFixedRoomId('');
                        setCalendarMonth(currentMonth);
                      }} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                    </div>
                    <input 
                      type="text" 
                      placeholder="æ°å" 
                      className="w-full p-2 border rounded mb-2 bg-white"
                      value={newUserData.name}
                      onChange={(e) => setNewUserData({...newUserData, name: e.target.value})}
                    />
                    <input 
                      type="text" 
                      placeholder="ãƒ•ãƒªã‚¬ãƒŠï¼ˆã‚«ã‚¿ã‚«ãƒŠãƒ»50éŸ³é †ç”¨ï¼‰" 
                      className="w-full p-2 border rounded mb-3 bg-white text-sm text-gray-600"
                      value={newUserData.furigana}
                      onChange={(e) => setNewUserData({...newUserData, furigana: e.target.value})}
                      onBlur={(e) => setNewUserData({...newUserData, furigana: hiraganaToKatakana(e.target.value)})}
                    />
                    
                    {/* æ€§åˆ¥ãƒ»ç”Ÿå¹´æœˆæ—¥ãƒ»ãƒ¦ãƒ‹ãƒƒãƒˆ */}
                    <div className="mb-3">
                      <label className="text-xs text-gray-500 block mb-1">æ€§åˆ¥</label>
                      <select
                        value={newUserData.gender || ''}
                        onChange={(e) => setNewUserData({...newUserData, gender: e.target.value})}
                        className="w-full p-2 border rounded bg-white text-sm"
                      >
                        <option value="">é¸æŠ</option>
                        <option value="male">ç”·æ€§</option>
                        <option value="female">å¥³æ€§</option>
                      </select>
                    </div>
                    <div className="mb-3">
                      <div className="flex items-center justify-between mb-1">
                        <label className="text-xs text-gray-500">ç”Ÿå¹´æœˆæ—¥</label>
                        <label className="flex items-center gap-1 text-xs text-gray-500 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={newUserData.birthDateMode === 'western'}
                            onChange={(e) => setNewUserData({...newUserData, birthDateMode: e.target.checked ? 'western' : 'wareki'})}
                            className="rounded"
                          />
                          è¥¿æš¦å…¥åŠ›
                        </label>
                      </div>
                      {newUserData.birthDateMode === 'western' ? (
                        <input 
                          type="date" 
                          className="w-full p-2 border rounded bg-white text-sm"
                          value={newUserData.birthDate || ''}
                          onChange={(e) => setNewUserData({...newUserData, birthDate: e.target.value})}
                        />
                      ) : (
                        <div className="flex gap-1">
                          <select
                            value={newUserData.birthEra || ''}
                            onChange={(e) => {
                              const era = e.target.value;
                              setNewUserData({...newUserData, birthEra: era});
                            }}
                            className="p-2 border rounded bg-white text-sm"
                          >
                            <option value="">å…ƒå·</option>
                            <option value="reiwa">ä»¤å’Œ</option>
                            <option value="heisei">å¹³æˆ</option>
                            <option value="showa">æ˜­å’Œ</option>
                            <option value="taisho">å¤§æ­£</option>
                          </select>
                          <input
                            type="number"
                            placeholder="å¹´"
                            min="1"
                            max="99"
                            className="w-16 p-2 border rounded bg-white text-sm"
                            value={newUserData.birthYear || ''}
                            onChange={(e) => {
                              const year = e.target.value;
                              setNewUserData({...newUserData, birthYear: year});
                              // å’Œæš¦ã‹ã‚‰è¥¿æš¦ã«å¤‰æ›ã—ã¦birthDateã‚‚æ›´æ–°
                              if (newUserData.birthEra && year && newUserData.birthMonth && newUserData.birthDay) {
                                const eraStart = {reiwa: 2018, heisei: 1988, showa: 1925, taisho: 1911};
                                const westernYear = eraStart[newUserData.birthEra] + parseInt(year);
                                const dateStr = `${westernYear}-${String(newUserData.birthMonth).padStart(2,'0')}-${String(newUserData.birthDay).padStart(2,'0')}`;
                                setNewUserData(prev => ({...prev, birthYear: year, birthDate: dateStr}));
                              }
                            }}
                          />
                          <select
                            value={newUserData.birthMonth || ''}
                            onChange={(e) => {
                              const month = e.target.value;
                              setNewUserData({...newUserData, birthMonth: month});
                              if (newUserData.birthEra && newUserData.birthYear && month && newUserData.birthDay) {
                                const eraStart = {reiwa: 2018, heisei: 1988, showa: 1925, taisho: 1911};
                                const westernYear = eraStart[newUserData.birthEra] + parseInt(newUserData.birthYear);
                                const dateStr = `${westernYear}-${String(month).padStart(2,'0')}-${String(newUserData.birthDay).padStart(2,'0')}`;
                                setNewUserData(prev => ({...prev, birthMonth: month, birthDate: dateStr}));
                              }
                            }}
                            className="p-2 border rounded bg-white text-sm"
                          >
                            <option value="">æœˆ</option>
                            {[...Array(12)].map((_, i) => <option key={i+1} value={i+1}>{i+1}æœˆ</option>)}
                          </select>
                          <select
                            value={newUserData.birthDay || ''}
                            onChange={(e) => {
                              const day = e.target.value;
                              setNewUserData({...newUserData, birthDay: day});
                              if (newUserData.birthEra && newUserData.birthYear && newUserData.birthMonth && day) {
                                const eraStart = {reiwa: 2018, heisei: 1988, showa: 1925, taisho: 1911};
                                const westernYear = eraStart[newUserData.birthEra] + parseInt(newUserData.birthYear);
                                const dateStr = `${westernYear}-${String(newUserData.birthMonth).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                                setNewUserData(prev => ({...prev, birthDay: day, birthDate: dateStr}));
                              }
                            }}
                            className="p-2 border rounded bg-white text-sm"
                          >
                            <option value="">æ—¥</option>
                            {[...Array(31)].map((_, i) => <option key={i+1} value={i+1}>{i+1}æ—¥</option>)}
                          </select>
                        </div>
                      )}
                      {newUserData.birthDate && (
                        <p className="text-xs text-gray-500 mt-1">
                          â†’ {(() => {
                            const d = parseLocalDate(newUserData.birthDate);
                            const year = d.getFullYear();
                            let era = '', eraYear = 0;
                            if (year >= 2019) { era = 'ä»¤å’Œ'; eraYear = year - 2018; }
                            else if (year >= 1989) { era = 'å¹³æˆ'; eraYear = year - 1988; }
                            else if (year >= 1926) { era = 'æ˜­å’Œ'; eraYear = year - 1925; }
                            else { era = 'å¤§æ­£'; eraYear = year - 1911; }
                            return `${era}${eraYear}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ (${year}å¹´)`;
                          })()}
                        </p>
                      )}
                    </div>
                    
                    <div className="mb-3">
                      <p className="text-xs font-bold text-gray-600 mb-1">æ¡ä»¶è¨­å®š:</p>
                      <div className="flex flex-col gap-1">
                        {CONDITIONS.map(cond => (
                          <label key={cond.key} className="flex items-center gap-2 cursor-pointer hover:bg-blue-100 p-1 rounded border border-transparent hover:border-blue-200">
                            <input 
                              type="checkbox" 
                              checked={newUserData.conditions.includes(cond.key)}
                              onChange={() => toggleCondition(cond.key)}
                              className="rounded text-blue-600"
                            />
                            <span className="text-xs text-gray-700">{cond.label}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <div className="mb-3">
                      <p className="text-xs font-bold text-gray-600 mb-1">å…¥æµ´æ–¹æ³•:</p>
                      <div className="flex flex-wrap gap-2">
                        {BATH_TYPES.map(bath => (
                          <label key={bath.key} className="flex items-center gap-1 cursor-pointer">
                            <input 
                              type="radio" 
                              name="bathType"
                              value={bath.key}
                              checked={newUserData.bathType === bath.key}
                              onChange={(e) => setNewUserData({...newUserData, bathType: e.target.value})}
                              className="text-blue-600"
                            />
                            <span className="text-xs text-gray-700">{bath.label}</span>
                          </label>
                        ))}
                        <label className="flex items-center gap-1 cursor-pointer">
                          <input 
                            type="radio" 
                            name="bathType"
                            value=""
                            checked={newUserData.bathType === ''}
                            onChange={(e) => setNewUserData({...newUserData, bathType: ''})}
                            className="text-blue-600"
                          />
                          <span className="text-xs text-gray-400">æœªè¨­å®š</span>
                        </label>
                      </div>
                    </div>

                    <div className="mb-3">
                      <p className="text-xs font-bold text-gray-600 mb-1">ğŸ”’ éƒ¨å±‹å›ºå®š:</p>
                      
                      {/* å›ºå®šè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */}
                      <div className="bg-gray-50 p-2 rounded border border-gray-200 mb-2">
                        <div className="flex flex-col gap-2">
                          <select 
                            value={tempFixedPeriod} 
                            onChange={(e) => setTempFixedPeriod(e.target.value)}
                            className="p-1 border rounded text-xs w-full"
                          >
                            <option value="">æœŸé–“ã‚’é¸æŠ</option>
                            {getStayPeriods(newUserData.stayDates).map((p) => {
                              const key = `${p[0]}_${p[p.length-1]}`;
                              return <option key={key} value={key}>{p[0]} ï½ {p[p.length-1]}</option>;
                            })}
                          </select>
                          <div className="flex gap-2">
                            <select
                              value={tempFixedRoomId}
                              onChange={(e) => setTempFixedRoomId(e.target.value)}
                              className="flex-1 p-1 border rounded text-xs"
                            >
                              <option value="">éƒ¨å±‹ã‚’é¸æŠ</option>
                              <optgroup label="å±…å®¤">
                                {rooms.map(r => <option key={r.id} value={r.id}>{r.name} ({r.label || 'é€šå¸¸'})</option>)}
                              </optgroup>
                              <optgroup label="ä¸€æ™‚ä¿ç®¡ãƒ»ç©ºåºŠ">
                                <option value={TEMP_ROOM_1_ID}>ä¸€æ™‚ä¿ç®¡â‘ </option>
                                <option value={TEMP_ROOM_2_ID}>ä¸€æ™‚ä¿ç®¡â‘¡</option>
                                {tempRooms.sort((a, b) => a.month.localeCompare(b.month) || a.name.localeCompare(b.name)).map(r => (
                                  <option key={r.id} value={r.id}>{r.name} ({r.month})</option>
                                ))}
                              </optgroup>
                            </select>
                            <button
                              onClick={() => {
                                if (!tempFixedPeriod || !tempFixedRoomId) return;
                                setNewUserData(prev => ({
                                  ...prev,
                                  fixedRooms: { ...(prev.fixedRooms || {}), [tempFixedPeriod]: tempFixedRoomId }
                                }));
                                setTempFixedPeriod('');
                                setTempFixedRoomId('');
                              }}
                              disabled={!tempFixedPeriod || !tempFixedRoomId}
                              className="bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold disabled:bg-gray-300"
                            >
                              è¿½åŠ 
                            </button>
                          </div>
                        </div>
                      </div>

                      {newUserData.fixedRooms && Object.keys(newUserData.fixedRooms).length > 0 ? (
                        <div className="mt-2 text-xs space-y-1">
                          <span className="text-yellow-600 font-bold block">ç¾åœ¨ã®å›ºå®š: </span>
                          {Object.entries(newUserData.fixedRooms).map(([period, roomId]) => (
                            <div key={period} className="flex items-center justify-between bg-yellow-50 px-2 py-1 rounded border border-yellow-100">
                              <span>{period.replace('_', 'ã€œ')} â†’ {roomId}å·å®¤</span>
                              <button
                                onClick={() => {
                                  setNewUserData(prev => {
                                    const newFixed = { ...prev.fixedRooms };
                                    delete newFixed[period];
                                    return { ...prev, fixedRooms: newFixed };
                                  });
                                }}
                                className="text-red-500 hover:text-red-700 font-bold ml-2"
                                title="è§£é™¤"
                              >
                                âœ•
                              </button>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <p className="text-xs text-gray-400 mt-1">å›ºå®šè¨­å®šã¯ã‚ã‚Šã¾ã›ã‚“</p>
                      )}
                    </div>

                    {/* åŒ»ç™‚æƒ…å ± */}
                    <div className="mb-3 p-3 bg-red-50 rounded border border-red-200">
                      <p className="text-xs font-bold text-red-700 mb-2">ğŸ¥ åŒ»ç™‚æƒ…å ±:</p>
                      <div className="flex flex-wrap gap-3 mb-2">
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input 
                            type="checkbox" 
                            checked={newUserData.medical?.insulin || false}
                            onChange={(e) => setNewUserData({...newUserData, medical: {...newUserData.medical, insulin: e.target.checked}})}
                            className="rounded text-red-600"
                          />
                          <span className="text-xs text-gray-700">ã‚¤ãƒ³ã‚¹ãƒªãƒ³</span>
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input 
                            type="checkbox" 
                            checked={newUserData.medical?.gastrostomy || false}
                            onChange={(e) => setNewUserData({...newUserData, medical: {...newUserData.medical, gastrostomy: e.target.checked}})}
                            className="rounded text-red-600"
                          />
                          <span className="text-xs text-gray-700">èƒƒã‚ã†</span>
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input 
                            type="checkbox" 
                            checked={newUserData.medical?.oxygenTherapy || false}
                            onChange={(e) => setNewUserData({...newUserData, medical: {...newUserData.medical, oxygenTherapy: e.target.checked}})}
                            className="rounded text-red-600"
                          />
                          <span className="text-xs text-gray-700">åœ¨å®…é…¸ç´ </span>
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input 
                            type="checkbox" 
                            checked={newUserData.medical?.balloonCatheter || false}
                            onChange={(e) => setNewUserData({...newUserData, medical: {...newUserData.medical, balloonCatheter: e.target.checked}})}
                            className="rounded text-red-600"
                          />
                          <span className="text-xs text-gray-700">ãƒãƒ«ãƒ³ã‚«ãƒ†ãƒ¼ãƒ†ãƒ«</span>
                        </label>
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input 
                            type="checkbox" 
                            checked={newUserData.medical?.stoma || false}
                            onChange={(e) => setNewUserData({...newUserData, medical: {...newUserData.medical, stoma: e.target.checked}})}
                            className="rounded text-red-600"
                          />
                          <span className="text-xs text-gray-700">ã‚¹ãƒˆãƒ</span>
                        </label>
                      </div>
                      <input 
                        type="text" 
                        placeholder="åŒ»ç™‚å‚™è€ƒï¼ˆè‡ªç”±è¨˜å…¥ï¼‰" 
                        className="w-full p-2 border rounded bg-white text-sm"
                        value={newUserData.medical?.note || ''}
                        onChange={(e) => setNewUserData({...newUserData, medical: {...newUserData.medical, note: e.target.value}})}
                      />
                    </div>

                    {/* é€è¿ãƒ‡ãƒ¼ã‚¿ */}
                    <div className="mb-3 p-3 bg-green-50 rounded border border-green-200">
                      <p className="text-xs font-bold text-green-700 mb-2">ğŸš— é€è¿æƒ…å ±:</p>
                      <div className="space-y-2">
                        <div className="grid grid-cols-2 gap-2">
                          <div>
                            <label className="text-[10px] text-gray-500">è¿ãˆæ™‚é–“</label>
                            <input 
                              type="text" 
                              placeholder="ä¾‹: 10:00" 
                              className="w-full p-2 border rounded bg-white text-sm"
                              value={newUserData.transport?.pickupTime || ''}
                              onChange={(e) => setNewUserData({...newUserData, transport: {...newUserData.transport, pickupTime: e.target.value}})}
                            />
                          </div>
                          <div>
                            <label className="text-[10px] text-gray-500">é€ã‚Šæ™‚é–“</label>
                            <input 
                              type="text" 
                              placeholder="ä¾‹: 15:00" 
                              className="w-full p-2 border rounded bg-white text-sm"
                              value={newUserData.transport?.dropoffTime || ''}
                              onChange={(e) => setNewUserData({...newUserData, transport: {...newUserData.transport, dropoffTime: e.target.value}})}
                            />
                          </div>
                        </div>
                        <input 
                          type="text" 
                          placeholder="ä½æ‰€" 
                          className="w-full p-2 border rounded bg-white text-sm"
                          value={newUserData.transport?.address || ''}
                          onChange={(e) => setNewUserData({...newUserData, transport: {...newUserData.transport, address: e.target.value}})}
                        />
                        <div className="flex flex-wrap gap-2 items-center">
                          <span className="text-xs text-gray-600">è¿ãˆæ–¹æ³•:</span>
                          {['æ–½è¨­é€è¿', 'å®¶æ—', 'ä»‹è­·ã‚¿ã‚¯ã‚·ãƒ¼'].map(method => (
                            <label key={method} className="flex items-center gap-1 cursor-pointer">
                              <input 
                                type="radio" 
                                name="pickupMethod"
                                value={method}
                                checked={newUserData.transport?.pickupMethod === method}
                                onChange={(e) => setNewUserData({...newUserData, transport: {...newUserData.transport, pickupMethod: e.target.value}})}
                                className="text-green-600"
                              />
                              <span className="text-xs text-gray-700">{method}</span>
                            </label>
                          ))}
                          <label className="flex items-center gap-1 cursor-pointer">
                            <input 
                              type="radio" 
                              name="pickupMethod"
                              value=""
                              checked={!newUserData.transport?.pickupMethod}
                              onChange={(e) => setNewUserData({...newUserData, transport: {...newUserData.transport, pickupMethod: ''}})}
                              className="text-green-600"
                            />
                            <span className="text-xs text-gray-400">æœªè¨­å®š</span>
                          </label>
                        </div>
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input 
                            type="checkbox" 
                            checked={newUserData.transport?.wheelchairNeeded || false}
                            onChange={(e) => setNewUserData({...newUserData, transport: {...newUserData.transport, wheelchairNeeded: e.target.checked}})}
                            className="rounded text-green-600"
                          />
                          <span className="text-xs text-gray-700">è»Šã„ã™ã®ç”¨æ„ãŒå¿…è¦</span>
                        </label>
                        <input 
                          type="text" 
                          placeholder="é€è¿å‚™è€ƒ" 
                          className="w-full p-2 border rounded bg-white text-sm"
                          value={newUserData.transport?.note || ''}
                          onChange={(e) => setNewUserData({...newUserData, transport: {...newUserData.transport, note: e.target.value}})}
                        />
                      </div>
                    </div>

                    {/* å±…å®…ä»‹è­·æ”¯æ´äº‹æ¥­æ‰€ */}
                    <div className="mb-3 p-3 bg-purple-50 rounded border border-purple-200">
                      <p className="text-xs font-bold text-purple-700 mb-2">ğŸ“‹ å±…å®…ä»‹è­·æ”¯æ´äº‹æ¥­æ‰€:</p>
                      <div className="space-y-2">
                        <input 
                          type="text" 
                          placeholder="äº‹æ¥­æ‰€å" 
                          className="w-full p-2 border rounded bg-white text-sm"
                          value={newUserData.careManager?.officeName || ''}
                          onChange={(e) => setNewUserData({...newUserData, careManager: {...newUserData.careManager, officeName: e.target.value}})}
                        />
                        <input 
                          type="text" 
                          placeholder="æ‹…å½“ã‚±ã‚¢ãƒãƒå" 
                          className="w-full p-2 border rounded bg-white text-sm"
                          value={newUserData.careManager?.staffName || ''}
                          onChange={(e) => setNewUserData({...newUserData, careManager: {...newUserData.careManager, staffName: e.target.value}})}
                        />
                        <div className="grid grid-cols-2 gap-2">
                          <input 
                            type="text" 
                            placeholder="äº‹æ¥­æ‰€é›»è©±ç•ªå·" 
                            className="p-2 border rounded bg-white text-sm"
                            value={newUserData.careManager?.phone || ''}
                            onChange={(e) => setNewUserData({...newUserData, careManager: {...newUserData.careManager, phone: e.target.value}})}
                          />
                          <input 
                            type="text" 
                            placeholder="äº‹æ¥­æ‰€FAXç•ªå·" 
                            className="p-2 border rounded bg-white text-sm"
                            value={newUserData.careManager?.fax || ''}
                            onChange={(e) => setNewUserData({...newUserData, careManager: {...newUserData.careManager, fax: e.target.value}})}
                          />
                        </div>
                        <input 
                          type="text" 
                          placeholder="ã‚±ã‚¢ãƒãƒæºå¸¯ç•ªå·" 
                          className="w-full p-2 border rounded bg-white text-sm"
                          value={newUserData.careManager?.mobile || ''}
                          onChange={(e) => setNewUserData({...newUserData, careManager: {...newUserData.careManager, mobile: e.target.value}})}
                        />
                      </div>
                    </div>

                    {/* é£Ÿäº‹æƒ…å ±ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */}
                    <div className="mb-3 p-3 bg-orange-50 rounded border border-orange-200">
                      <p className="text-xs font-bold text-orange-700 mb-2">ğŸ½ï¸ é£Ÿäº‹æƒ…å ±ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰:</p>
                      {/* é£Ÿç¨® */}
                      <div className="mb-2">
                        <label className="text-xs text-gray-600 block mb-1">é£Ÿç¨®</label>
                        <select
                          value={newUserData.mealPref?.foodType || ''}
                          onChange={(e) => setNewUserData({...newUserData, mealPref: {...(newUserData.mealPref || {}), foodType: e.target.value}})}
                          className="w-full p-1 border rounded bg-white text-xs"
                        >
                          <option value="">æœªè¨­å®š</option>
                          {MEAL_FOOD_TYPES.map(f => <option key={f.key} value={f.key}>{f.label}</option>)}
                        </select>
                      </div>
                      {/* ä¸»é£Ÿãƒ»å‰¯é£Ÿ */}
                      <div className="grid grid-cols-2 gap-2 mb-2">
                        <div>
                          <label className="text-xs text-gray-600 block mb-1">ä¸»é£Ÿ</label>
                          <select
                            value={newUserData.mealPref?.mainDish || ''}
                            onChange={(e) => setNewUserData({...newUserData, mealPref: {...(newUserData.mealPref || {}), mainDish: e.target.value}})}
                            className="w-full p-1 border rounded bg-white text-xs"
                          >
                            <option value="">æœªè¨­å®š</option>
                            {MEAL_MAIN_DISH.map(m => <option key={m.key} value={m.key}>{m.label}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="text-xs text-gray-600 block mb-1">å‰¯é£Ÿ</label>
                          <select
                            value={newUserData.mealPref?.sideDish || ''}
                            onChange={(e) => setNewUserData({...newUserData, mealPref: {...(newUserData.mealPref || {}), sideDish: e.target.value}})}
                            className="w-full p-1 border rounded bg-white text-xs"
                          >
                            <option value="">æœªè¨­å®š</option>
                            {MEAL_SIDE_DISH.map(s => <option key={s.key} value={s.key}>{s.label}</option>)}
                          </select>
                        </div>
                      </div>
                      {/* é£²ã¿ç‰©ãƒ»é–“é£Ÿ */}
                      <div className="grid grid-cols-2 gap-2 mb-2">
                        <div>
                          <label className="text-xs text-gray-600 block mb-1">é£²ã¿ç‰©</label>
                          <select
                            value={newUserData.mealPref?.drink || ''}
                            onChange={(e) => setNewUserData({...newUserData, mealPref: {...(newUserData.mealPref || {}), drink: e.target.value}})}
                            className="w-full p-1 border rounded bg-white text-xs"
                          >
                            <option value="">æœªè¨­å®š</option>
                            {MEAL_DRINK.map(d => <option key={d.key} value={d.key}>{d.label}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="text-xs text-gray-600 block mb-1">é–“é£Ÿ</label>
                          <select
                            value={newUserData.mealPref?.snack || ''}
                            onChange={(e) => setNewUserData({...newUserData, mealPref: {...(newUserData.mealPref || {}), snack: e.target.value}})}
                            className="w-full p-1 border rounded bg-white text-xs"
                          >
                            <option value="">æœªè¨­å®š</option>
                            {MEAL_SNACK.map(s => <option key={s.key} value={s.key}>{s.label}</option>)}
                          </select>
                        </div>
                      </div>
                      {/* ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ */}
                      <div>
                        <label className="text-xs text-gray-600 block mb-1">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒ»ç¦é£Ÿ</label>
                        <input
                          type="text"
                          value={newUserData.mealPref?.allergy || ''}
                          onChange={(e) => setNewUserData({...newUserData, mealPref: {...(newUserData.mealPref || {}), allergy: e.target.value}})}
                          className="w-full p-1 border rounded bg-white text-xs"
                          placeholder="ä¾‹: ãã°ã€ã‚¨ãƒ“"
                        />
                      </div>
                    </div>

                    {/* é£Ÿäº‹ä¼ç¥¨ä¸€è¦§ï¼ˆç·¨é›†æ™‚ã®ã¿è¡¨ç¤ºãƒ»å½“æœˆåˆ†ï¼‰ */}
                    {editingUser && editingUser.stayDates && editingUser.stayDates.length > 0 && (
                      <div className="mb-3 p-3 bg-green-50 rounded border border-green-200">
                        <p className="text-xs font-bold text-green-700 mb-2">ğŸ½ï¸ é£Ÿäº‹ä¼ç¥¨ï¼ˆ{currentMonth.getFullYear()}å¹´{currentMonth.getMonth() + 1}æœˆï¼‰:</p>
                        <div className="space-y-1">
                          {(() => {
                            const monthStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
                            const periods = getStayPeriods(editingUser.stayDates);
                            const currentMonthPeriods = periods.filter(period => {
                              const periodStart = period[0];
                              return periodStart.startsWith(monthStr);
                            });
                            
                            if (currentMonthPeriods.length === 0) {
                              return <p className="text-xs text-gray-500">å½“æœˆã®åˆ©ç”¨æœŸé–“ã¯ã‚ã‚Šã¾ã›ã‚“</p>;
                            }
                            
                            return currentMonthPeriods.map((period, index) => {
                              const periodStart = period[0];
                              const periodEnd = period[period.length - 1];
                              const ticketKey = `${editingUser.id}_${periodStart}_${periodEnd}`;
                              const hasTicket = mealTickets[ticketKey];
                              return (
                                <div key={index} className="flex items-center justify-between bg-white p-2 rounded border">
                                  <span className="text-xs">
                                    {periodStart} ï½ {periodEnd}
                                    {hasTicket ? (
                                      <span className="ml-2 text-green-600 font-bold">âœ“ä½œæˆæ¸ˆã¿</span>
                                    ) : (
                                      <span className="ml-2 text-gray-400">æœªä½œæˆ</span>
                                    )}
                                  </span>
                                  <button
                                    type="button"
                                    onClick={() => {
                                      const existingTicket = mealTickets[ticketKey];
                                      if (existingTicket) {
                                        setEditingMealTicket(existingTicket);
                                      } else {
                                        const defaultMealPref = editingUser.mealPref || {};
                                        setEditingMealTicket({
                                          userId: editingUser.id,
                                          startDate: periodStart,
                                          endDate: periodEnd,
                                          unit: 'æ¨¹',
                                          startMeal: '',
                                          endMeal: '',
                                          category: '',
                                          reason: '',
                                          foodType: defaultMealPref.foodType || '',
                                          diabetesKcal: '',
                                          mainDish: defaultMealPref.mainDish || '',
                                        mainDishOther: '',
                                          sideDish: defaultMealPref.sideDish || '',
                                        sideDishOther: '',
                                          drink: defaultMealPref.drink || '',
                                          snack: defaultMealPref.snack || '',
                                          memo: defaultMealPref.allergy ? `ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼: ${defaultMealPref.allergy}` : ''
                                        });
                                      }
                                      setShowMealTicketModal(true);
                                    }}
                                    className={`text-xs px-2 py-1 rounded ${hasTicket ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'}`}
                                  >
                                    {hasTicket ? 'ç·¨é›†' : 'ä½œæˆ'}
                                  </button>
                                </div>
                              );
                            });
                          })()}
                        </div>
                      </div>
                    )}

                    <div className="mb-4">
                      {/* ãƒ­ãƒ³ã‚°åˆ©ç”¨è¨­å®š */}
                      <div className="mb-2 p-2 bg-indigo-50 rounded border border-indigo-200">
                        <label className="flex items-center gap-2 cursor-pointer mb-2">
                          <input 
                            type="checkbox" 
                            checked={newUserData.isLongTerm || false}
                            onChange={(e) => setNewUserData({...newUserData, isLongTerm: e.target.checked})}
                            className="rounded text-indigo-600 w-4 h-4"
                          />
                          <span className="font-bold text-indigo-800 text-sm">ãƒ­ãƒ³ã‚°åˆ©ç”¨ï¼ˆçµ‚äº†æ—¥æœªå®šãƒ»é•·æœŸï¼‰</span>
                        </label>
                        
                        {newUserData.isLongTerm && (
                          <div className="pl-6 space-y-2">
                            <p className="text-xs text-indigo-600 mb-1">
                              â€»ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€ä¸‹ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠã¯ç„¡è¦–ã•ã‚Œã€é–‹å§‹æ—¥ã‹ã‚‰è‡ªå‹•çš„ã«æ—¥ä»˜ãŒç™»éŒ²ã•ã‚Œã¾ã™ã€‚
                            </p>
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <label className="text-xs font-bold text-gray-600 block mb-1">é–‹å§‹æ—¥ <span className="text-red-500">*</span></label>
                                <input 
                                  type="date" 
                                  value={newUserData.longTermStartDate || ''}
                                  onChange={(e) => setNewUserData({...newUserData, longTermStartDate: e.target.value})}
                                  className="w-full p-1 border rounded text-sm bg-white"
                                  required
                                />
                              </div>
                              <div>
                                <label className="text-xs font-bold text-gray-600 block mb-1">çµ‚äº†äºˆå®šæ—¥ (ä»»æ„)</label>
                                <input 
                                  type="date" 
                                  value={newUserData.longTermEndDate || ''}
                                  onChange={(e) => setNewUserData({...newUserData, longTermEndDate: e.target.value})}
                                  className="w-full p-1 border rounded text-sm bg-white"
                                  placeholder="æœªå®š"
                                />
                                <span className="text-[10px] text-gray-500 block">ç©ºæ¬„ï¼æœªå®šï¼ˆ2å¹´å¾Œã¾ã§è‡ªå‹•è¨­å®šï¼‰</span>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>

                      <div className="flex justify-between items-end mb-2">
                        <p className="text-xs font-bold text-gray-600">åˆ©ç”¨æ—¥é¸æŠ:</p>
                        <div className="flex gap-1">
                          <button 
                            type="button"
                            onClick={clearSelectedDates}
                            className="text-[10px] text-red-500 bg-red-50 px-2 py-0.5 rounded hover:bg-red-100 border border-red-200"
                          >
                            å…¨ã¦ã‚¯ãƒªã‚¢
                          </button>
                          <span className="text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-0.5 rounded border border-blue-200">
                            {selectionStart ? "çµ‚äº†æ—¥ã‚’é¸æŠ" : "æœŸé–“ã‚’è¿½åŠ "}
                          </span>
                        </div>
                      </div>
                      {renderCalendarGrid()}
                      {newUserData.stayDates.length > 0 && (
                        <div className="mt-2 p-2 bg-gray-50 rounded text-[10px] text-gray-600">
                          <span className="font-bold">é¸æŠä¸­: </span>
                          {(() => {
                            const sortedDates = [...newUserData.stayDates].sort();
                            if (sortedDates.length === 0) return '';
                            const periods = getStayPeriods(sortedDates);
                            return periods.map((period, i) => {
                              const start = period[0];
                              const end = period[period.length - 1];
                              const startObj = parseLocalDate(start);
                              const endObj = parseLocalDate(end);
                              const startStr = `${startObj.getMonth()+1}/${startObj.getDate()}`;
                              const endStr = `${endObj.getMonth()+1}/${endObj.getDate()}`;
                              return (
                                <span key={i} className="inline-flex items-center bg-blue-100 text-blue-800 px-1 rounded mr-1 mb-1">
                                  {start === end ? startStr : `${startStr}ã€œ${endStr}`}
                                  <button
                                    type="button"
                                    onClick={() => {
                                      setNewUserData(prev => ({
                                        ...prev,
                                        stayDates: prev.stayDates.filter(d => !period.includes(d))
                                      }));
                                    }}
                                    className="ml-1 text-red-500 hover:text-red-700 font-bold"
                                    title="ã“ã®æœŸé–“ã‚’å‰Šé™¤"
                                  >Ã—</button>
                                </span>
                              );
                            });
                          })()}
                        </div>
                      )}
                      <p className="text-[10px] text-gray-400 mt-1 text-center">é–‹å§‹æ—¥â†’çµ‚äº†æ—¥ã§ã‚¯ãƒªãƒƒã‚¯è¿½åŠ  / é¸æŠæ¸ˆã¿ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤</p>
                    </div>

                    <button 
                      onClick={handleSaveUser}
                      disabled={!newUserData.name}
                      className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 disabled:opacity-50 font-bold"
                    >
                      {editingUser ? 'æ›´æ–°' : 'ãƒªã‚¹ãƒˆã«è¿½åŠ '}
                    </button>
                    </div>
                  </div>
                )}

            {/* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */}
            <div className={`${sidebarCollapsed ? 'col-span-1' : 'lg:col-span-4'} bg-white rounded shadow-sm border border-gray-200 p-2 flex flex-col`} style={{height: headerCollapsed ? 'calc(100vh - 60px)' : 'calc(100vh - 120px)'}}>
              {/* ä¸€æ™‚ä¿ç®¡ã«åˆ©ç”¨è€…ãŒã„ã‚‹å ´åˆã®è­¦å‘Š */}
              {(() => {
                const tempUserCount = displayDates.reduce((count, dateStr) => {
                  const tempKey1 = `${dateStr}-${TEMP_ROOM_1_ID}`;
                  const tempKey2 = `${dateStr}-${TEMP_ROOM_2_ID}`;
                  return count + (allocations[tempKey1] || []).length + (allocations[tempKey2] || []).length;
                }, 0);
                if (tempUserCount > 0) {
                  return (
                    <div className="bg-red-600 text-white px-6 py-4 rounded-lg mb-2 print-hidden border-4 border-yellow-400 shadow-lg" 
                         style={{animation: 'blink 0.5s ease-in-out infinite'}}>
                      <style>{`
                        @keyframes blink {
                          0%, 100% { opacity: 1; background-color: #dc2626; }
                          50% { opacity: 0.8; background-color: #b91c1c; }
                        }
                      `}</style>
                      <div className="flex items-center justify-center gap-4">
                        <span className="text-5xl">ğŸš¨</span>
                        <div className="text-center">
                          <div className="text-3xl font-black mb-1">âš ï¸ è­¦å‘Š âš ï¸</div>
                          <div className="text-2xl font-bold">ä¸€æ™‚ä¿ç®¡ã« {tempUserCount} ä»¶ã®åˆ©ç”¨è€…ãŒæ®‹ã£ã¦ã„ã¾ã™ï¼</div>
                          <div className="text-lg mt-1">éƒ¨å±‹ã®å‰²ã‚Šå½“ã¦ã‚’å®Œäº†ã—ã¦ãã ã•ã„</div>
                        </div>
                        <span className="text-5xl">ğŸš¨</span>
                      </div>
                      <div className="flex justify-center mt-3">
                        <button 
                          onClick={() => {
                            const targetRow = document.getElementById(`row-${TEMP_ROOM_1_ID}`);
                            if (targetRow) {
                              targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            } else if (tableContainerRef.current) {
                              tableContainerRef.current.scrollTo({ top: tableContainerRef.current.scrollHeight, behavior: 'smooth' });
                            }
                          }}
                          className="bg-yellow-400 text-red-800 px-6 py-2 rounded-lg font-black text-lg hover:bg-yellow-300 shadow-md"
                        >
                          ğŸ‘‡ ä¸€æ™‚ä¿ç®¡ã‚’ç¢ºèªã™ã‚‹ ğŸ‘‡
                        </button>
                      </div>
                    </div>
                  );
                }
                return null;
              })()}
              <div className="print-hidden mb-2 flex justify-between items-center flex-shrink-0">
                <div className="flex gap-2">
                  <button
                    onClick={() => scrollTable('left')}
                    className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded shadow flex items-center gap-1 font-bold"
                  >
                    â—€ å·¦ã¸
                  </button>
                  <button
                    onClick={() => scrollTable('right')}
                    className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded shadow flex items-center gap-1 font-bold"
                  >
                    å³ã¸ â–¶
                  </button>
                  <button
                    onClick={() => {
                      if (tableContainerRef.current) {
                        const today = new Date();
                        const dayOfMonth = today.getDate();
                        const cellWidth = 48; // ç´„48pxã‚»ãƒ«å¹…
                        const scrollPosition = (dayOfMonth - 1) * cellWidth;
                        tableContainerRef.current.scrollTo({
                          left: scrollPosition,
                          behavior: 'smooth'
                        });
                      }
                    }}
                    className="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded shadow flex items-center gap-1 font-bold"
                  >
                    ğŸ“… ä»Šæ—¥
                  </button>
                  
                  {/* ç¨¼åƒç‡è¡¨ç¤º */}
                  {(() => {
                    // å³ä¸‹ã®å®Ÿç¸¾æ•°ã¨åŒã˜è¨ˆç®—å¼ã‚’ä½¿ç”¨
                    const totalCount = displayDates.reduce((total, dateStr) => {
                      return total + rooms.reduce((count, room) => {
                        const key = `${dateStr}-${room.id}`;
                        const occupants = allocations[key] || [];
                        return count + occupants.length;
                      }, 0);
                    }, 0);
                    const maxCapacity = rooms.length * displayDates.length;
                    const occupancyRate = maxCapacity > 0 ? ((totalCount / maxCapacity) * 100).toFixed(1) : 0;
                    return (
                      <div className="bg-white border-2 border-yellow-500 rounded px-3 py-1 text-center">
                        <div className="text-lg font-black text-gray-800">{totalCount}</div>
                        <div className="text-xs text-gray-500">({occupancyRate}%)</div>
                      </div>
                    );
                  })()}
                </div>
                <div className="text-lg text-gray-500">
                  â€»åˆ©ç”¨è€…åã‚’ãƒ‰ãƒ©ãƒƒã‚°ã§éƒ¨å±‹ç§»å‹• / å³ã‚¯ãƒªãƒƒã‚¯ã§ä¸€æ™‚ä¿ç®¡ã¸ç§»å‹•ã€‚ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆğŸ›ãƒ»ğŸ›ï¸ï¼‰ã¯åŒåˆ©ç”¨è€…ã®ä»–ã®æ—¥ã«ç§»å‹•å¯ã€‚
                </div>
              </div>
              <div ref={tableContainerRef} className="flex-1 min-h-0 overflow-auto">
              
              <h2 className="hidden text-2xl font-bold text-center mb-4">
                {currentMonth.getFullYear()}å¹´ {currentMonth.getMonth() + 1}æœˆ ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤éƒ¨å±‹å‰²è¡¨
              </h2>

              <table className={`w-full border-collapse text-xs ${displayDates.length > 14 ? 'min-w-[2000px]' : ''} print-hidden`}>
                <thead className="sticky top-0 z-40">
                  <tr>
                    <th className="p-2 border-2 border-gray-400 bg-gray-100 text-center text-xl font-bold sticky left-0 z-50 shadow-sm" style={{width: '150px', minWidth: '150px'}}>éƒ¨å±‹</th>
                    {displayDates.map((dateStr, i) => {
                      const dateObj = parseLocalDate(dateStr);
                      const dayOfWeek = dateObj.getDay();
                      const isSun = dayOfWeek === 0;
                      const isSat = dayOfWeek === 6;
                      const holiday = HOLIDAYS_JP[dateStr];
                      const isRed = isSun || holiday; // æ—¥æ›œã¾ãŸã¯ç¥æ—¥ã¯èµ¤
                      const today = toDateStr(new Date());
                      const isPastHeader = dateStr < today;
                      const isToday = dateStr === today;
                      const isSunday = dayOfWeek === 0;
                      
                      // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§ç¢ºå®Ÿã«è‰²ã‚’é©ç”¨
                      let bgColor = '#f9fafb'; // gray-50
                      let textColor = '#374151'; // gray-700
                      
                      if (isRed) {
                        bgColor = isPastHeader ? '#fca5a5' : '#fef2f2'; // red-300/red-50
                        textColor = isPastHeader ? '#b91c1c' : '#dc2626'; // red-700/red-600
                      } else if (isSat) {
                        bgColor = isPastHeader ? '#93c5fd' : '#eff6ff'; // blue-300/blue-50
                        textColor = isPastHeader ? '#1d4ed8' : '#2563eb'; // blue-700/blue-600
                      } else if (isPastHeader) {
                        bgColor = '#9ca3af'; // gray-400
                        textColor = '#374151'; // gray-700
                      }

                      // ãã®æ—¥ã®åˆ©ç”¨è€…æ•°ã‚’è¨ˆç®—
                      const dailyCount = rooms.reduce((count, room) => {
                        const key = `${dateStr}-${room.id}`;
                        const occupants = allocations[key] || [];
                        return count + occupants.length;
                      }, 0);

                      // äººæ•°ã«å¿œã˜ãŸè‰²ã®ä¸Šæ›¸ãï¼ˆè­¦å‘Šãƒ»æ³¨æ„ï¼‰
                      if (dailyCount >= 12) {
                        bgColor = '#b91c1c'; // æ¿ƒã„èµ¤
                        textColor = '#ffffff'; // ç™½
                      } else if (dailyCount === 11) {
                        bgColor = '#facc15'; // ç›®ç«‹ã¤é»„è‰²
                        textColor = '#000000'; // é»’
                      }
                      
                      return (
                        <th key={dateStr} className={`p-1 border-2 border-gray-400 text-center ${cellWidth}`}
                          style={{ 
                            backgroundColor: bgColor,
                            borderLeft: isSunday ? '4px solid #ef4444' : (isToday ? '6px solid #1e3a8a' : undefined)
                          }}
                          title={holiday || ''}
                        >
                          <div className="text-sm font-bold"
                            style={{ color: textColor }}>
                            <div>{dateObj.getMonth() + 1}/{dateObj.getDate()}</div>
                            <div>{WEEK_DAYS_JP[dayOfWeek]}</div>
                          </div>
                          {holiday && <div className="text-[8px] truncate" style={{ color: '#ef4444' }}>{holiday}</div>}
                        </th>
                      );
                    })}
                    <th className="p-1 border-2 border-gray-400 text-center bg-yellow-100 min-w-[150px]">
                      <div className="text-base font-bold text-gray-700">å®Ÿç¸¾</div>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {rooms.map(room => (
                    <tr key={room.id} className={`hover:bg-gray-50 ${room.status === 'hospitalized' ? 'bg-yellow-100' : room.status === 'moved_out' ? 'bg-red-100' : ''}`}>
                      <td className="p-1 border-2 border-gray-400 align-middle bg-white sticky left-0 z-30 shadow-sm text-center" style={{width: '150px', minWidth: '150px'}}>
                        <div className="flex flex-col items-center">
                          <span className="font-bold text-3xl text-gray-800">{room.name}</span>
                          <div className="flex flex-wrap gap-1 mt-1 justify-center">
                            {room.features.includes('reserved_i') && <span className="text-lg bg-purple-100 text-purple-700 px-2 py-0.5 rounded whitespace-nowrap">Iæ§˜</span>}
                            {room.features.includes('near_toilet') && <span className="text-lg bg-green-100 text-green-700 px-2 py-0.5 rounded whitespace-nowrap">ãƒˆã‚¤ãƒ¬</span>}
                            {room.features.includes('low_fall_risk') && <span className="text-lg bg-orange-100 text-orange-700 px-2 py-0.5 rounded whitespace-nowrap">è»¢å€’ä½</span>}
                            {room.features.includes('for_new') && <span className="text-lg bg-teal-100 text-teal-700 px-2 py-0.5 rounded whitespace-nowrap">æ–°è¦</span>}
                            {room.features.includes('for_oxygen') && <span className="text-lg bg-red-100 text-red-700 px-2 py-0.5 rounded whitespace-nowrap">é…¸ç´ </span>}
                          </div>
                        </div>
                      </td>
                      {displayDates.map((dateStr) => {
                        const allocatedIds = allocations[`${dateStr}-${room.id}`] || [];
                        const dateObj = parseLocalDate(dateStr);
                        const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;
                        
                        const sortedIds = [...allocatedIds].sort((a, b) => {
                          const userA = users.find(u => u.id === a);
                          const userB = users.find(u => u.id === b);
                          if (!userA || !userB) return 0;
                          const aIsLeaving = !userA.stayDates.includes(getNextDay(dateStr));
                          const bIsLeaving = !userB.stayDates.includes(getNextDay(dateStr));
                          return (aIsLeaving === bIsLeaving) ? 0 : aIsLeaving ? -1 : 1;
                        });

                        const isRoomDragOver = dragOverRoom === `${dateStr}-${room.id}`;
                        
                        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ã—ã¦éå»ã‹ã©ã†ã‹åˆ¤å®š
                        const today = toDateStr(new Date());
                        const isPast = dateStr < today;
                        const isToday = dateStr === today;
                        const isSunday = dateObj.getDay() === 0;
                        const isEmpty = sortedIds.length === 0;
                        const hasDoubleBooking = sortedIds.length >= 2; // åŒæ—¥ã«2äººã„ã‚‹å ´åˆ

                        return (
                          <td 
                            key={dateStr} 
                            className={`p-0 h-24 align-top relative 
                              ${hasDoubleBooking ? 'border-4 border-red-500' : 'border-2 border-gray-400'}
                              ${isRoomDragOver ? 'bg-yellow-100 border-2 border-dashed border-yellow-500' : ''}`}
                            style={{
                              backgroundColor: isRoomDragOver ? undefined : 
                                isEmpty ? '#00FE73' : 
                                isPast ? '#9ca3af' : 
                                isWeekend ? 'rgba(249, 250, 251, 0.5)' : 'white',
                              borderLeft: isSunday ? '4px solid #ef4444' : (isToday ? '6px solid #1e3a8a' : undefined)
                            }}
                            onDragOver={(e) => handleRoomDragOver(e, dateStr, room.id)}
                            onDragLeave={handleRoomDragLeave}
                            onDrop={(e) => handleRoomDrop(e, dateStr, room.id)}
                          >
                            <div className="flex flex-col h-full">
                              <div className="flex-1 flex flex-col min-h-0">
                                {sortedIds.length > 0 ? (
                                  sortedIds.map((userId, idx) => {
                                    const user = users.find(u => u.id === userId);
                                    if (!user) {
                                      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã§ã‚‚æœ€ä½é™ã®è¡¨ç¤º
                                      return (
                                        <div key={userId} className="flex-1 p-0.5 text-[10px] font-bold bg-gray-200 text-gray-500 text-center">
                                          (å‰Šé™¤æ¸ˆã¿)
                                        </div>
                                      );
                                    }
                                    
                                    const isCheckIn = !user.stayDates.includes(getPrevDay(dateStr));
                                    const isCheckOut = !user.stayDates.includes(getNextDay(dateStr));
                                    
                                    const userSchedule = user.schedule || {};
                                    const daySchedule = userSchedule[dateStr] || { bath: false, mustBath: false, linen: false };
                                    
                                    const isDragOver = dragOverTarget === `${userId}-${dateStr}`;
                                    
                                    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼šäº‹å‰ã«è¨ˆç®—ã—ãŸè‰²æƒ…å ±ã‚’å‚ç…§
                                    const colorIndex = roomUserColors[`${room.id}-${userId}`] ?? 0;
                                    // ã“ã®æ—¥ä»˜ãŒå±ã™ã‚‹æœŸé–“ã«å›ºå®šãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                                    const periods = getStayPeriods(user.stayDates || []);
                                    const currentPeriod = periods.find(p => p.includes(dateStr));
                                    const periodKey = currentPeriod ? `${currentPeriod[0]}_${currentPeriod[currentPeriod.length - 1]}` : '';
                                    const isFixedInPeriod = periodKey && user.fixedRooms && user.fixedRooms[periodKey];
                                    
                                    // è‰²ã®å®šç¾©ï¼ˆ4è‰²ï¼‹å›ºå®šè‰²ï¼‰
                                    let userBgColor = '';
                                    let userTextColor = '';

                                    if (isFixedInPeriod) {
                                      userBgColor = 'bg-yellow-200';
                                      userTextColor = 'text-yellow-800';
                                    } else {
                                      switch (colorIndex) {
                                        case 0: // ãƒ”ãƒ³ã‚¯
                                          userBgColor = 'bg-pink-200';
                                          userTextColor = 'text-pink-800';
                                          break;
                                        case 1: // é’
                                          userBgColor = 'bg-sky-200';
                                          userTextColor = 'text-sky-800';
                                          break;
                                        case 2: // è–„ç´«
                                          userBgColor = 'bg-purple-200';
                                          userTextColor = 'text-purple-800';
                                          break;
                                        case 3: // ã‚ªãƒ¬ãƒ³ã‚¸
                                          userBgColor = 'bg-orange-200';
                                          userTextColor = 'text-orange-800';
                                          break;
                                        default:
                                          userBgColor = 'bg-gray-200';
                                          userTextColor = 'text-gray-800';
                                      }
                                    }
                                    
                                    // åŒæ—¥IN/OUTæ™‚ã®ç‚¹ç·šè¡¨ç¤ºåˆ¤å®š
                                    // å‰ã®åˆ©ç”¨è€…ãŒé€€å®¤è€…ã§ã€ç¾åœ¨ã®åˆ©ç”¨è€…ãŒéé€€å®¤è€…ãªã‚‰ç‚¹ç·šã‚’å…¥ã‚Œã‚‹
                                    let showInOutDivider = false;
                                    if (idx > 0 && !isCheckOut) {
                                      const prevUserId = sortedIds[idx - 1];
                                      const prevUser = users.find(u => u.id === prevUserId);
                                      if (prevUser) {
                                        const prevIsCheckOut = !prevUser.stayDates.includes(getNextDay(dateStr));
                                        showInOutDivider = prevIsCheckOut;
                                      }
                                    }
                                    
                                    return (
                                      <React.Fragment key={userId}>
                                        {showInOutDivider && (
                                          <div className="border-t-2 border-dashed border-gray-400 mx-0" style={{borderColor: '#666'}} />
                                        )}
                                        <div 
                                          draggable
                                          onDragStart={(e) => handleUserDragStart(e, userId, dateStr, room.id)}
                                          onDragEnd={handleUserDragEnd}
                                          onDragOver={(e) => handleDragOver(e, userId, dateStr)}
                                          onDragLeave={handleDragLeave}
                                          onDrop={(e) => handleDrop(e, userId, dateStr)}
                                          onContextMenu={(e) => handleContextMenu(e, userId, dateStr, room.id)}
                                          onDoubleClick={(e) => {
                                            e.stopPropagation();
                                            handleEditUser(user);
                                          }}
                                          className={`
                                            flex-1 p-0.5 text-[10px] font-bold border-b border-gray-100 last:border-b-0 flex flex-col justify-center text-center overflow-hidden relative transition-colors cursor-grab active:cursor-grabbing group/cell
                                            ${userBgColor} ${userTextColor}
                                            ${isDragOver ? 'drag-over' : ''}
                                            ${isPast ? 'opacity-40' : ''}
                                          `}
                                          title="ãƒ‰ãƒ©ãƒƒã‚°ã§éƒ¨å±‹ç§»å‹• / å³ã‚¯ãƒªãƒƒã‚¯ã§ä¸€æ™‚ä¿ç®¡ã¸"
                                        >
                                        <div className="leading-tight w-full z-10">
                                          <div className="flex justify-center items-center gap-0.5 mb-0.5">
                                            {isCheckOut && sortedIds.length > 1 && <span className="text-[7px] text-red-600 leading-none">â–²é€€</span>}
                                            {isCheckIn && sortedIds.length > 1 && <span className="text-[7px] text-green-700 leading-none">â–¼å…¥</span>}
                                          </div>
                                          <span className="truncate block" style={{
                                            fontSize: user.name.length <= 4 ? '14px' : user.name.length === 5 ? '12px' : '10px',
                                            fontWeight: 'bold'
                                          }}>{user.name}</span>
                                        </div>

                                        <div className="flex justify-center gap-1 mt-0.5 z-20 flex-wrap">
                                          {(daySchedule.mustBath || daySchedule.bath) ? (
                                            <span 
                                              draggable 
                                              onDragStart={(e) => { e.stopPropagation(); handleDragStart(e, userId, dateStr, daySchedule.mustBath ? 'mustBath' : 'bath'); }}
                                              onDragEnd={handleDragEnd}
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                saveHistory();
                                                if (!daySchedule.mustBath) {
                                                  // mustBathä»¥å¤–ã¯å‰Šé™¤å¯èƒ½
                                                  setUsers(users.map(u => {
                                                    if (u.id === userId) {
                                                  const updatedUser = { ...u, schedule: { ...u.schedule } };
                                                  updatedUser.schedule[dateStr] = { ...updatedUser.schedule[dateStr], bath: false };
                                                  return updatedUser;
                                                    }
                                                    return u;
                                              })); // ãƒ­ãƒ¼ã‚«ãƒ«ã®å³æ™‚åæ˜ 
                                              if (isFirebaseEnabled && database) {
                                                // Firebaseã«ç›´æ¥æ›¸ãè¾¼ã¿
                                                const userIndex = users.findIndex(u => u.id === userId);
                                                if (userIndex !== -1) {
                                                  const path = `data/${STORAGE_KEY_USERS}/${userIndex}/schedule/${dateStr}/bath`;
                                                  database.ref(path).set(false);
                                                }
                                              }
                                                }
                                              }}
                                              className={`text-2xl cursor-pointer hover:opacity-80 drop-shadow-md rounded ${daySchedule.mustBath ? 'cursor-grab' : 'hover:bg-red-100'}`}
                                              title={daySchedule.mustBath ? "é€€æ‰€å‰æ—¥å…¥æµ´ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ï¼‰" : "å…¥æµ´äºˆå®šï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤/ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ï¼‰"}>ğŸ›</span>
                                          ) : (
                                            <button
                                              onClick={(e) => {
                                                saveHistory();
                                                e.stopPropagation();
                                                const newUsers = users.map(u => {
                                                  if (u.id === userId) {
                                                    const updatedUser = { ...u, schedule: { ...u.schedule } };
                                                    updatedUser.schedule[dateStr] = { ...updatedUser.schedule[dateStr], bath: true };
                                                    return updatedUser;
                                                  }
                                                  return u;
                                                });
                                                setUsers(newUsers); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
                                                if (isFirebaseEnabled && database) {
                                                  // userså…¨ä½“ã‚’æ›´æ–°
                                                  database.ref('data/' + STORAGE_KEY_USERS).set(newUsers);
                                                }
                                              }}
                                              className="text-[10px] text-blue-400 hover:text-blue-600 hover:bg-blue-100 rounded px-1 opacity-0 group-hover/cell:opacity-100 transition-opacity"
                                              title="å…¥æµ´ã‚’è¿½åŠ "
                                            >+ğŸ›</button>
                                          )}
                                          {daySchedule.linen ? (
                                            <span 
                                              draggable 
                                              onDragStart={(e) => { e.stopPropagation(); handleDragStart(e, userId, dateStr, 'linen'); }}
                                              onDragEnd={handleDragEnd}
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                saveHistory();
                                                const newUsers = users.map(u => {
                                                  if (u.id === userId) {
                                                    const updatedUser = { ...u, schedule: { ...u.schedule } };
                                                    updatedUser.schedule[dateStr] = { ...updatedUser.schedule[dateStr], linen: false };
                                                    return updatedUser;
                                                  }
                                                  return u;
                                                });
                                                setUsers(newUsers); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
                                                if (isFirebaseEnabled && database) {
                                                  // userså…¨ä½“ã‚’æ›´æ–°
                                                  database.ref('data/' + STORAGE_KEY_USERS).set(newUsers);
                                                }
                                              }}
                                              className="text-2xl cursor-pointer hover:opacity-80 drop-shadow-md hover:bg-red-100 rounded" 
                                              title="ãƒªãƒãƒ³äº¤æ›ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤/ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ï¼‰">ğŸ›ï¸</span>
                                          ) : (
                                            <button
                                              onClick={(e) => {
                                                saveHistory();
                                                e.stopPropagation();
                                                const newUsers = users.map(u => {
                                                  if (u.id === userId) {
                                                    const updatedUser = { ...u, schedule: { ...u.schedule } };
                                                    updatedUser.schedule[dateStr] = { ...updatedUser.schedule[dateStr], linen: true };
                                                    return updatedUser;
                                                  }
                                                  return u;
                                                });
                                                setUsers(newUsers); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
                                                if (isFirebaseEnabled && database) {
                                                  database.ref('data/' + STORAGE_KEY_USERS).set(newUsers);
                                                }
                                              }}
                                              className="text-[10px] text-green-400 hover:text-green-600 hover:bg-green-100 rounded px-1 opacity-0 group-hover/cell:opacity-100 transition-opacity"
                                              title="ãƒªãƒãƒ³äº¤æ›ã‚’è¿½åŠ "
                                            >+ğŸ›ï¸</button>
                                          )}
                                        </div>
                                      </div>
                                      </React.Fragment>
                                    );
                                  })
                                ) : (
                                  <div className="flex-1"></div>
                                )}
                              </div>

                              <MemoInput
                                value={memos[`${dateStr}-${room.id}`] || ''}
                                onSave={(val) => handleMemoChange(dateStr, room.id, val)}
                                className={`w-full h-6 text-[9px] border-t border-gray-200 p-1 outline-none text-red-600 font-bold placeholder-gray-300 focus:bg-yellow-50 print-placeholder-transparent ${isPast ? 'bg-gray-300' : 'bg-white'}`}
                                placeholder="ãƒ¡ãƒ¢"
                              />
                            </div>
                          </td>
                        );
                      })}
                      {/* éƒ¨å±‹ã”ã¨ã®æœˆé–“å®Ÿç¸¾ */}
                      <td className="p-2 border-2 border-gray-400 bg-yellow-50 text-center align-middle min-w-[150px]">
                        <span className="font-bold text-2xl text-gray-800">
                          {displayDates.reduce((count, dateStr) => {
                            const key = `${dateStr}-${room.id}`;
                            const occupants = allocations[key] || [];
                            return count + occupants.length;
                          }, 0)}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
                <tfoot>
                  {/* =========================================
                      1. æœ¬é¤¨å®Ÿç¸¾æ•°ï¼ˆé»„è‰²ã„è¡Œï¼‰
                     ========================================= */}
                  <tr className="bg-yellow-100" style={{height: '54px'}}>
                    <td className="p-2 border-2 border-gray-400 bg-yellow-200 font-bold text-xl text-gray-800 sticky left-0 z-30 text-center whitespace-nowrap" style={{width: '150px', minWidth: '150px'}}>
                      å®Ÿç¸¾æ•°
                    </td>
                    {displayDates.map(dateStr => {
                      const dailyCount = rooms.reduce((count, room) => {
                        const key = `${dateStr}-${room.id}`;
                        return count + (allocations[key]?.length || 0);
                      }, 0);
                      const today = toDateStr(new Date());
                      const isToday = dateStr === today;
                      const isSunday = parseLocalDate(dateStr).getDay() === 0;
                      
                      return (
                        <td key={dateStr} className="p-1 border-2 border-gray-400 bg-yellow-100 text-center align-middle"
                          style={{
                            borderLeftWidth: isToday ? '6px' : undefined,
                            borderLeftColor: isToday ? '#1e3a8a' : undefined,
                            borderLeft: isSunday ? '4px solid #ef4444' : (isToday ? '6px solid #1e3a8a' : undefined)
                          }}
                        >
                          <span className="font-bold text-xl text-gray-800">{dailyCount}</span>
                        </td>
                      );
                    })}
                    {/* æœ¬é¤¨ã®æœŸé–“åˆè¨ˆãƒ»ç¨¼åƒç‡ */}
                    <td className="p-2 border-2 border-gray-400 bg-yellow-200 text-center min-w-[150px]">
                      {(() => {
                        // æœ¬é¤¨ã®ã¿ã®é›†è¨ˆ
                        const totalCount = displayDates.reduce((total, dateStr) => {
                          return total + rooms.reduce((count, room) => {
                            const key = `${dateStr}-${room.id}`;
                            return count + (allocations[key]?.length || 0);
                          }, 0);
                        }, 0);
                        
                        // ç¨¼åƒç‡ (å®šå“¡ã¯æœ¬é¤¨ã®éƒ¨å±‹æ•°åŸºæº–)
                        const maxCapacity = rooms.length * displayDates.length;
                        const occupancyRate = maxCapacity > 0 ? ((totalCount / maxCapacity) * 100).toFixed(1) : 0;

                        return (
                          <div>
                            <div className="font-bold text-2xl text-gray-800">{totalCount}</div>
                            <div className="text-sm text-gray-600 font-bold">({occupancyRate}%)</div>
                          </div>
                        );
                      })()}
                    </td>
                  </tr>

                  {/* =========================================
                      1.5. ä¸€æ™‚ä¿ç®¡ã‚¨ãƒªã‚¢ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
                     ========================================= */}
                  {[
                    { id: TEMP_ROOM_1_ID, name: 'ä¸€æ™‚ä¿ç®¡â‘ ' },
                    { id: TEMP_ROOM_2_ID, name: 'ä¸€æ™‚ä¿ç®¡â‘¡' }
                  ].map((room) => (
                    <tr key={room.id} id={`row-${room.id}`} className="bg-orange-50" style={{height: '60px'}}>
                      <td className="p-2 border-2 border-gray-400 bg-orange-200 font-bold text-sm text-center align-middle sticky left-0 z-30">
                        <div className="flex flex-col items-center gap-1">
                          <span>{room.name}</span>
                        </div>
                      </td>
                      {displayDates.map(dateStr => {
                        const key = `${dateStr}-${room.id}`;
                        const occupants = allocations[key] || [];
                        const isRoomDragOver = dragOverRoom === `${dateStr}-${room.id}`;
                        const today = toDateStr(new Date());
                        const isToday = dateStr === today;
                        const isSunday = parseLocalDate(dateStr).getDay() === 0;
                        
                        return (
                          <td 
                            key={dateStr} 
                            className={`p-0 border-2 border-gray-400 align-top relative
                              ${occupants.length > 0 ? 'bg-orange-100' : 'bg-orange-50'}
                              ${isRoomDragOver ? 'bg-yellow-100 border-dashed border-yellow-500' : ''}`}
                            style={{
                              borderLeft: isSunday ? '4px solid #ef4444' : (isToday ? '6px solid #1e3a8a' : undefined)
                            }}
                            onDragOver={(e) => handleRoomDragOver(e, dateStr, room.id)}
                            onDragLeave={handleRoomDragLeave}
                            onDrop={(e) => handleRoomDrop(e, dateStr, room.id)}
                          >
                            <div className="flex flex-col h-full">
                              {occupants.map((userId) => {
                                const user = users.find(u => u.id === userId);
                                if (!user) return null;
                                
                                // éƒ¨å±‹å›ºå®šãƒã‚§ãƒƒã‚¯
                                const periods = getStayPeriods(user.stayDates || []);
                                const currentPeriod = periods.find(p => p.includes(dateStr));
                                const periodKey = currentPeriod ? `${currentPeriod[0]}_${currentPeriod[currentPeriod.length - 1]}` : '';
                                const isFixedInPeriod = periodKey && user.fixedRooms && user.fixedRooms[periodKey];
                                
                                return (
                                  <div 
                                    key={userId}
                                    draggable
                                    onDragStart={(e) => handleUserDragStart(e, userId, dateStr, room.id)}
                                    onDragEnd={handleUserDragEnd}
                                    onContextMenu={(e) => handleContextMenu(e, userId, dateStr, room.id)}
                                    onDoubleClick={(e) => {
                                      e.stopPropagation();
                                      handleEditUser(user);
                                    }}
                                    className={`flex-1 p-1 text-xs font-bold text-center cursor-grab active:cursor-grabbing m-0.5 rounded shadow-sm border ${
                                      isFixedInPeriod 
                                        ? 'bg-yellow-200 border-yellow-300 text-yellow-800' 
                                        : 'bg-white border-orange-300 text-gray-800'
                                    }`}
                                    title="ãƒ‰ãƒ©ãƒƒã‚°ã§éƒ¨å±‹ç§»å‹• / å³ã‚¯ãƒªãƒƒã‚¯ã§ç§»å‹•å…ˆé¸æŠ"
                                  >
                                    {user.name}
                                  </div>
                                );
                              })}
                            </div>
                          </td>
                        );
                      })}
                      <td className="border-2 border-gray-400 bg-orange-200"></td>
                    </tr>
                  ))}

                  {/* ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆç©ºè¡Œï¼‰ */}
                  <tr style={{ height: '20px', border: 'none' }}>
                    <td className="sticky left-0 z-30 bg-white border-none"></td>
                    <td colSpan={displayDates.length + 1} className="border-none bg-gray-50"></td>
                  </tr>

                  {/* =========================================
                      2. ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ã‚¨ãƒªã‚¢ï¼ˆé’/ã‚°ãƒ¬ãƒ¼ç³»ï¼‰
                     ========================================= */}
                  {customRows.map((customRow) => (
                    <tr key={customRow.id} className="bg-slate-50" style={{height: '40px'}}>
                      <td className="p-2 border-2 border-gray-400 bg-slate-200 font-bold text-sm text-center align-middle sticky left-0 z-30">
                        <div className="flex flex-col items-center gap-1">
                          <span>{customRow.name}</span>
                          {customRows.length > 1 && (
                            <button
                              onClick={() => handleDeleteCustomRow(customRow.id)}
                              className="text-xs text-red-500 hover:text-red-700 bg-white border border-red-200 rounded px-1"
                            >
                              ğŸ—‘ï¸å‰Šé™¤
                            </button>
                          )}
                        </div>
                      </td>
                      {displayDates.map(dateStr => {
                        const memoKey1 = `${dateStr}-${customRow.id}-1`;
                        const memoKey2 = `${dateStr}-${customRow.id}-2`;
                        const today = toDateStr(new Date());
                        const isToday = dateStr === today;
                        const isSunday = parseLocalDate(dateStr).getDay() === 0;
                        return (
                          <td 
                            key={dateStr} 
                            className="p-0 border border-gray-300 bg-slate-50 align-top"
                            style={{
                              borderLeft: isSunday ? '4px solid #ef4444' : (isToday ? '6px solid #1e3a8a' : undefined)
                            }}
                          >
                            <div className="flex flex-col h-full">
                              <MemoInput
                                value={customRowMemos[memoKey1] || ''}
                                onSave={(val) => {
                                  setCustomRowMemos(prev => ({...prev, [memoKey1]: val})); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
                                  if (isFirebaseEnabled && database) {
                                    database.ref(`data/${STORAGE_KEY_CUSTOM_ROW_MEMOS}/${memoKey1}`).set(val);
                                  }
                                }}
                                className="w-full flex-1 p-0.5 text-xs bg-slate-50 outline-none text-gray-800 placeholder-gray-300 focus:bg-yellow-50 border-b border-gray-200"
                                placeholder=""
                              />
                              <MemoInput
                                value={customRowMemos[memoKey2] || ''}
                                onSave={(val) => {
                                  setCustomRowMemos(prev => ({...prev, [memoKey2]: val})); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
                                  if (isFirebaseEnabled && database) {
                                    database.ref(`data/${STORAGE_KEY_CUSTOM_ROW_MEMOS}/${memoKey2}`).set(val);
                                  }
                                }}
                                className="w-full flex-1 p-0.5 text-xs bg-slate-50 outline-none text-gray-800 placeholder-gray-300 focus:bg-yellow-50"
                                placeholder=""
                              />
                            </div>
                          </td>
                        );
                      })}
                      <td className="border-2 border-gray-400 bg-slate-200"></td>
                    </tr>
                  ))}
                  {/* è¿½åŠ ãƒœã‚¿ãƒ³ */}
                  <tr>
                    <td className="p-1 border-r-2 border-gray-400 sticky left-0 z-30 bg-white">
                      <button
                        onClick={handleAddCustomRow}
                        className="w-full text-xs text-slate-600 hover:text-slate-800 font-bold py-1 bg-slate-100 rounded"
                      >
                        ï¼‹ è¡Œã‚’è¿½åŠ 
                      </button>
                    </td>
                    <td colSpan={displayDates.length + 1} className="border-none"></td>
                  </tr>

                  {/* =========================================
                      3. ã‚¹ãƒšãƒ¼ã‚µãƒ¼ï¼ˆç©ºç™½è¡Œï¼‰
                     ========================================= */}
                  <tr style={{ height: '24px', border: 'none' }}>
                    <td className="sticky left-0 z-30 bg-white border-none"></td>
                    <td colSpan={displayDates.length + 1} className="border-none"></td>
                  </tr>

                  {/* =========================================
                      4. ç©ºåºŠã‚¨ãƒªã‚¢ï¼ˆç´«ï¼‰
                     ========================================= */}
                  {currentMonthTempRooms.map((tempRoom, index) => (
                    <tr key={tempRoom.id} className="bg-purple-50" style={{height: '60px'}}>
                      <td className="p-2 border-2 border-gray-400 bg-purple-100 font-bold text-sm text-center align-middle sticky left-0 z-30">
                        <div className="flex flex-col items-center gap-1">
                          <span>{tempRoom.name}</span>
                          <div className="flex gap-1">
                            <button 
                              onClick={() => handleRenameTempRoom(tempRoom.id, tempRoom.name)}
                              className="text-xs bg-white border border-gray-400 rounded px-1 hover:bg-gray-100"
                            >
                              âœï¸ç·¨é›†
                            </button>
                            {index > 0 && (
                              <button
                                onClick={() => {
                                  const hasOccupants = Object.keys(allocations).some(k => k.endsWith(`-${tempRoom.id}`) && allocations[k]?.length > 0);
                                  if (hasOccupants) { alert('åˆ©ç”¨è€…ãŒã„ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“'); return; }
                                  if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                                    saveHistory();
                                    const newTempRooms = tempRooms.filter(r => r.id !== tempRoom.id);
                                    setTempRooms(newTempRooms); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
                                    if (isFirebaseEnabled && database) {
                                      database.ref('data/' + STORAGE_KEY_TEMP_ROOMS).set(newTempRooms);
                                    }
                                  }
                                }}
                                className="text-xs text-red-500 hover:text-red-700 bg-white border border-red-200 rounded px-1"
                              >
                                ğŸ—‘ï¸å‰Šé™¤
                              </button>
                            )}
                          </div>
                        </div>
                      </td>
                      {displayDates.map(dateStr => {
                        const tempKey = `${dateStr}-${tempRoom.id}`;
                        const tempOccupants = allocations[tempKey] || [];
                        const isRoomDragOver = dragOverRoom === `${dateStr}-${tempRoom.id}`;
                        const today = toDateStr(new Date());
                        const isToday = dateStr === today;
                        const isSunday = parseLocalDate(dateStr).getDay() === 0;
                        
                        return (
                          <td 
                            key={dateStr} 
                            className={`p-0 border-2 border-purple-400 align-top relative
                              ${tempOccupants.length > 0 ? 'bg-purple-100' : 'bg-purple-50'}
                              ${isRoomDragOver ? 'bg-yellow-100 border-dashed border-yellow-500' : ''}`}
                            style={{
                              borderLeft: isSunday ? '4px solid #ef4444' : (isToday ? '6px solid #1e3a8a' : undefined)
                            }}
                            onDragOver={(e) => handleRoomDragOver(e, dateStr, tempRoom.id)}
                            onDragLeave={handleRoomDragLeave}
                            onDrop={(e) => handleRoomDrop(e, dateStr, tempRoom.id)}
                          >
                            <div className="flex flex-col h-full">
                              {tempOccupants.map((userId) => {
                                const user = users.find(u => u.id === userId);
                                if (!user) return null;
                                
                                // éƒ¨å±‹å›ºå®šãƒã‚§ãƒƒã‚¯
                                const periods = getStayPeriods(user.stayDates || []);
                                const currentPeriod = periods.find(p => p.includes(dateStr));
                                const periodKey = currentPeriod ? `${currentPeriod[0]}_${currentPeriod[currentPeriod.length - 1]}` : '';
                                const isFixedInPeriod = periodKey && user.fixedRooms && user.fixedRooms[periodKey];
                                
                                return (
                                  <div 
                                    key={userId}
                                    draggable
                                    onDragStart={(e) => handleUserDragStart(e, userId, dateStr, tempRoom.id)}
                                    onDragEnd={handleUserDragEnd}
                                    onContextMenu={(e) => handleContextMenu(e, userId, dateStr, tempRoom.id)}
                                    onDoubleClick={(e) => {
                                      e.stopPropagation();
                                      handleEditUser(user);
                                    }}
                                    className={`flex-1 p-1 text-xs font-bold text-center cursor-grab active:cursor-grabbing border-b last:border-b-0 ${
                                      isFixedInPeriod 
                                        ? 'bg-yellow-200 text-yellow-800 border-yellow-300' 
                                        : 'bg-purple-300 text-purple-900 border-purple-400'
                                    }`}
                                    title="ãƒ‰ãƒ©ãƒƒã‚°ã§éƒ¨å±‹ç§»å‹• / å³ã‚¯ãƒªãƒƒã‚¯ã§ç§»å‹•å…ˆé¸æŠ"
                                  >
                                    {user.name}
                                  </div>
                                );
                              })}
                            </div>
                          </td>
                        );
                      })}
                      <td className="border-2 border-gray-400 bg-purple-100"></td>
                    </tr>
                  ))}

                  {/* ç©ºåºŠè¿½åŠ ãƒœã‚¿ãƒ³ */}
                  <tr>
                    <td className="p-1 border-r-2 border-gray-400 sticky left-0 z-30 bg-white">
                      <button
                        onClick={handleAddTempRoom}
                        className="w-full text-xs text-purple-600 hover:text-purple-800 font-bold py-1 bg-purple-50 rounded"
                      >
                        ï¼‹ ç©ºåºŠè¿½åŠ 
                      </button>
                    </td>
                    {displayDates.map(dateStr => {
                      const isSunday = parseLocalDate(dateStr).getDay() === 0;
                      return (
                        <td key={dateStr} className="border border-transparent" style={{ borderLeft: isSunday ? '4px solid #ef4444' : undefined }}></td>
                      );
                    })}
                    <td className="border border-transparent"></td>
                  </tr>
                  
                  {/* =========================================
                      5. ç©ºåºŠå®Ÿç¸¾
                     ========================================= */}
                  <tr className="bg-purple-100" style={{height: '40px'}}>
                    <td className="p-2 border-2 border-gray-400 bg-purple-200 font-bold text-sm text-gray-800 sticky left-0 z-30 text-center">
                      ç©ºåºŠå®Ÿç¸¾
                    </td>
                    {displayDates.map(dateStr => {
                      const tempCount = currentMonthTempRooms.reduce((count, room) => {
                        const key = `${dateStr}-${room.id}`;
                        return count + (allocations[key]?.length || 0);
                      }, 0);
                      return (
                        <td key={dateStr} className="p-1 border-2 border-gray-400 bg-purple-100 text-center align-middle">
                          <span className="font-bold text-sm text-gray-700">{tempCount > 0 ? tempCount : '-'}</span>
                        </td>
                      );
                    })}
                    <td className="border-2 border-gray-400 bg-purple-200 text-center"></td>
                  </tr>

                  {/* =========================================
                      6. åˆè¨ˆå®Ÿç¸¾ï¼ˆç·‘ï¼šæœ¬é¤¨ï¼‹ç©ºåºŠï¼‰
                     ========================================= */}
                  <tr className="bg-green-100 h-16">
                    <td className="p-2 border-2 border-gray-400 bg-green-300 font-bold text-xl text-gray-800 sticky left-0 z-30 text-center">
                      åˆè¨ˆå®Ÿç¸¾
                    </td>
                    {displayDates.map(dateStr => {
                      const regularCount = rooms.reduce((count, room) => {
                        const key = `${dateStr}-${room.id}`;
                        return count + (allocations[key]?.length || 0);
                      }, 0);
                      const tempCount = currentMonthTempRooms.reduce((count, tempRoom) => {
                        const key = `${dateStr}-${tempRoom.id}`;
                        return count + (allocations[key]?.length || 0);
                      }, 0);
                      
                      const totalDaily = regularCount + tempCount;
                      const today = toDateStr(new Date());
                      const isToday = dateStr === today;
                      const isSunday = parseLocalDate(dateStr).getDay() === 0;

                      return (
                        <td key={dateStr} className="p-1 border-2 border-gray-400 bg-green-100 text-center align-middle"
                          style={{
                            borderLeftWidth: isToday ? '6px' : undefined,
                            borderLeftColor: isToday ? '#1e3a8a' : undefined,
                            borderLeft: isSunday ? '4px solid #ef4444' : (isToday ? '6px solid #1e3a8a' : undefined)
                          }}
                        >
                          <span className="font-bold text-2xl text-gray-800">{totalDaily}</span>
                        </td>
                      );
                    })}
                    
                    <td className="p-2 border-2 border-gray-400 bg-green-300 text-center min-w-[150px]">
                      {(() => {
                        let totalPeriodCount = 0;
                        displayDates.forEach(dateStr => {
                          totalPeriodCount += rooms.reduce((c, r) => c + (allocations[`${dateStr}-${r.id}`]?.length || 0), 0);
                          totalPeriodCount += currentMonthTempRooms.reduce((c, r) => c + (allocations[`${dateStr}-${r.id}`]?.length || 0), 0);
                        });

                        const maxCapacity = rooms.length * displayDates.length;
                        const occupancyRate = maxCapacity > 0 ? ((totalPeriodCount / maxCapacity) * 100).toFixed(1) : 0;

                        return (
                          <div>
                            <div className="font-bold text-3xl text-gray-900">{totalPeriodCount}</div>
                            <div className="text-sm text-gray-700 font-bold">({occupancyRate}%)</div>
                          </div>
                        );
                      })()}
                    </td>
                  </tr>
                </tfoot>
              </table>
              </div>
            </div>
          </div>
        </div>
        
        {/* ä»˜ç®‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ */}
        {stickies.map(sticky => (
          <StickyNote
            key={sticky.id}
            sticky={sticky}
            onUpdate={handleUpdateSticky}
            onDelete={handleDeleteSticky}
          />
        ))}
        </div>

        {/* --- B. å°åˆ·å°‚ç”¨ãƒ“ãƒ¥ãƒ¼ï¼ˆæ–°è¨­ï¼‰ --- */}
        <div className="print-only">
          {/* 1æšç›®ï¼šæœ¬é¤¨ï¼ˆ201-210å·å®¤ï¼‰ */}
          <div className="print-page" style={{ pageBreakAfter: 'always' }}>
            <h1 className="text-xl font-bold mb-2">{currentMonth.getFullYear()}å¹´{currentMonth.getMonth() + 1}æœˆ éƒ¨å±‹å‰²è¡¨</h1>
            <table className="w-full border-collapse border border-gray-600">
              <thead>
                <tr>
                  <th>éƒ¨å±‹</th>
                  {displayDates.map(dateStr => {
                    const dateObj = parseLocalDate(dateStr);
                    const dayOfWeek = dateObj.getDay();
                    const isSun = dayOfWeek === 0;
                    const isSat = dayOfWeek === 6;
                    const holiday = HOLIDAYS_JP[dateStr];
                    const isRed = isSun || holiday;
                    
                    let bgColor = '#f3f4f6';
                    let textColor = '#374151';
                    if (isRed) { bgColor = '#fef2f2'; textColor = '#dc2626'; }
                    else if (isSat) { bgColor = '#eff6ff'; textColor = '#2563eb'; }

                    return (
                      <th key={dateStr} style={{ backgroundColor: bgColor, color: textColor }}>
                        <div>{dateObj.getDate()}</div>
                        <div style={{fontSize: '8pt'}}>{WEEK_DAYS_JP[dayOfWeek]}</div>
                      </th>
                    );
                  })}
                  <th>å®Ÿç¸¾</th>
                </tr>
              </thead>
              <tbody>
                {rooms.map(room => (
                  <tr key={room.id}>
                    <td style={{textAlign: 'center', fontWeight: 'bold', fontSize: '12pt'}}>
                      {room.name}
                      <div style={{fontSize: '8pt', fontWeight: 'normal'}}>{room.label}</div>
                    </td>
                    {displayDates.map(dateStr => {
                      const allocatedIds = allocations[`${dateStr}-${room.id}`] || [];
                      const sortedIds = [...allocatedIds].sort((a, b) => {
                        const userA = users.find(u => u.id === a);
                        const userB = users.find(u => u.id === b);
                        if (!userA || !userB) return 0;
                        const aIsLeaving = !userA.stayDates.includes(getNextDay(dateStr));
                        const bIsLeaving = !userB.stayDates.includes(getNextDay(dateStr));
                        return (aIsLeaving === bIsLeaving) ? 0 : aIsLeaving ? -1 : 1;
                      });

                      return (
                        <td key={dateStr} style={{verticalAlign: 'top', padding: '2px'}}>
                          {sortedIds.map(userId => {
                            const user = users.find(u => u.id === userId);
                            if (!user) return null;
                            
                            const colorIndex = roomUserColors[`${room.id}-${userId}`] ?? 0;
                            let bgColor = '#e5e7eb';
                            if (colorIndex === 0) bgColor = '#fbcfe8'; // pink
                            else if (colorIndex === 1) bgColor = '#bae6fd'; // sky
                            else if (colorIndex === 2) bgColor = '#e9d5ff'; // purple
                            else if (colorIndex === 3) bgColor = '#fed7aa'; // orange

                            const userSchedule = user.schedule || {};
                            const daySchedule = userSchedule[dateStr] || {};

                            return (
                              <div key={userId} style={{backgroundColor: bgColor, marginBottom: '2px', padding: '2px', borderRadius: '2px'}}>
                                <div style={{fontWeight: 'bold', fontSize: '10pt', lineHeight: '1.1'}}>{user.name}</div>
                                <div style={{display: 'flex', justifyContent: 'center'}}>
                                  {(daySchedule.bath || daySchedule.mustBath) && <span className="print-icon">ğŸ›</span>}
                                  {daySchedule.linen && <span className="print-icon">ğŸ›ï¸</span>}
                                </div>
                              </div>
                            );
                          })}
                        </td>
                      );
                    })}
                    <td style={{textAlign: 'center', fontWeight: 'bold', fontSize: '12pt'}}>
                      {displayDates.reduce((count, dateStr) => count + (allocations[`${dateStr}-${room.id}`] || []).length, 0)}
                    </td>
                  </tr>
                ))}
              </tbody>
              <tfoot>
                <tr style={{backgroundColor: '#fef08a'}}>
                  <td style={{textAlign: 'center', fontWeight: 'bold'}}>å®Ÿç¸¾æ•°</td>
                  {displayDates.map(dateStr => (
                    <td key={dateStr} style={{textAlign: 'center', fontWeight: 'bold'}}>
                      {rooms.reduce((count, room) => count + (allocations[`${dateStr}-${room.id}`] || []).length, 0)}
                    </td>
                  ))}
                  <td style={{textAlign: 'center', fontWeight: 'bold'}}>
                    {(() => {
                      const totalCount = displayDates.reduce((total, dateStr) => {
                        return total + rooms.reduce((count, room) => {
                          const key = `${dateStr}-${room.id}`;
                          return count + (allocations[key]?.length || 0);
                        }, 0);
                      }, 0);
                      const maxCapacity = rooms.length * displayDates.length;
                      const occupancyRate = maxCapacity > 0 ? ((totalCount / maxCapacity) * 100).toFixed(1) : 0;
                      return <div><div>{totalCount}</div><div style={{fontSize: '8pt'}}>({occupancyRate}%)</div></div>;
                    })()}
                  </td>
                </tr>
              {/* ä¸€æ™‚ä¿ç®¡ï¼ˆ1æšç›®ã«å«ã‚ã‚‹ï¼‰ */}
              {[
                { id: TEMP_ROOM_1_ID, name: 'ä¸€æ™‚ä¿ç®¡â‘ ' },
                { id: TEMP_ROOM_2_ID, name: 'ä¸€æ™‚ä¿ç®¡â‘¡' }
              ].map(room => (
                <tr key={room.id} style={{backgroundColor: '#fff7ed'}}>
                  <td style={{textAlign: 'center', fontWeight: 'bold', fontSize: '12pt'}}>{room.name}</td>
                  {displayDates.map(dateStr => {
                    const allocatedIds = allocations[`${dateStr}-${room.id}`] || [];
                    return (
                      <td key={dateStr} style={{verticalAlign: 'top', padding: '2px'}}>
                        {allocatedIds.map(userId => {
                          const user = users.find(u => u.id === userId);
                          if (!user) return null;
                          return (
                            <div key={userId} style={{backgroundColor: '#ffedd5', marginBottom: '2px', padding: '2px', borderRadius: '2px', border: '1px solid #fdba74'}}>
                              <div style={{fontWeight: 'bold', fontSize: '10pt'}}>{user.name}</div>
                            </div>
                          );
                        })}
                      </td>
                    );
                  })}
                  <td style={{textAlign: 'center', fontWeight: 'bold'}}>
                    {displayDates.reduce((count, dateStr) => count + (allocations[`${dateStr}-${room.id}`] || []).length, 0)}
                  </td>
                </tr>
              ))}
                {/* ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡ï¼ˆ1æšç›®ã«å«ã‚ã‚‹ï¼‰ */}
                {customRows.map(customRow => (
                  <tr key={customRow.id} style={{backgroundColor: '#fff7ed'}}>
                    <td style={{textAlign: 'center', fontSize: '10pt'}}>{customRow.name}</td>
                    {displayDates.map(dateStr => {
                      const memo1 = customRowMemos[`${dateStr}-${customRow.id}-1`] || '';
                      const memo2 = customRowMemos[`${dateStr}-${customRow.id}-2`] || '';
                      return (
                        <td key={dateStr} style={{verticalAlign: 'top', padding: '2px', fontSize: '8pt'}}>
                          {memo1 && <div>{memo1}</div>}
                          {memo2 && <div>{memo2}</div>}
                        </td>
                      );
                    })}
                    <td></td>
                  </tr>
                ))}
              </tfoot>
            </table>
          </div>

          {/* 2æšç›®ï¼šç©ºåºŠï¼ˆæ”¹ãƒšãƒ¼ã‚¸å¾Œï¼‰ */}
          {currentMonthTempRooms.length > 0 && (
            <div className="print-page mt-4">
              <h1 className="text-xl font-bold mb-2">ç©ºåºŠåˆ©ç”¨ä¸€è¦§</h1>
              <table className="w-full border-collapse border border-gray-600">
                <thead>
                  <tr>
                    <th>ç©ºåºŠ</th>
                    {displayDates.map(dateStr => {
                      const dateObj = parseLocalDate(dateStr);
                      const dayOfWeek = dateObj.getDay();
                      return (
                        <th key={dateStr}>
                          <div>{dateObj.getDate()}</div>
                          <div style={{fontSize: '8pt'}}>{WEEK_DAYS_JP[dayOfWeek]}</div>
                        </th>
                      );
                    })}
                    <th>å®Ÿç¸¾</th>
                  </tr>
                </thead>
                <tbody>
                  {currentMonthTempRooms.map(tempRoom => (
                    <tr key={tempRoom.id}>
                      <td style={{textAlign: 'center', fontWeight: 'bold', fontSize: '12pt'}}>{tempRoom.name}</td>
                      {displayDates.map(dateStr => {
                        const allocatedIds = allocations[`${dateStr}-${tempRoom.id}`] || [];
                        return (
                          <td key={dateStr} style={{verticalAlign: 'top', padding: '2px'}}>
                            {allocatedIds.map(userId => {
                              const user = users.find(u => u.id === userId);
                              if (!user) return null;
                              return (
                                <div key={userId} style={{backgroundColor: '#fef9c3', marginBottom: '2px', padding: '2px', borderRadius: '2px'}}>
                                  <div style={{fontWeight: 'bold', fontSize: '10pt'}}>{user.name}</div>
                                </div>
                              );
                            })}
                          </td>
                        );
                      })}
                      <td style={{textAlign: 'center', fontWeight: 'bold', fontSize: '12pt'}}>
                        {displayDates.reduce((count, dateStr) => count + (allocations[`${dateStr}-${tempRoom.id}`] || []).length, 0)}
                      </td>
                    </tr>
                  ))}
                </tbody>
                <tfoot>
                  <tr style={{backgroundColor: '#e9d5ff'}}>
                    <td style={{textAlign: 'center', fontWeight: 'bold'}}>ç©ºåºŠå®Ÿç¸¾</td>
                    {displayDates.map(dateStr => (
                      <td key={dateStr} style={{textAlign: 'center', fontWeight: 'bold'}}>
                        {currentMonthTempRooms.reduce((count, tempRoom) => count + (allocations[`${dateStr}-${tempRoom.id}`] || []).length, 0)}
                      </td>
                    ))}
                    <td></td>
                  </tr>
                  {/* åˆè¨ˆå®Ÿç¸¾ï¼ˆ2æšç›®ã«å«ã‚ã‚‹ï¼‰ */}
                  <tr style={{backgroundColor: '#bbf7d0'}}>
                    <td style={{textAlign: 'center', fontWeight: 'bold'}}>åˆè¨ˆå®Ÿç¸¾</td>
                    {displayDates.map(dateStr => {
                      const regularCount = rooms.reduce((count, room) => count + (allocations[`${dateStr}-${room.id}`] || []).length, 0);
                      const tempCount = currentMonthTempRooms.reduce((count, tempRoom) => count + (allocations[`${dateStr}-${tempRoom.id}`] || []).length, 0);
                      return (
                        <td key={dateStr} style={{textAlign: 'center', fontWeight: 'bold'}}>
                          {regularCount + tempCount}
                        </td>
                      );
                    })}
                    <td style={{textAlign: 'center', fontWeight: 'bold'}}>
                      {(() => {
                        let totalPeriodCount = 0;
                        displayDates.forEach(dateStr => {
                          totalPeriodCount += rooms.reduce((c, r) => c + (allocations[`${dateStr}-${r.id}`]?.length || 0), 0);
                          totalPeriodCount += currentMonthTempRooms.reduce((c, r) => c + (allocations[`${dateStr}-${r.id}`]?.length || 0), 0);
                        });
                        const maxCapacity = rooms.length * displayDates.length;
                        const occupancyRate = maxCapacity > 0 ? ((totalPeriodCount / maxCapacity) * 100).toFixed(1) : 0;
                        return <div><div>{totalPeriodCount}</div><div style={{fontSize: '8pt'}}>({occupancyRate}%)</div></div>;
                      })()}
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          )}
        </div>
        
        {/* å³ã‚¯ãƒªãƒƒã‚¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ */}
        {contextMenu && (
          <>
            <div 
              className="fixed inset-0 z-40 bg-black bg-opacity-30" 
              onClick={closeContextMenu}
            />
            <div 
              className="fixed z-50 bg-white rounded-xl shadow-2xl border-4 border-blue-400 py-4 w-80 left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2"
            >
              <div className="px-4 py-2 text-lg font-bold text-gray-700 border-b-2 mb-2 text-center bg-blue-50">
                ğŸšš {users.find(u => u.id === contextMenu.userId)?.name} ã‚’ç§»å‹•
              </div>
              
              {/* éƒ¨å±‹å›ºå®šãƒœã‚¿ãƒ³ */}
              {!contextMenu.fromRoomId?.startsWith('TEMP') && (
                <div className="px-2 border-b-2 mb-2 pb-2">
                  {(() => {
                    const user = users.find(u => u.id === contextMenu.userId);
                    if (!user) return null;
                    
                    // contextMenu.dateãŒå±ã™ã‚‹æœŸé–“ã‚’ç‰¹å®š
                    const periods = getStayPeriods(user.stayDates || []);
                    const currentPeriod = periods.find(p => p.includes(contextMenu.date));
                    if (!currentPeriod) return null;
                    
                    const periodKey = `${currentPeriod[0]}_${currentPeriod[currentPeriod.length - 1]}`;
                    const fixedRooms = user.fixedRooms || {};
                    const isFixed = fixedRooms[periodKey] === contextMenu.fromRoomId;
                    const periodLabel = currentPeriod.length > 1 
                      ? `${currentPeriod[0]} ã€œ ${currentPeriod[currentPeriod.length - 1]}`
                      : currentPeriod[0];
                    
                    return isFixed ? (
                      <button
                        onClick={() => {
                          saveHistory();
                          const newUsers = users.map(u => {
                            if (u.id === contextMenu.userId) {
                              const newFixedRooms = { ...u.fixedRooms };
                              delete newFixedRooms[periodKey];
                              return { ...u, fixedRooms: newFixedRooms };
                            }
                            return u;
                          });
                          setUsers(newUsers); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
                          if (isFirebaseEnabled && database) {
                            database.ref('data/' + STORAGE_KEY_USERS).set(newUsers);
                          }
                          closeContextMenu();
                          alert(`${user.name}ã®éƒ¨å±‹å›ºå®šã‚’è§£é™¤ã—ã¾ã—ãŸ\nï¼ˆ${periodLabel}ï¼‰`);
                        }}
                        className="w-full text-left px-4 py-3 text-base rounded-lg bg-yellow-200 text-yellow-800 font-bold hover:bg-yellow-300 flex flex-col gap-1"
                      >
                        <div className="flex items-center gap-2">
                          ğŸ”“ ã“ã®æœŸé–“ã®éƒ¨å±‹å›ºå®šã‚’è§£é™¤
                        </div>
                        <div className="text-xs text-yellow-600">æœŸé–“: {periodLabel} / {contextMenu.fromRoomId}å·å®¤</div>
                      </button>
                    ) : (
                      <button
                        onClick={() => {
                          saveHistory();
                          const newUsers = users.map(u => {
                            if (u.id === contextMenu.userId) {
                              const newFixedRooms = { ...(u.fixedRooms || {}), [periodKey]: contextMenu.fromRoomId };
                              return { ...u, fixedRooms: newFixedRooms };
                            }
                            return u;
                          });
                          setUsers(newUsers); // ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°
                          if (isFirebaseEnabled && database) {
                            database.ref('data/' + STORAGE_KEY_USERS).set(newUsers);
                          }
                          closeContextMenu();
                          alert(`${user.name}ã‚’${contextMenu.fromRoomId}å·å®¤ã«å›ºå®šã—ã¾ã—ãŸ\nï¼ˆ${periodLabel}ï¼‰`);
                        }}
                        className="w-full text-left px-4 py-3 text-base rounded-lg bg-yellow-100 text-yellow-700 font-bold hover:bg-yellow-200 flex flex-col gap-1"
                      >
                        <div className="flex items-center gap-2">
                          ğŸ”’ ã“ã®æœŸé–“ã‚’{contextMenu.fromRoomId}å·å®¤ã«å›ºå®š
                        </div>
                        <div className="text-xs text-yellow-600">æœŸé–“: {periodLabel}</div>
                      </button>
                    );
                  })()}
                </div>
              )}
              
              {/* ä¸€æ™‚ä¿ç®¡ã‚’ä¸Šéƒ¨ã«é…ç½® */}
              <div className="px-2 border-b-2 mb-2 pb-2 flex gap-2">
                <button
                  onClick={() => handleMoveToRoom(TEMP_ROOM_1_ID)}
                  disabled={contextMenu.fromRoomId === TEMP_ROOM_1_ID}
                  className={`flex-1 text-center px-2 py-2 text-sm rounded-lg hover:bg-orange-200
                    ${contextMenu.fromRoomId === TEMP_ROOM_1_ID ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-orange-100 text-orange-700 font-bold'}`}
                >
                  ğŸ“¦ ä¸€æ™‚ä¿ç®¡â‘ 
                  {contextMenu.fromRoomId === TEMP_ROOM_1_ID && <span className="text-xs text-blue-500 block">ï¼ˆç¾åœ¨ï¼‰</span>}
                </button>
                <button
                  onClick={() => handleMoveToRoom(TEMP_ROOM_2_ID)}
                  disabled={contextMenu.fromRoomId === TEMP_ROOM_2_ID}
                  className={`flex-1 text-center px-2 py-2 text-sm rounded-lg hover:bg-orange-200
                    ${contextMenu.fromRoomId === TEMP_ROOM_2_ID ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-orange-100 text-orange-700 font-bold'}`}
                >
                  ğŸ“¦ ä¸€æ™‚ä¿ç®¡â‘¡
                  {contextMenu.fromRoomId === TEMP_ROOM_2_ID && <span className="text-xs text-blue-500 block">ï¼ˆç¾åœ¨ï¼‰</span>}
                </button>
              </div>
              <div className="max-h-72 overflow-y-auto px-2">
                {rooms.map(room => {
                  const isCurrentRoom = contextMenu.fromRoomId === room.id;
                  const user = users.find(u => u.id === contextMenu.userId);
                  // ã“ã®æœŸé–“ã§å›ºå®šã•ã‚Œã¦ã„ã‚‹éƒ¨å±‹ã‹ãƒã‚§ãƒƒã‚¯
                  const periods = getStayPeriods(user?.stayDates || []);
                  const currentPeriod = periods.find(p => p.includes(contextMenu.date));
                  const periodKey = currentPeriod ? `${currentPeriod[0]}_${currentPeriod[currentPeriod.length - 1]}` : '';
                  const isFixedRoom = periodKey && user?.fixedRooms && user.fixedRooms[periodKey] === room.id;
                  return (
                    <button
                      key={room.id}
                      onClick={() => handleMoveToRoom(room.id)}
                      disabled={isCurrentRoom}
                      className={`w-full text-left px-4 py-3 text-base rounded-lg mb-1 hover:bg-blue-100 flex items-center gap-2
                        ${isCurrentRoom ? 'bg-blue-200 text-blue-600 cursor-not-allowed' : isFixedRoom ? 'bg-yellow-100 text-yellow-700' : 'text-gray-700 bg-gray-50'}`}
                    >
                      <span className="font-bold text-lg">{room.id}</span>
                      <span className="text-sm text-gray-500">å·å®¤</span>
                      {isFixedRoom && <span className="text-sm text-yellow-600 ml-1">ğŸ”’</span>}
                      {isCurrentRoom && <span className="text-sm text-blue-600 ml-auto font-bold">ï¼ˆç¾åœ¨ï¼‰</span>}
                    </button>
                  );
                })}
                
                {/* ç©ºåºŠåˆ©ç”¨éƒ¨å±‹ */}
                {currentMonthTempRooms.length > 0 && (
                  <div className="border-t border-gray-200 mt-2 pt-2">
                    <div className="text-xs text-purple-600 font-bold px-2 mb-1">ç©ºåºŠåˆ©ç”¨</div>
                    {currentMonthTempRooms.map(tempRoom => {
                      const isCurrentRoom = contextMenu.fromRoomId === tempRoom.id;
                      return (
                        <button
                          key={tempRoom.id}
                          onClick={() => handleMoveToRoom(tempRoom.id)}
                          disabled={isCurrentRoom}
                          className={`w-full text-left px-4 py-3 text-base rounded-lg mb-1 hover:bg-purple-100 flex items-center gap-2
                            ${isCurrentRoom ? 'bg-purple-200 text-purple-600 cursor-not-allowed' : 'text-gray-700 bg-purple-50'}`}
                        >
                          <span className="font-bold text-lg">{tempRoom.name}</span>
                          <span className="text-sm text-purple-500">ï¼ˆç©ºåºŠï¼‰</span>
                          {isCurrentRoom && <span className="text-sm text-purple-600 ml-auto font-bold">ï¼ˆç¾åœ¨ï¼‰</span>}
                        </button>
                      );
                    })}
                  </div>
                )}
              </div>
              <div className="border-t-2 mt-2 pt-2 px-2">
                <button
                  onClick={closeContextMenu}
                  className="w-full text-center px-4 py-3 text-base text-gray-500 hover:bg-gray-100 rounded-lg font-bold"
                >
                  âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
              </div>
            </div>
          </>
        )}
        </>
      );
    }
    // ============================================
    // ã‚¢ãƒ—ãƒªã®ãƒ«ãƒ¼ãƒˆ
    // #endregion
    // ============================================
    // #region 1ï¸âƒ£2ï¸âƒ£ ãƒ«ãƒ¼ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ App
    function App() {
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [isChecking, setIsChecking] = useState(true);
      
      // Firebaseæ¥ç¶šçŠ¶æ…‹ç®¡ç†
      const [isFirebaseReady, setIsFirebaseReady] = useState(false);
      const [firebaseError, setFirebaseError] = useState(null);

      // FirebaseåˆæœŸåŒ–ã¨èªè¨¼ç›£è¦–
      useEffect(() => {
        let unsubscribe = null;

        const initFirebase = async () => {
          try {
            // Firebaseã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ï¼ˆäºŒé‡åˆæœŸåŒ–é˜²æ­¢ï¼‰
            if (!firebase.apps.length) {
              firebase.initializeApp(FIREBASE_CONFIG);
            }

            // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
            unsubscribe = firebase.auth().onAuthStateChanged(async (user) => {
              if (user) {
                setIsAuthenticated(true);
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã€Firestoreã«æ¥ç¶š
                try {
                  const fs = firebase.firestore();
                  const docRef = fs.collection("ss-room-auto").doc("shared");
                  
                  // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å­˜åœ¨ç¢ºèªã‚’å…¼ã­ã¦åˆæœŸåŒ–ï¼ˆæ¨©é™ãŒã‚ã‚Œã°æˆåŠŸã™ã‚‹ï¼‰
                  // â€»ãƒ«ãƒ¼ãƒ«ã§ auth != null ãŒå¿…è¦ãªã®ã§ã€ã“ã“ã§è¡Œã†ã®ãŒæ­£è§£
                  await docRef.set({ __init: true }, { merge: true });

                  // ã‚¢ãƒ€ãƒ—ã‚¿ã®åˆæœŸåŒ–ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ã‚»ãƒƒãƒˆï¼‰
                  database = makeFirestoreRtdbAdapter(docRef);
                  isFirebaseEnabled = true;
                  
                  console.log("Firestoreæ¥ç¶šæˆåŠŸï¼ˆRTDBäº’æ›ã‚¢ãƒ€ãƒ—ã‚¿ï¼‰");
                  setIsFirebaseReady(true);
                } catch (err) {
                  console.error("Firestoreæ¥ç¶šã‚¨ãƒ©ãƒ¼:", err);
                  setFirebaseError("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
                }
              } else {
                // æœªãƒ­ã‚°ã‚¤ãƒ³
                setIsAuthenticated(false);
                setIsFirebaseReady(false);
              }
              setIsChecking(false);
            });
          } catch (e) {
            console.error("FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
            setFirebaseError("FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + e.message);
            setIsChecking(false);
          }
        };

        initFirebase();

        return () => {
          if (unsubscribe) unsubscribe();
        };
      }, []);

      const handleLogout = () => {
        firebase.auth().signOut().then(() => {
          setIsAuthenticated(false);
        });
      };

      const handleLocalMode = () => {
        setIsAuthenticated(true);
        setIsFirebaseReady(true);
      };

      if (isChecking) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-50">
            <div className="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        );
      }

      if (!isAuthenticated) {
        return <LoginScreen onLocalMode={handleLocalMode} />;
      }

      // ã‚¢ãƒ—ãƒªèªè¨¼å¾Œã€Firebaseæº–å‚™å¾…ã¡
      if (firebaseError) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-50">
            <div className="bg-white p-6 rounded shadow-lg border-l-4 border-red-500 max-w-md">
              <h3 className="text-red-600 font-bold mb-2">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
              <p className="text-gray-600 text-sm">{firebaseError}</p>
              <button 
                onClick={() => window.location.reload()}
                className="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm font-bold"
              >
                å†èª­ã¿è¾¼ã¿
              </button>
            </div>
          </div>
        );
      }

      if (!isFirebaseReady) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-50">
            <div className="flex flex-col items-center gap-3">
              <div className="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
              <div className="text-blue-600 font-bold">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šä¸­...</div>
              <div className="text-xs text-gray-400">èªè¨¼æƒ…å ±ã‚’ç¢ºèªã—ã¦ã„ã¾ã™</div>
            </div>
          </div>
        );
      }

      return <ShortStayAllocator onLogout={handleLogout} />;
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
    // #endregion
</html>